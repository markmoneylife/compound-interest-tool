<!-- âœ… å·¥å…·é å°ˆç”¨æ¨£å¼ï¼ˆWordPress å…§å®¹ç”¨ï¼‰ -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: radial-gradient(circle at top, #0B3A2E 0, #020617 55%, #020617 100%);
  }

  /* æ‰‹æ©Ÿé¸å–® */
  .nav-toggle {
    display: none;
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 9999;
    background: #FFD54F;
    border: none;
    padding: .6rem 1rem;
    border-radius: .5rem;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 8px 16px rgba(0,0,0,0.35);
  }
  .nav-bar-wrapper {
    background: linear-gradient(90deg, #021B1A 0%, #0B3A2E 40%, #1D4A35 100%);
    padding: 0.35rem 0;
    border-bottom: 1px solid rgba(148, 163, 184, 0.3);
  }
  .nav-bar {
    max-width: 1120px;
    margin: 0 auto;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.75rem;
  }
  .nav-bar a {
    background: rgba(15, 23, 42, 0.9);
    color: #E5E7EB;
    font-weight: 600;
    text-decoration: none;
    padding: .45rem 1rem;
    border-radius: 999px;
    font-size: 0.82rem;
    border: 1px solid rgba(148, 163, 184, 0.6);
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    white-space: nowrap;
    transition: all .18s ease-out;
  }
  .nav-bar a span.badge {
    font-size: 0.7rem;
    background: rgba(34, 197, 94, 0.15);
    padding: 0.1rem 0.45rem;
    border-radius: 999px;
    border: 1px solid rgba(52, 211, 153, 0.4);
    color: #A5F3FC;
  }
  .nav-bar a:hover {
    background: #0F172A;
    transform: translateY(-1px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.45);
    border-color: rgba(190, 242, 100, 0.8);
  }
  @media (max-width: 768px) {
    .nav-toggle { display: block; }
    .nav-bar-wrapper { padding-top: 3.2rem; }
    .nav-bar { display: none; flex-direction: column; align-items: center; }
    .nav-bar.active { display: flex; }
    .nav-bar a { width: 92%; text-align: center; margin-bottom: .3rem; justify-content: center; }
  }

  /* æ”¶ç›Šçµ„æˆå¡ç‰‡å„ªåŒ– */
  .card-common {
    background: radial-gradient(circle at top left, #0B3A2E 0, #020617 55%, #020617 100%);
    border: 1px solid rgba(148, 163, 184, 0.35);
    border-radius: 1rem;
    box-shadow: 0 18px 35px rgba(0, 0, 0, 0.65);
    padding: 1.35rem;
    color: #E5E7EB;
    transition: transform .18s ease-out, box-shadow .18s ease-out, border-color .18s;
    position: relative;
    overflow: hidden;
  }
  .card-common::before {
    content: "";
    position: absolute;
    inset: -40%;
    background:
      radial-gradient(circle at 0 0, rgba(74, 222, 128, 0.18), transparent 55%),
      radial-gradient(circle at 100% 0, rgba(56, 189, 248, 0.20), transparent 55%);
    opacity: 0.75;
    pointer-events: none;
  }
  .card-common:hover {
    transform: translateY(-3px) translateX(1px);
    box-shadow: 0 22px 45px rgba(0, 0, 0, 0.8);
    border-color: rgba(190, 242, 100, 0.75);
  }
  .card-common h3 {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    position: relative;
    z-index: 1;
  }
  .card-common .etf-name {
    font-size: 0.82rem;
    color: #CBD5F5;
    margin-bottom: 0.9rem;
    position: relative;
    z-index: 1;
  }
  .card-common .highlight {
    background: rgba(15, 23, 42, 0.88);
    padding: 0.6rem 0.55rem;
    border-radius: 0.9rem;
    box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.45);
    position: relative;
    z-index: 1;
  }

  /* ä¸»è¦å…§å®¹å¡ç‰‡å¤–æ¡†ï¼ˆæ•´å€‹å·¥å…·å€ï¼‰ */
  .mark-shell {
    max-width: 1120px;
    margin: -3.5rem auto 0;
    padding: 1.25rem;
  }
  @media (min-width: 768px) {
    .mark-shell {
      padding: 1.75rem 2rem 2.5rem;
    }
  }
</style>

<!-- ğŸ”¸ Hero å€å¡Š -->
<header class="relative overflow-hidden border-b border-slate-800/70">
  <div class="absolute inset-0 pointer-events-none opacity-60"
       style="background:
         radial-gradient(circle at 10% 0%, rgba(74,222,128,0.18), transparent 55%),
         radial-gradient(circle at 100% 0%, rgba(56,189,248,0.20), transparent 60%);">
  </div>
  <div class="max-w-5xl mx-auto px-4 pt-8 pb-16 relative z-10">
    <p class="text-xs tracking-[0.25em] uppercase text-emerald-200/80 mb-2">
      Mark ETF Tools Â· å¹¸ç¦ç†è²¡å®¶
    </p>
    <h1 class="text-3xl md:text-4xl font-extrabold mb-4 leading-tight">
      ETF é…æ¯åœ–å¡ç€‘å¸ƒç‰†<br class="hidden sm:block" />
      <span class="text-emerald-300 text-2xl md:text-3xl">
        ä¸€çœ¼çœ‹æ‡‚æ®–åˆ©ç‡ Ã— å…¥å¸³æ™‚é–“
      </span>
    </h1>
    <p class="text-sm md:text-base text-slate-200/90 max-w-2xl mb-6 leading-relaxed">
      é€™ä¸€é ï¼ŒæŠŠã€Œé…æ¯å…¬å‘Šã€æ•´ç†æˆä½ çœ‹å¾—æ‡‚çš„è¦–è¦ºç‰†ï¼š
      å‰äº”åå–®æœŸæ®–åˆ©ç‡ã€æ¯æª” ETF çš„æœ¬æœŸé…æ¯ã€èˆ‡ä¸Šæ¬¡é…æ¯çš„å¢æ¸›ï¼Œ
      é‚„æœ‰å¯¦éš›å…¥å¸³æ™‚é–“è¡¨ï¼Œè®“å–œæ­¡é…æ¯ç¾é‡‘æµçš„äººï¼Œæœ‰ä¸€å€‹å¯ä»¥åè¦†å›ä¾†çœ‹çš„ã€Œé…æ¯é¦–é ã€ã€‚
    </p>
    <div class="flex flex-wrap gap-3">
      <a href="#wall"
         class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold bg-emerald-500 text-slate-900 shadow-lg shadow-emerald-500/30 hover:bg-emerald-400 transition">
        ğŸš€ ç›´æ¥çœ‹æœ¬æœˆé…æ¯ç‰†
      </a>
      <a href="#timeline"
         class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold border border-slate-500/70 text-slate-100 hover:border-emerald-300 hover:text-emerald-200 transition">
        ğŸ“… çœ‹å…¥å¸³æ™‚é–“è¡¨ï¼Œç®—ä»€éº¼æ™‚å€™æœ‰éŒ¢é€²ä¾†
      </a>
      <a href="https://markmoneylife.github.io/compound-interest-tool/"
         target="_blank" rel="noopener"
         class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold border border-sky-400/70 text-sky-100 hover:bg-sky-500/10 transition">
        ğŸ§° å›è¤‡åˆ©å·¥å…·ç®±ï¼Œæ’æ•´é«”è³‡ç”¢é…ç½®
      </a>
    </div>
    <p class="mt-4 text-[0.7rem] text-slate-400">
      å°æé†’ï¼šé…æ¯æ˜¯ç¾é‡‘æµï¼Œä¸ç­‰æ–¼ä½ çœŸçš„è³ºåˆ°é€™éº¼å¤šå ±é…¬ã€‚è¨˜å¾—æ­é…ç¸½å ±é…¬ä¸€èµ·çœ‹ã€‚
    </p>
  </div>
</header>

<!-- ğŸ”¸ ä¸»å…§å®¹æ¡† -->
<main class="mark-shell">
  <div class="bg-slate-900/80 backdrop-blur-md border border-slate-700/70 rounded-3xl shadow-[0_25px_60px_rgba(0,0,0,0.85)] px-4 sm:px-6 md:px-8 py-8 md:py-10 space-y-16">

    <!-- ETFç€‘å¸ƒç‰† -->
    <section id="wall">
      <div class="text-center mb-6">
        <h2 class="text-2xl md:text-3xl font-bold mb-2 text-emerald-200">
          ETF é…æ¯åœ–å¡ç€‘å¸ƒç‰†
        </h2>
        <p class="text-xs text-slate-400 mb-2">
          å»ºè­°æŠŠé€™ä¸€é åŠ å…¥æ›¸ç±¤ï¼Œç•¶æˆä½ çš„ã€ŒETF é…æ¯é¦–é ã€ã€‚
        </p>
        <p class="text-center text-xs text-slate-400 mb-3">
          è³‡æ–™ä¾†æºï¼š
          <a href="https://www.twse.com.tw/zh/ETFortune/announcementList" class="underline text-sky-300" target="_blank" rel="noopener">
            è‡ºç£è­‰åˆ¸äº¤æ˜“æ‰€ ETF é…æ¯å…¬å‘Š
          </a>
        </p>
        <div id="last-update" class="text-center text-[0.7rem] text-slate-500 mb-1"></div>
      </div>

      <!-- æ¨¡å¼åˆ‡æ› -->
      <div id="mode-switch" class="text-center my-8">
        <button data-mode="forecast"
                class="px-4 py-2 mx-2 rounded-full bg-[#1D4A35] text-[#FFD54F] text-sm font-semibold shadow-md shadow-emerald-500/30">
          é ä¼°é…æ¯æ¨¡å¼
        </button>
        <button data-mode="distribution"
                class="px-4 py-2 mx-2 rounded-full bg-slate-800 text-slate-200 text-sm font-semibold border border-slate-500">
          æ”¶ç›Šçµ„æˆæ¨¡å¼
        </button>
      </div>

      <!-- ğŸ”¹ ä½ çš„ETFé€™æœŸé…å¤šå°‘ï¼Ÿè©¦ç®—å€ -->
      <section id="my-dividend" class="max-w-3xl mx-auto mb-10 bg-slate-900/95 border border-emerald-500/40 rounded-2xl shadow-xl shadow-emerald-900/50 p-5">
        <h3 class="text-xl font-bold text-emerald-200 mb-2">ä½ çš„ ETF é€™æœŸé…å¤šå°‘ï¼Ÿ</h3>
        <p class="text-sm text-slate-300 mb-4">
          è¼¸å…¥ ETF ä»£è™Ÿï¼‹æŒæœ‰å¼µæ•¸ï¼Œå¹«ä½ ä¼°ç®—æœ¬æœŸå¤§æ¦‚å¯ä»¥é ˜å¤šå°‘é…æ¯ï¼ˆä»¥ç•¶æœˆè³‡æ–™ç‚ºä¸»ï¼‰ã€‚
          é©åˆæ‹¿ä¾†æ­é…è‡ªå·±çš„ã€Œæ¯æœˆç¾é‡‘æµè¨ˆç•«ã€ã€‚
        </p>
        <div class="flex flex-col md:flex-row gap-4 items-center">
          <div class="w-full md:w-1/3">
            <label class="block text-[0.7rem] text-slate-400 mb-1">ETF ä»£è™Ÿï¼ˆä¾‹å¦‚ï¼š00919ã€00713ï¼‰</label>
            <input id="my-dividend-code" type="text" placeholder="è«‹è¼¸å…¥ETFä»£è™Ÿ"
                   class="w-full border border-slate-600 bg-slate-900 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400" />
          </div>
          <div class="w-full md:w-1/3">
            <label class="block text-[0.7rem] text-slate-400 mb-1">æŒæœ‰å¼µæ•¸</label>
            <input id="my-dividend-lots" type="number" min="1" step="1" value="1"
                   class="w-full border border-slate-600 bg-slate-900 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400" />
          </div>
          <div class="w-full md:w-1/3 flex items-end">
            <button id="my-dividend-btn"
                    class="w-full bg-emerald-500 text-slate-900 font-semibold rounded-lg py-2 text-sm hover:bg-emerald-400 transition shadow-lg shadow-emerald-700/40">
              ğŸ§® å¹«æˆ‘ç®—é€™æ¬¡å¯ä»¥é ˜å¤šå°‘
            </button>
          </div>
        </div>
        <div id="my-dividend-result" class="mt-4 text-sm text-slate-100 leading-relaxed"></div>
      </section>

      <!-- é ä¼°é…æ¯æ¨¡å¼ -->
      <div id="mode-forecast">
        <!-- å‰äº”åæ’è¡Œå¡ç‰‡ -->
        <div class="max-w-4xl mx-auto mb-8">
          <h3 class="text-xl font-semibold mb-4 text-center text-emerald-200">ğŸ¥‡ å–®æœŸæ®–åˆ©ç‡å‰äº”å</h3>
          <p class="text-xs text-center text-slate-400 mb-3">
            åªçœ‹ã€Œé€™ä¸€æœŸã€é…å¤šå°‘ï¼Œä¸ä»£è¡¨é•·æœŸä¸€å®šæ¯”è¼ƒå¥½ã€‚é€™è£¡ç•¶æˆè§€å¯Ÿåå–®ï¼Œä¸æ˜¯å ±åç‰Œã€‚
          </p>
          <div id="top5-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4"></div>
        </div>

        <div id="loading" class="text-center text-sm text-slate-400 mb-4">è¼‰å…¥ä¸­...</div>
        <div id="card-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </div>

      <!-- æ”¶ç›Šçµ„æˆæ¨¡å¼ -->
      <div id="mode-distribution" class="max-w-6xl mx-auto" style="display:none;">
        <h3 class="text-2xl font-bold text-emerald-200 mb-3">ğŸ“Š æœ¬æœˆé…æ¯æ”¶ç›Šçµ„æˆ</h3>
        <p class="text-sm text-slate-300 mb-6">
          ä¸€æ¬¡çœ‹æ‡‚è‚¡åˆ©ã€åˆ©æ¯ã€å¹³æº–é‡‘ã€è³‡æœ¬åˆ©å¾—ã€å…¶ä»–æ‰€å¾—ï¼Œä»¥åŠå¥ä¿æ‡‰èª²å¼µæ•¸ã€‚
          é…æ¯å¾ˆé¦™æ²’éŒ¯ï¼Œä½†ä¹Ÿè¦çŸ¥é“è£¡é¢æ˜¯ä»€éº¼æ±è¥¿åœ¨æ’ã€‚
        </p>

        <!-- äºŒä»£å¥ä¿è£œå……ä¿è²»ç°¡æ˜“ç‰ˆ -->
        <section class="bg-slate-900 border border-slate-600/70 p-4 rounded-xl shadow-inner mb-6">
          <h4 class="text-lg font-bold mb-2 text-amber-300">äºŒä»£å¥ä¿è£œå……ä¿è²»ç°¡ä»‹ï¼ˆç°¡æ˜“ç‰ˆï¼‰</h4>
          <ul class="list-disc pl-5 space-y-1 text-xs md:text-sm text-slate-200">
            <li>è²»ç‡ç›®å‰ç‚º <span class="font-semibold text-amber-300">2.11ï¼…</span>ã€‚</li>
            <li>é‡å°ã€Œå–®æ¬¡çµ¦ä»˜ã€æˆ–ã€Œå·®é¡ã€åŠ å¾µï¼Œä¾‹å¦‚ï¼šå¹´çµ‚çé‡‘ã€ä¸€æ¬¡æ€§è‚¡åˆ©ã€åˆ©æ¯ç­‰ã€‚</li>
            <li>å–®æ¬¡çµ¦ä»˜é‡‘é¡ â‰¥ 20,000 å…ƒæ™‚ï¼Œæ‰æœƒè§¸ç™¼è£œå……ä¿éšªè²»ã€‚</li>
            <li>è‹¥ç¬¦åˆå¼±å‹¢æˆ–ä½æ”¶å…¥æ—ç¾¤è³‡æ ¼ï¼Œå¯å‘å¥ä¿å±€ç”³è«‹å…æ‰£ã€‚</li>
          </ul>
        </section>

        <!-- æ”¶ç›Šçµ„æˆå¡ç‰‡å®¹å™¨ -->
        <div id="composition-container" class="grid gap-6 auto-cols-fr md:grid-cols-2 lg:grid-cols-3"></div>
      </div>
    </section>

    <!-- é…æ¯æ™‚é–“è¡¨ -->
    <section id="timeline" class="mt-10">
      <h2 id="timeline-header" class="text-2xl font-bold text-center text-emerald-200 mb-3"></h2>
      <p class="text-center text-xs md:text-sm text-slate-300 mb-6">
        ä»¥ä¸‹ç‚ºæœ¬æœˆå¯¦éš›ç™¼æ”¾æ—¥è³‡æ–™ï¼Œæ–¹ä¾¿ä½ å®‰æ’ï¼šå“ªå¤©éŒ¢é€²ä¾†ã€å“ªä¸€å¤©è¦æ‰£æˆ¿è²¸ã€å¡è²»ã€æˆ–æ˜¯åŠ ç¢¼å®šæœŸå®šé¡ã€‚
      </p>
      <div id="dividendList"></div>
    </section>

    <!-- Footer -->
    <footer class="mt-10 bg-slate-900/80 border border-slate-700 rounded-2xl py-6 px-4 md:px-6 text-slate-300 text-[0.75rem] md:text-xs">
      <div class="max-w-4xl mx-auto grid gap-6 md:grid-cols-2">
        <!-- è³‡æ–™ä¾†æº & ä½œè€… -->
        <div class="flex flex-col space-y-2">
          <p class="flex items-center space-x-1">
            <span>ğŸ“Š è³‡æ–™ä¾†æºï¼š</span>
            <a href="https://www.twse.com.tw/zh/ETFortune/announcementList"
               target="_blank" rel="noopener"
               class="underline hover:text-sky-300">
              è‡ºç£è­‰åˆ¸äº¤æ˜“æ‰€ ETF é…æ¯å…¬å‘Š
            </a>
          </p>
          <p>ğŸ¬ æ•´ç†èˆ‡è¨­è¨ˆï¼šå³é¦¬å…‹ï¼ˆå¹¸ç¦ç†è²¡å®¶ï¼‰</p>
          <p>ğŸ’¡ å»ºè­°ï¼šæŠŠé€™é è¨­æˆæ›¸ç±¤ï¼Œç•¶æˆä½ æ¯æœˆã€Œé…æ¯æª¢æŸ¥é»ã€ã€‚</p>
        </div>

        <!-- æŠ•è³‡é¢¨éšªæç¤º -->
        <div class="space-y-2">
          <p class="font-semibold text-amber-300">ğŸ“¢ æŠ•è³‡é¢¨éšªæç¤ºï¼š</p>
          <ul class="list-disc list-inside space-y-1 leading-relaxed">
            <li>åŸºé‡‘é…æ¯ç‡â‰ å ±é…¬ç‡ï¼Œéå»é…æ¯ä¸ä»£è¡¨æœªä¾†ç¸¾æ•ˆã€‚</li>
            <li>æœ¬é è³‡æ–™åƒ…ä¾›æŠ•è³‡ç´€éŒ„åˆ†äº«èˆ‡ç†è²¡æ•™è‚²ï¼Œéå€‹åˆ¥åŒ–æŠ•è³‡å»ºè­°ã€‚</li>
            <li>ETF ç­‰é‡‘èå•†å“æœ‰æ¼²æœ‰è·Œï¼Œè«‹å¯©æ…è©•ä¼°è‡ªèº«é¢¨éšªæ‰¿å—åº¦ã€‚</li>
            <li>å¦‚éœ€å°ˆæ¥­å»ºè­°ï¼Œè«‹è«®è©¢åˆæ ¼é‡‘èé¡§å•ã€‚</li>
          </ul>
        </div>
      </div>

      <!-- å›åˆ°é ‚éƒ¨ -->
      <p class="mt-6 text-center">
        <a href="#"
           class="inline-block hover:underline text-slate-400 hover:text-slate-200">
          â†‘ å›åˆ°é ‚éƒ¨ï¼Œæ›å¦ä¸€æª” ETF çœ‹çœ‹
        </a>
      </p>
    </footer>
  </div>
</main>

<script>
  const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSYJzDEa1_U_eq_Wh_Sr6VcSLENN2-Uit1wHBmx5qZS_-2EOg0WNAeSBg1lK4blObR3R88nH08j074W/pub?gid=122705340&single=true&output=csv';

  // ğŸ”¹ å…¨åŸŸè®Šæ•¸ï¼šå…¨éƒ¨è³‡æ–™ + ç•¶å‰å¹´æœˆ
  let allData = [];
  let currentYear = null;
  let currentMonth = null;

  // æ‰‹æ©Ÿé¸å–®
  function toggleNav() {
    const nav = document.getElementById('navBar');
    if (!nav) return;
    nav.classList.toggle('active');
  }

  // å·¥å…·ï¼šä»£è™Ÿå»æ‰å‰ç½® 0
  function normalizeCode(code) {
    return (code || '').toString().trim().replace(/^0+/, '');
  }

  // å·¥å…·ï¼šæ•¸å­—æ ¼å¼åŒ–
  function formatAmount(n, digits = 2) {
    if (n === null || n === undefined || isNaN(n)) return '-';
    return Number(n).toLocaleString('zh-TW', {
      minimumFractionDigits: digits,
      maximumFractionDigits: digits
    });
  }

  // ğŸ”¹ æ‰¾ã€Œä¸Šä¸€ç­†é…æ¯ç´€éŒ„ã€
  function findPreviousDividendRecord(etfCode, curYear, curMonth) {
    const target = normalizeCode(etfCode);
    let best = null;

    allData.forEach(r => {
      const code = normalizeCode(r['è‚¡è™Ÿ'] || r['è‚¡ç¥¨ä»£è™Ÿ']);
      if (!code || code !== target) return;

      const y = parseInt(r['è¥¿å…ƒ'], 10);
      const m = parseInt(r['æœˆä»½'], 10);
      if (isNaN(y) || isNaN(m)) return;

      // åªçœ‹æœ¬æœŸä¹‹å‰
      if (y < curYear || (y === curYear && m < curMonth)) {
        if (!best) {
          best = r;
        } else {
          const by = parseInt(best['è¥¿å…ƒ'], 10);
          const bm = parseInt(best['æœˆä»½'], 10);
          if (y > by || (y === by && m > bm)) {
            best = r;
          }
        }
      }
    });

    return best;
  }

  // å‰äº”åæ’è¡Œ
  function renderTop5(data) {
    const c = document.getElementById('top5-cards');
    c.innerHTML = '';
    const list = data
      .filter(r => r['é ä¼°é…æ¯'] && r['æ”¶ç›¤åƒ¹'])
      .map(r => {
        const est = parseFloat(r['é ä¼°é…æ¯']);
        const close = parseFloat(r['æ”¶ç›¤åƒ¹']);
        const rate = close ? (est / close) * 100 : NaN;
        return {
          code: r['è‚¡è™Ÿ'] || r['è‚¡ç¥¨ä»£è™Ÿ'],
          name: r['è‚¡ç¥¨åç¨±'],
          rate
        };
      })
      .filter(r => !isNaN(r.rate))
      .sort((a, b) => b.rate - a.rate)
      .slice(0, 5);
    const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'];
    list.forEach((r, i) => {
      const card = document.createElement('div');
      card.className = 'bg-slate-900/90 border border-emerald-400/50 p-4 rounded-2xl shadow-lg shadow-emerald-900/50 flex flex-col items-center justify-between';
      card.innerHTML = `
        <div class="text-3xl mb-1">${medals[i]}</div>
        <div class="text-center font-bold text-lg mb-1 text-emerald-200">${r.code}</div>
        <div class="text-center text-xs text-slate-300 mb-2 leading-snug">${r.name}</div>
        <div class="text-center text-2xl font-semibold text-amber-300">${r.rate.toFixed(2)}%</div>
      `;
      c.appendChild(card);
    });
  }
 
  // ğŸ”¹ ç€‘å¸ƒç‰†å¡ç‰‡ï¼ˆå«ã€Œèˆ‡ä¸Šæ¬¡é…æ¯æ¯”è¼ƒã€ï¼‰
  function renderCards(data) {
    const c = document.getElementById('card-container');
    c.innerHTML = '';
    document.getElementById('loading').style.display = 'none';

    data.forEach(r => {
      const code = r['è‚¡è™Ÿ'];
      const name = r['è‚¡ç¥¨åç¨±'];
      const freq = r['é…æ¯é »ç‡'] || '';
      const close = r['æ”¶ç›¤åƒ¹'] || '-';
      const yieldRate = r['å–®æœŸæ®–åˆ©ç‡'] || '-';
      const exDate = r['é™¤æ¯æ—¥'] || '-';
      const payDate = r['ç™¼æ”¾æ—¥'] || '-';
      const estDivRaw = r['é ä¼°é…æ¯'];
      const actualDivRaw = r['å¯¦éš›é…æ¯'];
      const curDiv = parseFloat(actualDivRaw || estDivRaw || '0');

      // æ‰¾ä¸Šä¸€ç­†é…æ¯
      const prev = findPreviousDividendRecord(code, currentYear, currentMonth);
      let diffHtml = 'è¼ƒä¸Šæ¬¡é…æ¯ï¼šâ€”';

      if (prev) {
        const prevDiv = parseFloat(prev['å¯¦éš›é…æ¯'] || prev['é ä¼°é…æ¯'] || '0');
        if (curDiv > 0 && prevDiv > 0) {
          const diff = curDiv - prevDiv;
          const pct = (diff / prevDiv) * 100;
          let arrow = 'â–¬';
          let colorClass = 'text-slate-400';
          if (diff > 0) {
            arrow = 'â–²';
            colorClass = 'text-emerald-300';
          } else if (diff < 0) {
            arrow = 'â–¼';
            colorClass = 'text-red-300';
          }
          diffHtml = `è¼ƒä¸Šæ¬¡é…æ¯ï¼š<span class="${colorClass}">${arrow} ${diff > 0 ? '+' : ''}${diff.toFixed(3)} å…ƒï¼ˆ${diff > 0 ? '+' : ''}${pct.toFixed(1)}%ï¼‰</span>`;
        }
      }

      const card = document.createElement('div');
      card.className = 'bg-gradient-to-br from-[#021B1A] via-[#0B3A2E] to-slate-950 text-[#FFF8D6] p-5 rounded-2xl shadow-xl border border-emerald-500/40 flex flex-col gap-3 relative overflow-hidden';
      card.innerHTML = `
        <div class="absolute inset-0 opacity-50 pointer-events-none"
             style="background:
               radial-gradient(circle at 0 0, rgba(250, 204, 21, 0.20), transparent 60%),
               radial-gradient(circle at 100% 100%, rgba(56, 189, 248, 0.20), transparent 60%);">
        </div>
        <div class="relative flex justify-between items-center">
          <div>
            <div class="text-xs uppercase tracking-[0.2em] text-emerald-200/80 mb-1">ETF</div>
            <div class="text-3xl font-extrabold text-amber-300">${code}</div>
          </div>
          <div class="text-xs bg-amber-500 text-slate-900 px-2 py-1 rounded-lg font-semibold shadow">
            ${freq || 'é…æ¯'}
          </div>
        </div>
        <div class="relative text-lg font-bold mb-2 text-slate-50">${name}</div>
        <div class="relative grid grid-cols-2 gap-2 text-center">
          <div class="bg-amber-300 text-slate-900 p-3 rounded-xl shadow-inner">
            <div class="text-[0.65rem] mb-1 tracking-wide uppercase">
              ${actualDivRaw ? 'å¯¦éš›é…æ¯' : 'é ä¼°é…æ¯'}
            </div>
            <div class="text-2xl font-extrabold">${actualDivRaw || estDivRaw || '-'}</div>
            <div class="text-[0.65rem] mt-1 text-slate-800/80">æ¯è‚¡ï¼ˆå…ƒï¼‰</div>
          </div>
          <div class="bg-slate-900/80 text-emerald-100 p-3 rounded-xl border border-emerald-400/60">
            <div class="text-[0.65rem] mb-1">æœ€å¾Œè²·é€²æ—¥</div>
            <div class="text-xl font-bold">${r['æœ€å¾Œè²·é€²æ—¥'] || '-'}</div>
            <div class="text-[0.65rem] mt-1 text-slate-300/80">å«æ¯æœ€å¾Œä¸€å¤©</div>
          </div>
        </div>
        <div class="relative grid grid-cols-3 gap-2 text-center text-sm">
          <div>
            <div class="text-[0.65rem] text-slate-300/80">æ”¶ç›¤åƒ¹</div>
            <div class="font-bold">${close}</div>
          </div>
          <div>
            <div class="text-[0.65rem] text-slate-300/80">å–®æœŸæ®–åˆ©ç‡</div>
            <div class="font-bold">${yieldRate}</div>
          </div>
          <div>
            <div class="text-[0.65rem] text-slate-300/80">é™¤æ¯æ—¥</div>
            <div class="font-bold">${exDate}</div>
          </div>
        </div>
        <div class="relative text-[0.7rem] text-right text-slate-300 mt-1">é…ç™¼æ—¥ï¼š${payDate}</div>
        <div class="relative text-[0.7rem] text-right text-slate-200 mt-1">${diffHtml}</div>
      `;
      c.appendChild(card);
    });
  }

  // æ”¶ç›Šçµ„æˆå¡ç‰‡
  function renderComposition(data) {
    const comp = document.getElementById('composition-container');
    comp.innerHTML = '';
    data.forEach(r => {
      const card = document.createElement('div');
      card.className = 'card-common';
      card.innerHTML = `
        <h3>${r['è‚¡è™Ÿ']}</h3>
        <div class="etf-name">${r['è‚¡ç¥¨åç¨±']}</div>
        <div class="bg-slate-950/80 p-4 rounded-xl shadow-inner relative z-10 border border-slate-600/70">
          <div class="grid grid-cols-3 gap-3 text-center text-[#E5E7EB] text-xs md:text-sm">
            <div class="highlight">
              <div class="text-[0.65rem] text-slate-300/90 mb-1">å¹´åˆè‡³ä»Šå ±é…¬</div>
              <div class="text-sm md:text-base font-semibold">${r['å¹´åˆè‡³ä»Šå ±é…¬'] || '-'}</div>
            </div>
            <div class="highlight">
              <div class="text-[0.65rem] text-slate-300/90 mb-1">å¯¦éš›é…æ¯</div>
              <div class="text-sm md:text-base font-semibold">${r['å¯¦éš›é…æ¯'] || '-'}</div>
            </div>
            <div class="highlight">
              <div class="text-[0.65rem] text-slate-300/90 mb-1">è‚¡åˆ©æ‰€å¾—</div>
              <div class="text-sm md:text-base font-semibold">${r['è‚¡åˆ©æ‰€å¾—'] || '-'}</div>
            </div>
            <div class="highlight">
              <div class="text-[0.65rem] text-slate-300/90 mb-1">54C</div>
              <div class="text-sm md:text-base font-semibold">${r['54C'] || '-'}</div>
            </div>
            <div class="highlight">
              <div class="text-[0.65rem] text-slate-300/90 mb-1">åˆ©æ¯æ‰€å¾—</div>
              <div class="text-sm md:text-base font-semibold">${r['åˆ©æ¯æ‰€å¾—'] || '-'}</div>
            </div>
            <div class="highlight">
              <div class="text-[0.65rem] text-slate-300/90 mb-1">æ”¶ç›Šå¹³æº–é‡‘</div>
              <div class="text-sm md:text-base font-semibold">${r['æ”¶ç›Šå¹³æº–é‡‘'] || '-'}</div>
            </div>
            <div class="highlight">
              <div class="text-[0.65rem] text-slate-300/90 mb-1">è³‡æœ¬åˆ©å¾—</div>
              <div class="text-sm md:text-base font-semibold">${r['è³‡æœ¬åˆ©å¾—'] || '-'}</div>
            </div>
            <div class="highlight">
              <div class="text-[0.65rem] text-slate-300/90 mb-1">å…¶ä»–æ‰€å¾—</div>
              <div class="text-sm md:text-base font-semibold">${r['å…¶ä»–æ‰€å¾—'] || '-'}</div>
            </div>
            <div class="highlight">
              <div class="text-[0.65rem] text-slate-300/90 mb-1">å¥ä¿æ‡‰èª²å¼µæ•¸</div>
              <div class="text-sm md:text-base font-semibold">${r['å¥ä¿æ‡‰èª²å¼µæ•¸'] || '-'}</div>
            </div>
          </div>
        </div>`;
      comp.appendChild(card);
    });
  }

  // é…æ¯æ™‚é–“è¡¨
  function renderTimeline(data) {
    const div = document.getElementById('dividendList');
    div.innerHTML = '';
    if (data.length === 0) {
      div.innerHTML = '<p class="text-center text-slate-400">âš ï¸ æœ¬æœˆç„¡é…æ¯å…¥å¸³è³‡æ–™</p>';
      return;
    }
    const groups = {};
    data.forEach(r => {
      const date = (r['ç™¼æ”¾æ—¥'] || '').trim();
      if (!date) return;
      groups[date] = groups[date] || [];
      groups[date].push(r);
    });
    Object.keys(groups).sort((a, b) => new Date(a) - new Date(b))
      .forEach(date => {
        const card = document.createElement('div');
        card.className = 'bg-[#FFF9E0] text-slate-900 p-4 rounded-xl shadow-md mb-6';
        card.innerHTML = `
          <div class="text-lg font-bold text-[#1D4A35] mb-3 flex items-center gap-2">
            <span class="bg-[#1D4A35] text-white text-xs px-2 py-1 rounded">ç™¼æ”¾æ—¥</span>${date}
          </div>
          <div class="divide-y divide-yellow-200">
            ${groups[date].map(etf => `
              <div class="grid grid-cols-[90px_1fr_120px] items-start py-2 text-sm">
                <div class="font-bold text-[#1D4A35]">${etf['è‚¡è™Ÿ']}</div>
                <div class="text-gray-800 break-words">${etf['è‚¡ç¥¨åç¨±']}</div>
                <div class="text-right text-gray-700">
                  æ¯è‚¡é…æ¯ ${(etf['å¯¦éš›é…æ¯'] || etf['é ä¼°é…æ¯'] || '-')} å…ƒ
                </div>
              </div>`).join('')}
          </div>`;
        div.appendChild(card);
      });
  }

  // ğŸ”¹ ä½ çš„ETFé…æ¯è©¦ç®—
  function handleMyDividendCalc() {
    const codeInput = document.getElementById('my-dividend-code').value;
    const lotsInput = document.getElementById('my-dividend-lots').value;
    const resultDiv = document.getElementById('my-dividend-result');

    if (!allData || allData.length === 0) {
      resultDiv.textContent = 'è³‡æ–™å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å€™å†è©¦ ğŸ™';
      return;
    }

    const lots = parseFloat(lotsInput || '0');
    if (!codeInput || !lots || lots <= 0) {
      resultDiv.textContent = 'è«‹è¼¸å…¥æ­£ç¢ºçš„ ETF ä»£è™Ÿèˆ‡æŒæœ‰å¼µæ•¸å“¦ï¼';
      return;
    }

    const norm = normalizeCode(codeInput);
    // åªçœ‹ç•¶æœˆè³‡æ–™
    const candidates = allData.filter(r => {
      const y = parseInt(r['è¥¿å…ƒ'], 10);
      const m = parseInt(r['æœˆä»½'], 10);
      const code = normalizeCode(r['è‚¡è™Ÿ'] || r['è‚¡ç¥¨ä»£è™Ÿ']);
      return y === currentYear && m === currentMonth && code === norm;
    });

    if (!candidates.length) {
      resultDiv.innerHTML = `æ‰¾ä¸åˆ°ç•¶æœˆä»£è™Ÿ <span class="font-mono font-semibold">${codeInput}</span> çš„é…æ¯è³‡æ–™ï¼Œå¯èƒ½æœ¬æœŸæ²’æœ‰é…æ¯ï¼Œæˆ–ä»£è™Ÿè¼¸å…¥æœ‰èª¤ã€‚`;
      return;
    }

    const r = candidates[0];
    const code = r['è‚¡è™Ÿ'];
    const name = r['è‚¡ç¥¨åç¨±'];
    const exDate = r['é™¤æ¯æ—¥'] || '-';
    const payDate = r['ç™¼æ”¾æ—¥'] || '-';
    const actualDivRaw = r['å¯¦éš›é…æ¯'];
    const estDivRaw = r['é ä¼°é…æ¯'];
    const perShare = parseFloat(actualDivRaw || estDivRaw || '0');

    if (!perShare) {
      resultDiv.innerHTML = `
        æœ‰æ‰¾åˆ° <span class="font-semibold">${code}</span>ï¼ˆ${name}ï¼‰ï¼Œ
        ä½†æœ¬æœŸé…æ¯é‡‘é¡å°šæœªå…¬å¸ƒï¼ˆæˆ–è³‡æ–™ç‚ºç©ºï¼‰ï¼Œæš«æ™‚ç„¡æ³•ä¼°ç®— ğŸ’­
      `;
      return;
    }

    const perLot = perShare * 1000;
    const total = perLot * lots;
    const label = actualDivRaw ? 'å¯¦éš›é…æ¯' : 'é ä¼°é…æ¯';

    // æ‰¾ä¸Šä¸€ç­†é…æ¯ï¼Œé †ä¾¿é¡¯ç¤ºå‡/é™
    const prev = findPreviousDividendRecord(code, currentYear, currentMonth);
    let prevText = 'è¼ƒä¸Šæ¬¡é…æ¯ï¼šâ€”';
    if (prev) {
      const prevDiv = parseFloat(prev['å¯¦éš›é…æ¯'] || prev['é ä¼°é…æ¯'] || '0');
      if (prevDiv > 0) {
        const diff = perShare - prevDiv;
        const pct = (diff / prevDiv) * 100;
        let arrow = 'â–¬';
        let color = '#9CA3AF';
        if (diff > 0) {
          arrow = 'â–²';
          color = '#16A34A';
        } else if (diff < 0) {
          arrow = 'â–¼';
          color = '#DC2626';
        }
        prevText = `è¼ƒä¸Šæ¬¡é…æ¯ï¼š<span style="color:${color}">${arrow} ${diff > 0 ? '+' : ''}${diff.toFixed(3)} å…ƒï¼ˆ${diff > 0 ? '+' : ''}${pct.toFixed(1)}%ï¼‰</span>`;
      }
    }

    resultDiv.innerHTML = `
      <p class="mb-1">
        ä½ æŒæœ‰ <span class="font-semibold">${lots}</span> å¼µ
        <span class="font-semibold">${code}</span>ï¼ˆ${name}ï¼‰ã€‚
      </p>
      <p class="mb-1">
        æœ¬æœŸæ¯è‚¡${label}ï¼š<span class="font-semibold">${perShare.toFixed(3)} å…ƒ</span>ï¼Œ
        æ¯å¼µç´„ï¼š<span class="font-semibold">${formatAmount(perLot)} å…ƒ</span>ã€‚
      </p>
      <p class="mb-1">
        ğŸ‘‰ æœ¬æœŸé ä¼°å¯é ˜é…æ¯ç´„ï¼š
        <span class="font-bold text-emerald-300 text-base">${formatAmount(total)} å…ƒ</span>
      </p>
      <p class="mb-1 text-[0.7rem] text-slate-400">
        é™¤æ¯æ—¥ï¼š${exDate}ï½œé…ç™¼æ—¥ï¼š${payDate}
      </p>
      <p class="mt-1 text-[0.7rem]">${prevText}</p>
    `;
  }

  // è®€å– CSV ä¸¦æ¸²æŸ“
  Papa.parse(csvUrl, {
    download: true,
    header: true,
    complete(results) {
      allData = results.data || [];

      const now = new Date();
      currentYear = now.getFullYear();
      currentMonth = now.getMonth() + 1;

      const upd = allData[0]?.['æ›´æ–°æ—¥æœŸ'] || '';
      if (upd) document.getElementById('last-update').textContent = `æ›´æ–°æ™‚é–“ï¼š${upd}`;

      const monthData = allData.filter(r =>
        parseInt(r['è¥¿å…ƒ'], 10) === currentYear &&
        parseInt(r['æœˆä»½'], 10) === currentMonth
      );

      renderTop5(monthData);
      renderCards(monthData);
      renderComposition(monthData);

      const timelineData = allData.filter(r => {
        const dStr = (r['ç™¼æ”¾æ—¥'] || '').trim();
        if (!dStr) return false;
        const parts = dStr.split('/');
        const mon = parts.length === 3 ? +parts[1] : +parts[0];
        return parseInt(r['è¥¿å…ƒ'], 10) === currentYear && mon === currentMonth;
      });
      renderTimeline(timelineData);

      document.getElementById('timeline-header').textContent =
        `ğŸ“… ${currentYear}å¹´ ${String(currentMonth).padStart(2, '0')}æœˆ ETF é…æ¯å…¥å¸³æ™‚é–“è¡¨`;
    }
  });

  // æ¨¡å¼åˆ‡æ›
  document.querySelectorAll('#mode-switch button').forEach(btn => {
    btn.addEventListener('click', () => {
      const mode = btn.dataset.mode;
      document.getElementById('mode-forecast').style.display =
        mode === 'forecast' ? 'block' : 'none';
      document.getElementById('mode-distribution').style.display =
        mode === 'distribution' ? 'block' : 'none';
      document.querySelectorAll('#mode-switch button').forEach(b => {
        if (b === btn) {
          b.classList.remove('bg-slate-800', 'text-slate-200', 'border', 'border-slate-500');
          b.classList.add('bg-[#1D4A35]', 'text-[#FFD54F]', 'shadow-md', 'shadow-emerald-500/30');
        } else {
          b.classList.remove('bg-[#1D4A35]', 'text-[#FFD54F]', 'shadow-md', 'shadow-emerald-500/30');
          b.classList.add('bg-slate-800', 'text-slate-200', 'border', 'border-slate-500');
        }
      });
    });
  });

  // ğŸ”¹ ç¶å®šã€Œä½ çš„ETFé…å¤šå°‘ï¼Ÿã€æŒ‰éˆ•ï¼ˆç­‰å¾… DOM å­˜åœ¨ï¼‰
  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('my-dividend-btn');
    if (btn) btn.addEventListener('click', handleMyDividendCalc);
  });
</script>
