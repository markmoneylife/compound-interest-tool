<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- âœ… Page / SEO -->
  <title>æŠ•è³‡æ˜ŸçƒåŸºåœ°ï½œé…æ¯ç´€éŒ„å„€è¡¨æ¿ï¼ˆv1ï¼‰ï½œMark Money Life</title>
  <meta name="description" content="æŠ•è³‡æ˜ŸçƒåŸºåœ°ï¼šæŠŠæ¯æœˆé…æ¯è®Šæˆå¯è¿½è¹¤çš„é€²åº¦ã€‚è‡ªå‹•è¨˜ä½ä½ çš„å¹´åº¦ç›®æ¨™èˆ‡ç´€éŒ„ï¼Œé¡¯ç¤ºæœ¬æœˆé…æ¯ã€å¹´åº¦ç´¯ç©ã€è·é›¢ç›®æ¨™å·®è·èˆ‡é”æˆç‡ã€‚æ”¯æ´é›²ç«¯å‚™ä»½åˆ° Google Sheetï¼ˆå¤±æ•—ä¸å½±éŸ¿ä½¿ç”¨ï¼‰ã€‚" />
  <link rel="canonical" href="https://markmoneylife.com/invest-base/" />
  <!-- slug å»ºè­°ï¼šinvest-base æˆ– dividend-base æˆ– starbase -->

  <style>
    :root{
      --bg0:#050A12;
      --bg1:#071023;
      --card:#0C1628;
      --card2:#0A1220;
      --line:rgba(255,255,255,.10);
      --text:#F2F6FF;
      --muted:rgba(242,246,255,.70);
      --muted2:rgba(242,246,255,.55);
      --good:#1ed760;
      --warn:#fbbf24;
      --bad:#fb7185;
      --accentA:#22c55e;
      --accentB:#3b82f6;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 22px;
      --radius2: 16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 8%, rgba(56,189,248,.12), transparent 55%),
        radial-gradient(900px 600px at 70% 10%, rgba(34,197,94,.12), transparent 60%),
        radial-gradient(900px 700px at 60% 85%, rgba(59,130,246,.10), transparent 60%),
        linear-gradient(180deg, #030611 0%, #020513 65%, #01030A 100%);
      min-height:100vh;
      padding:34px 18px 48px;
    }

    .shell{max-width:1150px;margin:0 auto;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 18px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: 999px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px;
    }
    .brand b{font-weight:900}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 12px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12.5px;
      white-space:nowrap;
    }
    .nav{
      display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;
    }
    .nav a{
      text-decoration:none;color:var(--muted);
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding:8px 12px;border-radius:999px;
      font-size:13px;
    }
    .nav a:hover{color:var(--text);border-color:rgba(255,255,255,.18)}

    .hero{
      margin-top:18px;
      padding:22px 22px 18px;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute;inset:-2px;
      background:
        radial-gradient(800px 400px at 25% 0%, rgba(34,197,94,.13), transparent 55%),
        radial-gradient(700px 380px at 85% 10%, rgba(59,130,246,.13), transparent 55%);
      pointer-events:none;
      opacity:.9;
    }
    .hero > *{position:relative;z-index:1}
    .h1{
      font-size:34px;line-height:1.08;margin:4px 0 10px;font-weight:900;
      letter-spacing:.2px;
    }
    .sub{
      margin:0;color:var(--muted);line-height:1.7;font-size:15.5px;
      max-width:850px;
    }
    .note{
      margin-top:10px;color:var(--muted2);font-size:13.5px;line-height:1.6;
    }

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
      .h1{font-size:28px}
    }

    .card{
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.16));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:18px 18px 10px;
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
    }
    .card .hd h2{
      margin:0;font-size:18px;font-weight:900;letter-spacing:.2px;
    }
    .card .hd p{margin:8px 0 0;color:var(--muted);font-size:13.5px;line-height:1.6}
    .card .bd{padding:0 18px 18px}

    .formgrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .formgrid .full{grid-column: 1 / -1;}
    @media (max-width: 700px){
      .formgrid{grid-template-columns:1fr;}
    }
    label{display:block;margin:0 0 6px;color:var(--muted);font-size:12.5px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(4,10,20,.55);
      color:var(--text);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    input:focus, textarea:focus, select:focus{border-color:rgba(59,130,246,.35)}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 14px;border-radius: 999px;
      cursor:pointer;
      font-weight:800;
      font-size:13.5px;
    }
    .btn:hover{border-color:rgba(255,255,255,.18)}
    .btn.good{background: rgba(34,197,94,.14);border-color: rgba(34,197,94,.22)}
    .btn.bad{background: rgba(251,113,133,.14);border-color: rgba(251,113,133,.22)}
    .btn.blue{background: rgba(59,130,246,.14);border-color: rgba(59,130,246,.22)}
    .status{
      margin-top:12px;
      padding:12px 12px;
      border-radius: 12px;
      border:1px dashed rgba(255,255,255,.16);
      color:var(--muted);
      background: rgba(0,0,0,.20);
      font-size:13px;
      display:flex;gap:10px;align-items:flex-start;
    }
    .status b{color:var(--text)}
    .status .dot{
      margin-top:3px;width:9px;height:9px;border-radius:50%;
      background: rgba(255,255,255,.20);
      flex:0 0 9px;
    }
    .status.ok .dot{background: var(--good)}
    .status.warn .dot{background: var(--warn)}
    .status.bad .dot{background: var(--bad)}

    /* KPI */
    .kpiGrid{display:grid;gap:12px;margin-top:8px}
    .kpi{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:14px 14px;
    }
    .kpi .t{color:var(--muted);font-size:12.5px;margin:0 0 8px}
    .kpi .v{font-size:26px;font-weight:950;letter-spacing:.2px;margin:0}
    .kpi .s{margin:6px 0 0;color:var(--muted2);font-size:12.5px;line-height:1.45}
    .helloPill{
      align-self:flex-end;
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color:var(--muted);
      font-weight:800;font-size:13px;
      display:inline-flex;gap:8px;align-items:center;
      white-space:nowrap;
    }

    .barWrap{
      margin-top:10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      overflow:hidden;
      height:12px;
    }
    .barFill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accentA), var(--accentB));
      border-radius: 999px;
      transition: width .35s ease;
    }

    /* History */
    table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:6px}
    th{
      text-align:left;font-size:12px;color:var(--muted);
      font-weight:800;padding:0 10px;
    }
    td{
      padding:12px 10px;
      background: rgba(0,0,0,.18);
      border-top:1px solid rgba(255,255,255,.10);
      border-bottom:1px solid rgba(255,255,255,.10);
      color:var(--text);
      font-size:13.5px;
    }
    tr td:first-child{
      border-left:1px solid rgba(255,255,255,.10);
      border-top-left-radius:14px;border-bottom-left-radius:14px;
    }
    tr td:last-child{
      border-right:1px solid rgba(255,255,255,.10);
      border-top-right-radius:14px;border-bottom-right-radius:14px;
    }

    .tiny{font-size:12px;color:var(--muted2);line-height:1.6}
    .cta{
      margin-top:12px;
      padding:14px;
      border-radius: 16px;
      border:1px dashed rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .cta b{font-size:14px}
    .cta .mini{color:var(--muted);font-size:12.5px;line-height:1.6}
  </style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="brand">
        <span style="filter:drop-shadow(0 10px 24px rgba(0,0,0,.35))">ğŸª</span>
        <span><b>Mark Money Life</b>ï½œæŠ•è³‡æ˜ŸçƒåŸºåœ°</span>
        <span class="pill" id="buildTag">Hub v1 | Stable</span>
      </div>
      <div class="nav">
        <a href="https://markmoneylife.com/etf-tracker/" target="_blank" rel="noopener">ETF è¿½è¹¤ç‰†</a>
        <a href="https://markmoneylife.com/etf-dividend-wall/" target="_blank" rel="noopener">é…æ¯ç€‘å¸ƒç‰†</a>
        <a href="https://markmoneylife.com/etf-compound/" target="_blank" rel="noopener">è¤‡åˆ©è©¦ç®—</a>
        <a href="https://markmoneylife.com/newbie-village/" target="_blank" rel="noopener">æ–°æ‰‹æŠ•è³‡æ‘</a>
      </div>
    </div>

    <section class="hero">
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap">
        <div>
          <div class="h1">æŠ•è³‡æ˜ŸçƒåŸºåœ°ï¼ˆé…æ¯ç´€éŒ„å„€è¡¨æ¿ï¼‰</div>
          <p class="sub">
            é€™è£¡ä¸æ˜¯ã€Œå·¥å…·ã€ï¼Œæ˜¯ä½ çš„å›è¨ªåŸºåœ°ã€‚<br/>
            ä½ æ¯æ¬¡è¨˜ä¸€ç­†ï¼Œå°±å¤šä¸€å€‹ç†ç”±å›ä¾†çœ‹é€²åº¦ï¼š<b>æœ¬æœˆé…æ¯ / å¹´åº¦ç´¯ç© / è·é›¢ç›®æ¨™é‚„å·®å¤šå°‘</b>ã€‚
          </p>
          <p class="note">æé†’ï¼šv1 ä»¥ã€Œç©©å®šã€ç‚ºä¸»ã€‚è³‡æ–™æœƒå…ˆä¿å­˜åœ¨ä½ çš„è£ç½®ï¼ˆLocalStorageï¼‰ï¼ŒGoogle Sheet åŒæ­¥åªæ˜¯é›²ç«¯å‚™ä»½ï¼Œå¤±æ•—ä¹Ÿä¸å½±éŸ¿ä½ ä½¿ç”¨ã€‚</p>
        </div>
        <span class="pill">æ¨è–¦ slugï¼š<b>invest-base</b> / dividend-base / starbase</span>
      </div>
    </section>

    <section class="grid">

      <!-- LEFT -->
      <div class="card">
        <div class="hd">
          <div>
            <h2>ç¬¬ä¸€æ¬¡ä¾†ï¼šè¨­å®šï¼›ä¹‹å¾Œæ¯æœˆï¼šæ–°å¢ç´€éŒ„</h2>
            <p>æœƒè¨˜åœ¨ä½ çš„ç€è¦½å™¨ï¼ˆLocalStorageï¼‰ã€‚åŒä¸€å°è£ç½®å›ä¾†å°±ä¸ç”¨é‡å¡«ã€‚</p>
          </div>
          <span class="pill">å‚™ä»½ï¼šGoogle Sheetï¼ˆé¸é…ï¼‰</span>
        </div>

        <div class="bd">
          <div class="formgrid">
            <div class="full">
              <label for="userKey">user_keyï¼ˆEmail / æš±ç¨± / UIDï¼‰</label>
              <input id="userKey" autocomplete="off" placeholder="ä¾‹å¦‚ï¼šmark_test æˆ– 513 æˆ– email" />
            </div>

            <div>
              <label for="goal">å¹´åº¦é…æ¯ç›®æ¨™ï¼ˆå…ƒï¼‰</label>
              <input id="goal" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š300000" />
            </div>

            <div>
              <label for="monthKey">è¨˜éŒ„æœˆä»½ï¼ˆYYYY-MMï¼‰</label>
              <input id="monthKey" type="month" />
            </div>

            <div>
              <label for="thisMonth">æœ¬æœˆé…æ¯ï¼ˆå…ƒï¼‰</label>
              <input id="thisMonth" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š18000" />
            </div>

            <div>
              <label for="ytd">å¹´åº¦é…æ¯ç´¯ç© YTDï¼ˆå…ƒï¼‰</label>
              <input id="ytd" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š120000" />
            </div>
          </div>

          <div class="btnrow">
            <button class="btn good" id="btnSave">å„²å­˜è¨­å®š</button>
            <button class="btn blue" id="btnAdd">æ–°å¢æœ¬æœˆç´€éŒ„</button>
            <button class="btn" id="btnDemo">ç¤ºç¯„è³‡æ–™</button>
            <button class="btn bad" id="btnReset">æ¸…é™¤æœ¬æ©Ÿè³‡æ–™</button>
          </div>

          <div class="status warn" id="statusBox">
            <span class="dot"></span>
            <div>
              <b>ç‹€æ…‹ï¼š</b><span id="statusText">å°šæœªè¨­å®š</span><br/>
              <span class="tiny" id="statusSub">å…ˆè¼¸å…¥ user_key + å¹´åº¦ç›®æ¨™ï¼Œå†æŒ‰ã€Œå„²å­˜è¨­å®šã€ã€‚</span>
            </div>
          </div>

          <div style="margin-top:14px">
            <h2 style="margin:0 0 8px;font-size:16px;font-weight:950">â–¶ å‚™ä»½ / é‚„åŸï¼ˆåŒ¯å‡º / åŒ¯å…¥ JSONï¼‰</h2>
            <div class="btnrow">
              <button class="btn" id="btnExport">åŒ¯å‡º JSON</button>
              <button class="btn" id="btnImport">åŒ¯å…¥ JSON</button>
              <button class="btn" id="btnSync">æ‰‹å‹•åŒæ­¥åˆ° Google Sheet</button>
            </div>
            <textarea id="jsonBox" rows="7" placeholder="é€™è£¡æœƒé¡¯ç¤ºåŒ¯å‡ºçš„ JSONï¼Œä¹Ÿå¯ä»¥è²¼ä¸Š JSON é€²ä¾†åŒ¯å…¥ã€‚"></textarea>
            <div class="tiny" style="margin-top:8px">
              å°±ç®— Google Sheet æ›äº†ï¼Œä½ ä¹Ÿä¸æœƒä¸Ÿç´€éŒ„ï¼ˆæœ¬æ©Ÿæœƒåœ¨ï¼‰ã€‚<br/>
              å¦‚æœåŒæ­¥ä¸€ç›´å¤±æ•—ï¼Œé€šå¸¸æ˜¯ï¼šéƒ¨ç½²ä¸æ˜¯ã€Œæ‰€æœ‰äººã€ã€æˆ– token ä¸ä¸€è‡´ã€æˆ– Apps Script æ²’ç¶åˆ°æ­£ç¢ºçš„ Sheetã€‚
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="hd">
          <div>
            <h2>æœ¬æœˆèˆ‡å¹´åº¦ KPI</h2>
            <p>ä¸€çœ¼çœ‹æ‡‚ï¼šæœ¬æœˆé…æ¯ã€å¹´åº¦ç´¯ç©ã€å·®è·èˆ‡é”æˆç‡ã€‚</p>
          </div>
          <div class="helloPill" id="helloPill">ğŸ‘‹ å°šæœªç™»å…¥</div>
        </div>

        <div class="bd">
          <div class="kpiGrid">
            <div class="kpi">
              <p class="t">æœ¬æœˆé…æ¯</p>
              <p class="v" id="kpiThisMonth">â€”</p>
              <p class="s" id="kpiHint">å…ˆæ–°å¢ä¸€ç­†ç´€éŒ„ï¼Œä½ çš„åŸºåœ°å°±é–‹å§‹æˆå½¢ã€‚</p>
            </div>

            <div class="kpi">
              <p class="t">å¹´åº¦é…æ¯ç´¯ç©ï¼ˆYTDï¼‰</p>
              <p class="v" id="kpiYTD">â€”</p>
              <p class="s" id="kpiForecast">â€”</p>
            </div>

            <div class="kpi">
              <p class="t">è·é›¢ç›®æ¨™å·®è·</p>
              <p class="v" id="kpiGap">â€”</p>
              <p class="s" id="kpiGapPct">â€”</p>
            </div>

            <div class="kpi">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
                <p class="t" style="margin:0">ç›®æ¨™é”æˆç‡</p>
                <p class="t" style="margin:0;font-weight:950" id="kpiPct">â€”</p>
              </div>
              <div class="barWrap"><div class="barFill" id="barFill"></div></div>
              <p class="s" id="kpiMsg" style="margin-top:10px">â€”</p>
            </div>
          </div>

          <div style="margin-top:14px" class="kpi">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
              <h2 style="margin:0;font-size:16px;font-weight:950">ğŸ§¾ è¨˜éŒ„ç‰†ï¼ˆæœ€è¿‘ 10 ç­†ï¼‰</h2>
              <button class="btn bad" id="btnPop">åˆªé™¤æœ€å¾Œä¸€ç­†</button>
            </div>

            <table>
              <thead>
                <tr>
                  <th>æœˆä»½</th>
                  <th>æœ¬æœˆ</th>
                  <th>YTD</th>
                  <th>å·®è·</th>
                  <th>é”æˆ</th>
                </tr>
              </thead>
              <tbody id="historyBody">
                <tr>
                  <td colspan="5" style="border-radius:14px;border:1px dashed rgba(255,255,255,.14);background:rgba(0,0,0,.10);color:var(--muted)">
                    å°šç„¡ç´€éŒ„ã€‚æ–°å¢ä¸€ç­†å¾Œï¼Œé€™è£¡æœƒè®Šæˆä½ çš„æ™‚é–“ç·šã€‚
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="cta">
              <div>
                <b>â†’ å›è¨ªç†ç”±ï¼šä¸æ˜¯ã€Œå·¥å…·å¥½ç”¨ã€ï¼Œæ˜¯ã€Œæˆ‘æƒ³çœ‹æˆ‘çš„é€²åº¦ã€</b>
                <div class="mini">æ¯æ–°å¢ä¸€ç­†ç´€éŒ„ï¼Œä½ çš„åŸºåœ°å°±æ›´åƒã€Œè‡ªå·±çš„æŠ•è³‡æ˜Ÿçƒã€ã€‚</div>
              </div>
              <a class="btn good" href="https://markmoneylife.com/etf-tracker/" target="_blank" rel="noopener">å»è¿½è¹¤ç‰†ç¹¼çºŒ</a>
            </div>
          </div>
        </div>
      </div>

    </section>
  </div>

<script>
/** =========================
 *  æŠ•è³‡æ˜ŸçƒåŸºåœ° v1ï¼ˆç©©å®šç‰ˆï¼‰
 *  - ä¸»è³‡æ–™ï¼šlocalStorage
 *  - é›²ç«¯å‚™ä»½ï¼šGoogle Apps Scriptï¼ˆå¯å¤±æ•—ä¸å½±éŸ¿ä½¿ç”¨ï¼‰
 * ========================= */

  // âœ… ä½ çš„ GAS Web Appï¼ˆä½ å·²æä¾›ï¼‰
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxRmQJuLaKzmp76nIHS6upbokDZY-8eIDdtYvx_2SX2ivgx51sIVPP9zjf_YEPXQWbe/exec";

  // âœ… å¿…é ˆè·Ÿ Apps Script å…§çš„ API_TOKEN ä¸€è‡´
  //    ä½  Apps Script çœ‹èµ·ä¾†æ˜¯ "MML_SECRET_123" ä¹‹é¡
  const API_TOKEN = "MML_SECRET_123"; // â† æ”¹æˆä½  Apps Script çš„ tokenï¼ˆå…©é‚Šè¦ä¸€æ¨£ï¼‰

  // localStorage keys
  const LS_PREFIX = "mml_invest_base_v1";
  const LS_KEY = (userKey) => `${LS_PREFIX}:${String(userKey||"").trim().toLowerCase()}`;
  const LS_LAST_USER = `${LS_PREFIX}:last_user`;

  const $ = (id) => document.getElementById(id);

  const userKeyInput = $("userKey");
  const goalInput = $("goal");
  const monthKeyInput = $("monthKey");
  const thisMonthInput = $("thisMonth");
  const ytdInput = $("ytd");

  const statusBox = $("statusBox");
  const statusText = $("statusText");
  const statusSub = $("statusSub");

  const helloPill = $("helloPill");
  const kpiThisMonth = $("kpiThisMonth");
  const kpiYTD = $("kpiYTD");
  const kpiGap = $("kpiGap");
  const kpiGapPct = $("kpiGapPct");
  const kpiPct = $("kpiPct");
  const barFill = $("barFill");
  const kpiHint = $("kpiHint");
  const kpiForecast = $("kpiForecast");
  const kpiMsg = $("kpiMsg");
  const historyBody = $("historyBody");
  const jsonBox = $("jsonBox");

  const fmt = (n) => {
    if (!isFinite(n)) return "â€”";
    const x = Math.max(0, Math.round(n));
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  };
  const toNum = (v) => {
    const n = Number(String(v ?? "").replace(/[,\s]/g, ""));
    return isFinite(n) ? n : 0;
  };
  const toMonthKey = (v) => {
    // accept input[type=month] -> "YYYY-MM"
    if (!v) return "";
    const s = String(v);
    if (/^\d{4}-\d{2}$/.test(s)) return s;
    return "";
  };
  const todayMonth = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    return `${y}-${m}`;
  };

  function setStatus(kind, main, sub){
    statusBox.classList.remove("ok","warn","bad");
    statusBox.classList.add(kind);
    statusText.textContent = main || "";
    statusSub.textContent = sub || "";
  }

  function loadState(userKey){
    const key = LS_KEY(userKey);
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    try { return JSON.parse(raw); } catch(e){ return null; }
  }

  function saveState(userKey, state){
    localStorage.setItem(LS_KEY(userKey), JSON.stringify(state));
    localStorage.setItem(LS_LAST_USER, String(userKey).trim());
  }

  function ensureState(userKey){
    let st = loadState(userKey);
    if (!st){
      st = {
        v: 1,
        user_key: String(userKey).trim(),
        goal_annual_div: 0,
        records: [], // [{month, this_month, ytd, ts}]
        updated_at: Date.now()
      };
      saveState(userKey, st);
    }
    return st;
  }

  function computeLatest(st){
    const recs = Array.isArray(st.records) ? st.records.slice() : [];
    recs.sort((a,b)=> String(a.month).localeCompare(String(b.month)));
    const last = recs.length ? recs[recs.length-1] : null;

    const goal = toNum(st.goal_annual_div);
    const lastYTD = last ? toNum(last.ytd) : 0;
    const lastThis = last ? toNum(last.this_month) : 0;

    const pct = goal > 0 ? Math.min(1, lastYTD / goal) : 0;
    const gap = Math.max(0, goal - lastYTD);
    const gapPct = goal > 0 ? (gap / goal) : 0;

    // ç°¡å–® forecastï¼šç”¨ç›®å‰æœˆä»½æ¨ä¼°å¹´åŒ–ï¼ˆåªæ˜¯æç¤ºï¼Œä¸ç•¶æˆçœŸç†ï¼‰
    const monthNow = (last && last.month) ? Number(String(last.month).split("-")[1]) : (new Date().getMonth()+1);
    const forecast = (monthNow >= 1 && monthNow <= 12) ? Math.round(lastYTD / monthNow * 12) : 0;

    return {last, goal, lastYTD, lastThis, pct, gap, gapPct, forecast, monthNow, recs};
  }

  function render(){
    const userKey = String(userKeyInput.value || "").trim();
    if (!userKey){
      helloPill.textContent = "ğŸ‘‹ å°šæœªç™»å…¥";
      kpiThisMonth.textContent = "â€”";
      kpiYTD.textContent = "â€”";
      kpiGap.textContent = "â€”";
      kpiGapPct.textContent = "â€”";
      kpiPct.textContent = "â€”";
      barFill.style.width = "0%";
      kpiHint.textContent = "å…ˆè¼¸å…¥ user_keyï¼Œé€™æœƒæ˜¯ä½ å›ä¾†çš„å…¥å£ã€‚";
      kpiForecast.textContent = "â€”";
      kpiMsg.textContent = "â€”";
      historyBody.innerHTML = `<tr><td colspan="5" style="border-radius:14px;border:1px dashed rgba(255,255,255,.14);background:rgba(0,0,0,.10);color:rgba(242,246,255,.70)">å°šç„¡ç´€éŒ„ã€‚æ–°å¢ä¸€ç­†å¾Œï¼Œé€™è£¡æœƒè®Šæˆä½ çš„æ™‚é–“ç·šã€‚</td></tr>`;
      return;
    }

    const st = ensureState(userKey);
    const c = computeLatest(st);

    helloPill.textContent = `ğŸ‘‹ ${st.user_key}ï¼Œä½ å¥½ï¼`;

    kpiThisMonth.textContent = c.last ? `${fmt(c.lastThis)} å…ƒ` : "â€”";
    kpiYTD.textContent = c.last ? `${fmt(c.lastYTD)} å…ƒ` : "â€”";
    kpiGap.textContent = (st.goal_annual_div > 0) ? `${fmt(c.gap)} å…ƒ` : "â€”";
    kpiGapPct.textContent = (st.goal_annual_div > 0) ? `å·®è· ${(c.gapPct*100).toFixed(1)}%ï¼ˆè¶Šä½è¶Šå¥½ï¼‰` : "å…ˆè¨­å®šå¹´åº¦ç›®æ¨™";
    kpiPct.textContent = (st.goal_annual_div > 0) ? `${(c.pct*100).toFixed(1)}%` : "â€”";
    barFill.style.width = (st.goal_annual_div > 0) ? `${(c.pct*100).toFixed(1)}%` : "0%";

    if (!c.last){
      kpiHint.textContent = "å…ˆæ–°å¢ä¸€ç­†ç´€éŒ„ï¼Œä½ çš„åŸºåœ°å°±é–‹å§‹æˆå½¢ã€‚";
      kpiForecast.textContent = "â€”";
      kpiMsg.textContent = "å…ˆå„²å­˜è¨­å®š â†’ å†æ–°å¢æœ¬æœˆç´€éŒ„ã€‚";
    }else{
      kpiHint.textContent = `ç´€éŒ„æœˆä»½ï¼š${c.last.month}`;
      if (c.forecast && st.goal_annual_div > 0){
        kpiForecast.textContent = `ï¼ˆæ¨ä¼°å¹´åŒ–ï¼šç´„ ${fmt(c.forecast)} å…ƒ / å¹´ï¼‰`;
      }else{
        kpiForecast.textContent = "â€”";
      }

      if (st.goal_annual_div > 0){
        if (c.pct >= 1) kpiMsg.textContent = "ä½ å·²é”æˆå¹´ç›®æ¨™ã€‚ä¸‹ä¸€é—œï¼šç©©ä½ç¯€å¥ï¼Œä¸è¦äº‚åŠ æ§“æ¡¿ã€‚";
        else if (c.pct >= 0.7) kpiMsg.textContent = "å¿«åˆ°äº†ã€‚æ¥ä¸‹ä¾†æ¯”çš„æ˜¯ç´€å¾‹ï¼Œä¸æ˜¯è¡å‹•ã€‚";
        else if (c.pct >= 0.35) kpiMsg.textContent = "é€²åº¦æ­£å¸¸ã€‚ç¹¼çºŒè¨˜éŒ„ï¼Œä½ æœƒçœ‹åˆ°è‡ªå·±åœ¨è®Šå¼·ã€‚";
        else kpiMsg.textContent = "ç¾åœ¨æœ€é‡è¦ï¼šæŠŠã€Œè¨˜éŒ„ã€è®Šç¿’æ…£ã€‚";
      }else{
        kpiMsg.textContent = "è£œä¸Šå¹´åº¦ç›®æ¨™ï¼Œä½ çš„é€²åº¦æ¢æ‰æœƒé–‹å§‹è·‘ã€‚";
      }
    }

    // History last 10 (descending)
    const last10 = c.recs.slice().sort((a,b)=> String(b.month).localeCompare(String(a.month))).slice(0,10);
    if (!last10.length){
      historyBody.innerHTML = `<tr><td colspan="5" style="border-radius:14px;border:1px dashed rgba(255,255,255,.14);background:rgba(0,0,0,.10);color:rgba(242,246,255,.70)">å°šç„¡ç´€éŒ„ã€‚æ–°å¢ä¸€ç­†å¾Œï¼Œé€™è£¡æœƒè®Šæˆä½ çš„æ™‚é–“ç·šã€‚</td></tr>`;
    }else{
      historyBody.innerHTML = last10.map(r=>{
        const ytdv = toNum(r.ytd);
        const thisv = toNum(r.this_month);
        const gap = (c.goal>0) ? Math.max(0, c.goal - ytdv) : 0;
        const pct = (c.goal>0) ? Math.min(1, ytdv/c.goal) : 0;
        return `
          <tr>
            <td>${r.month}</td>
            <td>${fmt(thisv)}</td>
            <td>${fmt(ytdv)}</td>
            <td>${c.goal>0 ? fmt(gap) : "â€”"}</td>
            <td>${c.goal>0 ? Math.round(pct*100) + "%" : "â€”"}</td>
          </tr>
        `;
      }).join("");
    }
  }

  function normalizeMonthLabel(v){
    // type=month returns YYYY-MM; keep it
    const mk = toMonthKey(v);
    return mk || todayMonth();
  }

  function upsertRecord(st, month, thisMonth, ytd){
    const recs = Array.isArray(st.records) ? st.records : [];
    const idx = recs.findIndex(r => String(r.month) === String(month));
    const rec = { month, this_month: thisMonth, ytd: ytd, ts: Date.now() };
    if (idx >= 0) recs[idx] = rec; else recs.push(rec);
    st.records = recs;
    st.updated_at = Date.now();
    return st;
  }

  async function syncToGoogleSheet(state, latestRecord){
    // æœ€å° payloadï¼ˆå¾Œç«¯åªè¦ append / upsert éƒ½å¯ä»¥ï¼‰
    const payload = {
      token: API_TOKEN,
      user_key: state.user_key,
      nickname: state.user_key,
      goal_annual_div: toNum(state.goal_annual_div),
      this_month_div: latestRecord ? toNum(latestRecord.this_month) : 0,
      ytd_div: latestRecord ? toNum(latestRecord.ytd) : 0,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };

    let res, text, ct;
    try{
      res = await fetch(GAS_URL, {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      ct = (res.headers.get("content-type") || "").toLowerCase();
      text = await res.text();
    }catch(err){
      return { ok:false, reason:"network", detail:String(err) };
    }

    // å¸¸è¦‹ï¼šéƒ¨ç½²æ¬Šé™/ç™»å…¥é  â†’ å›å‚³ HTMLï¼ˆä»¥ < é–‹é ­ï¼‰
    const trimmed = (text||"").trim();
    if (trimmed.startsWith("<") || !ct.includes("application/json")){
      return {
        ok:false,
        reason:"not_json",
        detail:"å›å‚³ä¸æ˜¯ JSONï¼ˆå¤šåŠæ˜¯éƒ¨ç½²ä¸æ˜¯ã€æ‰€æœ‰äººã€ã€æˆ–éœ€è¦ç™»å…¥æˆæ¬Šã€æˆ– URL ä¸æ˜¯ /execï¼‰"
      };
    }

    try{
      const data = JSON.parse(text);
      if (data && data.ok) return { ok:true, data };
      return { ok:false, reason:"api", detail: JSON.stringify(data) };
    }catch(e){
      return { ok:false, reason:"json_parse", detail:"JSON è§£æå¤±æ•—ï¼š" + String(e) };
    }
  }

  // Events
  $("btnSave").addEventListener("click", async () => {
    const userKey = String(userKeyInput.value||"").trim();
    if (!userKey){
      setStatus("bad","è«‹å…ˆè¼¸å…¥ user_key","user_key æ˜¯ä½ å›ä¾†çš„å…¥å£ï¼ˆEmail/æš±ç¨±/UID éƒ½å¯ï¼‰ã€‚");
      return;
    }

    const st = ensureState(userKey);
    st.goal_annual_div = toNum(goalInput.value);
    saveState(userKey, st);

    setStatus("ok","è¨­å®šå·²å­˜æœ¬æ©Ÿï¼ˆç›®æ¨™å·²è¨˜ä½ï¼‰","ä½ å¯ä»¥ç›´æ¥æ–°å¢æœ¬æœˆç´€éŒ„ã€‚Google Sheet åŒæ­¥æ˜¯å‚™ä»½ï¼Œå¤±æ•—ä¸å½±éŸ¿ä½¿ç”¨ã€‚");
    render();

    // å¯é¸ï¼šå„²å­˜è¨­å®šå¾Œä¹Ÿå˜—è©¦åŒæ­¥ï¼ˆä½†ä¸é˜»æ–·ï¼‰
    const c = computeLatest(st);
    const r = await syncToGoogleSheet(st, c.last);
    if (r.ok){
      setStatus("ok","è¨­å®šå·²å­˜æœ¬æ©Ÿï¼Œä¸¦å·²å‚™ä»½åˆ° Google Sheet","åŒæ­¥æˆåŠŸ âœ…");
    }else{
      setStatus("warn","è¨­å®šå·²å­˜æœ¬æ©Ÿï¼Œä½†åŒæ­¥ Google Sheet å¤±æ•—","é›²ç«¯å‚™ä»½æš«æ™‚æœªé€£ç·šï¼ˆä¸å½±éŸ¿ä½¿ç”¨ï¼‰ã€‚è«‹æª¢æŸ¥ï¼štoken / éƒ¨ç½²ã€æ‰€æœ‰äººã€/ æ˜¯å¦ç‚º /execã€‚");
    }
  });

  $("btnAdd").addEventListener("click", async () => {
    const userKey = String(userKeyInput.value||"").trim();
    if (!userKey){
      setStatus("bad","è«‹å…ˆè¼¸å…¥ user_key","å…ˆæœ‰å…¥å£ï¼Œæ‰æœ‰åŸºåœ°ã€‚");
      return;
    }

    const st = ensureState(userKey);
    const month = normalizeMonthLabel(monthKeyInput.value);
    const thisMonth = toNum(thisMonthInput.value);
    let ytd = toNum(ytdInput.value);

    // è‹¥ä½¿ç”¨è€…æ²’å¡« ytdï¼Œå°±ç”¨ã€Œä¸Šä¸€ç­† ytd + æœ¬æœˆã€æ¨é€²ï¼ˆv1 æ–¹ä¾¿ï¼‰
    const c = computeLatest(st);
    if (!ytd){
      const prev = c.last ? toNum(c.last.ytd) : 0;
      ytd = prev + thisMonth;
    }

    st.goal_annual_div = toNum(goalInput.value) || toNum(st.goal_annual_div);
    upsertRecord(st, month, thisMonth, ytd);
    saveState(userKey, st);

    setStatus("ok","å·²æ–°å¢ç´€éŒ„ä¸¦å­˜æœ¬æ©Ÿ","å³å´ KPI å·²æ›´æ–°ã€‚æ¥è‘—å˜—è©¦é›²ç«¯å‚™ä»½ä¸­â€¦");
    render();

    const latest = computeLatest(st).last;
    const r = await syncToGoogleSheet(st, latest);
    if (r.ok){
      setStatus("ok","å·²å­˜æœ¬æ©Ÿï¼Œä¸¦å·²å‚™ä»½åˆ° Google Sheet","åŒæ­¥æˆåŠŸ âœ…ï¼ˆå°±ç®—ä¹‹å¾Œæ›è£ç½®ï¼Œä¹Ÿèƒ½æ‰¾å›ï¼‰");
    }else{
      setStatus("warn","å·²å­˜æœ¬æ©Ÿï¼Œä½†åŒæ­¥ Google Sheet å¤±æ•—","ä¸å½±éŸ¿ä½¿ç”¨ã€‚è«‹æª¢æŸ¥ï¼štoken æ˜¯å¦ä¸€è‡´ï¼éƒ¨ç½²æ˜¯å¦ã€æ‰€æœ‰äººã€ï¼URL æ˜¯å¦ /execã€‚");
    }
  });

  $("btnDemo").addEventListener("click", () => {
    userKeyInput.value = userKeyInput.value || "mark_test";
    goalInput.value = goalInput.value || "300000";
    monthKeyInput.value = todayMonth();
    thisMonthInput.value = "54000";
    ytdInput.value = "340000";
    setStatus("warn","å·²å¡«å…¥ç¤ºç¯„è³‡æ–™","ä½ å¯ä»¥æŒ‰ã€å„²å­˜è¨­å®šã€æˆ–ã€æ–°å¢æœ¬æœˆç´€éŒ„ã€ã€‚");
    render();
  });

  $("btnReset").addEventListener("click", () => {
    const userKey = String(userKeyInput.value||"").trim();
    if (!userKey){
      // è‹¥æ²’ userKeyï¼Œå°±æ¸… last_user
      localStorage.removeItem(LS_LAST_USER);
      setStatus("ok","å·²æ¸…é™¤æœ€å¾Œä½¿ç”¨è€…è¨˜éŒ„","ï¼ˆä¸æœƒå½±éŸ¿å…¶ä»– user_key çš„è³‡æ–™ï¼‰");
      render();
      return;
    }
    localStorage.removeItem(LS_KEY(userKey));
    localStorage.removeItem(LS_LAST_USER);
    setStatus("ok","å·²æ¸…é™¤æœ¬æ©Ÿè³‡æ–™","ä½ å¯ä»¥é‡æ–°è¨­å®šæ–°çš„åŸºåœ°ã€‚");
    render();
  });

  $("btnPop").addEventListener("click", () => {
    const userKey = String(userKeyInput.value||"").trim();
    if (!userKey) return;

    const st = loadState(userKey);
    if (!st || !Array.isArray(st.records) || !st.records.length){
      setStatus("warn","æ²’æœ‰å¯åˆªé™¤çš„ç´€éŒ„","å…ˆæ–°å¢ä¸€ç­†å†èªªã€‚");
      return;
    }
    // åˆªé™¤æœ€å¾Œä¸€ç­†ï¼ˆæŒ‰æœˆä»½æ’åºçš„æœ€å¾Œï¼‰
    st.records.sort((a,b)=> String(a.month).localeCompare(String(b.month)));
    st.records.pop();
    st.updated_at = Date.now();
    saveState(userKey, st);
    setStatus("ok","å·²åˆªé™¤æœ€å¾Œä¸€ç­†ï¼ˆæœ¬æ©Ÿï¼‰","éœ€è¦çš„è©±å†æ‰‹å‹•åŒæ­¥ä¸€æ¬¡ã€‚");
    render();
  });

  $("btnExport").addEventListener("click", () => {
    const userKey = String(userKeyInput.value||"").trim();
    if (!userKey){
      setStatus("bad","è«‹å…ˆè¼¸å…¥ user_key","åŒ¯å‡ºä¹Ÿéœ€è¦çŸ¥é“è¦åŒ¯å‡ºå“ªå€‹åŸºåœ°ã€‚");
      return;
    }
    const st = loadState(userKey) || ensureState(userKey);
    jsonBox.value = JSON.stringify(st, null, 2);
    setStatus("ok","å·²åŒ¯å‡º JSON","ä½ å¯ä»¥è¤‡è£½é€™æ®µåšå‚™ä»½ã€‚");
  });

  $("btnImport").addEventListener("click", () => {
    const raw = String(jsonBox.value||"").trim();
    if (!raw){
      setStatus("bad","è«‹å…ˆè²¼ä¸Š JSON","æ²’æœ‰å…§å®¹æˆ‘æ€éº¼å¹«ä½ é‚„åŸ ğŸ˜‚");
      return;
    }
    let st;
    try{ st = JSON.parse(raw); }catch(e){
      setStatus("bad","JSON æ ¼å¼éŒ¯èª¤","è«‹ç¢ºèªä½ è²¼çš„æ˜¯å®Œæ•´ JSONã€‚");
      return;
    }
    if (!st || !st.user_key){
      setStatus("bad","JSON ç¼ºå°‘ user_key","é€™ä¸æ˜¯æŠ•è³‡æ˜ŸçƒåŸºåœ°çš„å‚™ä»½æ ¼å¼ã€‚");
      return;
    }
    userKeyInput.value = st.user_key;
    goalInput.value = st.goal_annual_div || "";
    saveState(st.user_key, st);
    setStatus("ok","å·²åŒ¯å…¥ä¸¦å­˜æœ¬æ©Ÿ","å³å´ KPI å·²æ›´æ–°ã€‚");
    render();
  });

  $("btnSync").addEventListener("click", async () => {
    const userKey = String(userKeyInput.value||"").trim();
    if (!userKey){
      setStatus("bad","è«‹å…ˆè¼¸å…¥ user_key","ä½ è¦åŒæ­¥å“ªä½æ˜Ÿçƒå±…æ°‘ï¼Ÿ");
      return;
    }
    const st = loadState(userKey) || ensureState(userKey);
    const latest = computeLatest(st).last;
    setStatus("warn","æ­£åœ¨å˜—è©¦åŒæ­¥åˆ° Google Sheetâ€¦","å¦‚æœéƒ¨ç½²æ¬Šé™æˆ– token ä¸å°ï¼Œæœƒå›å‚³ HTML å°è‡´è§£æå¤±æ•—ã€‚");
    const r = await syncToGoogleSheet(st, latest);
    if (r.ok){
      setStatus("ok","åŒæ­¥æˆåŠŸ âœ…","é›²ç«¯å‚™ä»½å·²æ›´æ–°ã€‚");
    }else{
      setStatus("warn","åŒæ­¥å¤±æ•—ï¼ˆä½†æœ¬æ©Ÿå®‰å…¨ï¼‰","è«‹æª¢æŸ¥ï¼šApps Script éƒ¨ç½²ã€æ‰€æœ‰äººã€/ URL æ˜¯ /exec / token ä¸€è‡´ / ç¶å®šæ­£ç¢ºè©¦ç®—è¡¨ã€‚");
    }
  });

  // Auto load last user
  (function boot(){
    const lastUser = localStorage.getItem(LS_LAST_USER);
    if (lastUser){
      userKeyInput.value = lastUser;
      const st = loadState(lastUser);
      if (st){
        goalInput.value = st.goal_annual_div || "";
        // é è¨­å¸¶å…¥æœ¬æœˆ
        monthKeyInput.value = todayMonth();
        // é å¡« ytd = last ytd
        const c = computeLatest(st);
        if (c.last){
          ytdInput.value = c.last.ytd ?? "";
          thisMonthInput.value = "";
        }
        setStatus("ok","å·²è¼‰å…¥ä¸Šæ¬¡çš„åŸºåœ°ï¼ˆæœ¬æ©Ÿï¼‰","ç›´æ¥æ–°å¢æœ¬æœˆç´€éŒ„å°±è¡Œã€‚");
      }
    }else{
      monthKeyInput.value = todayMonth();
    }
    render();
  })();

  // Live render
  ["input","change"].forEach(evt=>{
    userKeyInput.addEventListener(evt, ()=>{ render(); });
    goalInput.addEventListener(evt, ()=>{ render(); });
    monthKeyInput.addEventListener(evt, ()=>{ render(); });
    thisMonthInput.addEventListener(evt, ()=>{ render(); });
    ytdInput.addEventListener(evt, ()=>{ render(); });
  });
</script>
</body>
</html>
