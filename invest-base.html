<section class="mml-hub" id="mmlHub" aria-label="æŠ•è³‡æ˜ŸçƒåŸºåœ°">
  <div class="mml-bg" aria-hidden="true"></div>

  <nav class="mml-nav" aria-label="å·¥å…·å°è¦½">
    <div class="mml-nav-left">
      <span class="mml-brand">Mark Money Lifeï½œæŠ•è³‡æ˜ŸçƒåŸºåœ°</span>
      <span class="mml-dot">â€¢</span>
      <span class="mml-nav-user" id="navUser">æœªç™»å…¥ä½¿ç”¨è€…</span>
    </div>
    <div class="mml-nav-right">
      <a class="mml-link" href="/etf-tracker/" data-pass="u">ETF è¿½è¹¤ç‰†</a>
      <a class="mml-link" href="/etf-dividend-wall/" data-pass="u">é…æ¯ç€‘å¸ƒç‰†</a>
      <a class="mml-link" href="/etf-compound/" data-pass="u">è¤‡åˆ©è©¦ç®—</a>
      <a class="mml-link" href="/newbie-village/" data-pass="u">æ–°æ‰‹æŠ•è³‡æ‘</a>
      <button class="mml-mini-btn" id="refreshBtn" type="button">é‡æ–°åŒæ­¥</button>
    </div>
  </nav>

  <div class="mml-card">
    <header class="mml-head">
      <div>
        <h1 class="mml-title">ä½¿ç”¨è€…æŠ•è³‡å„€è¡¨æ¿ï¼ˆæ˜ŸçƒåŸºåœ°ï¼‰</h1>
        <p class="mml-sub">
          é€™è£¡ä¸æ˜¯ã€Œå·¥å…·ã€ï¼Œæ˜¯ä½ æ¯æ¬¡å›ä¾†æœƒçœ‹åˆ°é€²åº¦çš„åŸºåœ°ã€‚<br/>
          <span class="mml-warn">æé†’ï¼šé…æ¯æ˜¯ç¾é‡‘æµï¼Œä¸ç­‰æ–¼ç²åˆ©ï¼›ä½†å®ƒæ˜¯ä½ ã€Œç´€å¾‹ã€çš„é‡Œç¨‹ç¢‘ã€‚</span>
        </p>
      </div>
      <div class="mml-badge">Hub v0.3 | Record</div>
    </header>

    <div class="mml-grid">
      <section class="mml-panel">
        <h2 class="mml-h2">ç¬¬ä¸€æ¬¡ä¾†ï¼šè¨­å®šï¼›ä¹‹å¾Œæ¯æœˆï¼šæ–°å¢ç´€éŒ„</h2>
        <p class="mml-tip">
          æœƒè¨˜åœ¨ä½ çš„ç€è¦½å™¨ï¼ˆLocalStorageï¼‰ï¼Œä¸‹æ¬¡å›ä¾†ä¸ç”¨é‡å¡«ã€‚<br/>
          ä¹Ÿæ”¯æ´å¾å…¶ä»–å·¥å…·å¸¶å›ï¼š<code>?u=</code> æˆ– <code>?user=</code>
        </p>

        <div class="mml-form">
          <label class="mml-label">
            user_keyï¼ˆEmail / æš±ç¨± / UIDï¼‰
            <input class="mml-input" id="userKeyInput" type="text" placeholder="ä¾‹å¦‚ï¼šrengary0301@gmail.com æˆ– é¦¬æ¿•å…‹001" />
          </label>

          <div class="mml-row">
            <label class="mml-label">
              å¹´åº¦é…æ¯ç›®æ¨™ï¼ˆå…ƒï¼‰
              <input class="mml-input" id="goalInput" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š300000" />
            </label>
            <label class="mml-label">
              ç´€éŒ„æœˆä»½ï¼ˆYYYY-MMï¼‰
              <input class="mml-input" id="monthInput" type="month" />
            </label>
          </div>

          <div class="mml-row">
            <label class="mml-label">
              æœ¬æœˆé…æ¯ï¼ˆå…ƒï¼‰
              <input class="mml-input" id="thisMonthInput" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š18000" />
            </label>
            <label class="mml-label">
              å¹´åº¦é…æ¯ç´¯ç© YTDï¼ˆå…ƒï¼‰
              <input class="mml-input" id="ytdInput" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š120000" />
            </label>
          </div>

          <div class="mml-actions">
            <button class="mml-btn primary" id="saveConfigBtn" type="button">å„²å­˜è¨­å®š</button>
            <button class="mml-btn" id="addRecordBtn" type="button">æ–°å¢æœ¬æœˆç´€éŒ„</button>
            <button class="mml-btn" id="demoBtn" type="button">ç¤ºç¯„è³‡æ–™</button>
            <button class="mml-btn danger" id="clearBtn" type="button">æ¸…é™¤æœ¬æ©Ÿè³‡æ–™</button>
          </div>

          <div class="mml-status" id="statusBox">ç‹€æ…‹ï¼šå°šæœªè¨­å®š</div>

          <details class="mml-details">
            <summary>å‚™ä»½ / é‚„åŸï¼ˆåŒ¯å‡º / åŒ¯å…¥ JSONï¼‰</summary>
            <div class="mml-json">
              <button class="mml-btn" id="exportBtn" type="button">åŒ¯å‡º JSON</button>
              <button class="mml-btn" id="importBtn" type="button">åŒ¯å…¥ JSON</button>
              <textarea class="mml-textarea" id="jsonBox" placeholder="é€™è£¡æœƒé¡¯ç¤ºåŒ¯å‡ºçš„ JSONï¼Œä¹Ÿå¯è²¼ä¸ŠåŒ¯å…¥"></textarea>
              <div class="mml-tip">å°±ç®— Google Sheet æ›äº†ï¼Œä½ ä¹Ÿä¸æœƒå¤±å»ç´€éŒ„ï¼ˆæœ¬æ©Ÿé‚„åœ¨ï¼‰ã€‚</div>
            </div>
          </details>
        </div>
      </section>

      <section class="mml-panel">
        <div class="mml-kpi-head">
          <h2 class="mml-h2">æœ¬æœˆèˆ‡å¹´åº¦ KPI</h2>
          <span class="mml-mini" id="helloText">ğŸ‘‹ ä½ å¥½ï¼</span>
        </div>

        <div class="mml-kpis">
          <div class="mml-kpi">
            <div class="mml-kpi-label">æœ¬æœˆé…æ¯</div>
            <div class="mml-kpi-value" id="kpiThisMonth">â€”</div>
          </div>
          <div class="mml-kpi">
            <div class="mml-kpi-label">å¹´åº¦é…æ¯ç´¯ç©ï¼ˆYTDï¼‰</div>
            <div class="mml-kpi-value" id="kpiYTD">â€”</div>
          </div>
          <div class="mml-kpi">
            <div class="mml-kpi-label">è·é›¢ç›®æ¨™å·®è·</div>
            <div class="mml-kpi-value" id="kpiGapPct">â€”</div>
          </div>
        </div>

        <div class="mml-progress">
          <div class="mml-progress-top">
            <div class="mml-progress-label">ç›®æ¨™é”æˆç‡</div>
            <div class="mml-progress-pct" id="kpiPct">â€”</div>
          </div>
          <div class="mml-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div class="mml-bar-fill" id="barFill" style="width:0%"></div>
          </div>
          <div class="mml-progress-foot" id="kpiHint">å…ˆå„²å­˜è¨­å®šï¼Œå†æ–°å¢ä¸€ç­†ç´€éŒ„ã€‚</div>
        </div>

        <div class="mml-history">
          <div class="mml-history-head">
            <h3 class="mml-h3">ğŸ§¾ è¨˜éŒ„ç‰†ï¼ˆæœ€è¿‘ 10 ç­†ï¼‰</h3>
            <button class="mml-mini-btn" id="deleteLastBtn" type="button">åˆªé™¤æœ€å¾Œä¸€ç­†</button>
          </div>

          <div class="mml-table">
            <div class="mml-tr mml-th">
              <div>æœˆä»½</div><div>æœ¬æœˆ</div><div>YTD</div><div>å·®ç•°</div><div>é”æˆ</div>
            </div>
            <div id="historyBody"></div>
          </div>

          <div class="mml-cta">
            <div>
              <div class="mml-cta-title">â†’ å›è¨ªç†ç”±ï¼šä¸æ˜¯ã€Œå·¥å…·å¥½ç”¨ã€ï¼Œæ˜¯ã€Œæˆ‘æƒ³çœ‹æˆ‘çš„é€²åº¦ã€</div>
              <div class="mml-cta-sub">æ¯æ–°å¢ä¸€ç­†ç´€éŒ„ï¼Œä½ çš„åŸºåœ°å°±æ›´åƒã€Œè‡ªå·±çš„æŠ•è³‡æ˜Ÿçƒã€ã€‚</div>
            </div>
            <a class="mml-btn primary" href="/etf-tracker/" data-pass="u">å»è¿½è¹¤ç‰†ç¹¼çºŒ</a>
          </div>
        </div>
      </section>
    </div>
  </div>

  <noscript>
    <div class="mml-noscript">æ­¤é éœ€è¦å•Ÿç”¨ JavaScript æ‰èƒ½é‹ä½œã€‚</div>
  </noscript>
</section>

<style>
  .mml-hub{position:relative;max-width:1120px;margin:18px auto 28px;padding:14px}
  .mml-bg{position:absolute;inset:0;border-radius:24px;background:
    radial-gradient(900px 520px at 12% 8%, rgba(18,74,53,.55), rgba(2,9,21,0) 62%),
    radial-gradient(900px 520px at 88% 12%, rgba(24,46,79,.55), rgba(2,9,21,0) 62%),
    linear-gradient(180deg, rgba(2,9,21,.92), rgba(0,3,9,.98));
    z-index:0}
  .mml-nav{position:sticky;top:10px;z-index:10;display:flex;justify-content:space-between;align-items:center;
    gap:10px;padding:10px 12px;border-radius:16px;margin-bottom:12px;
    background:rgba(2,9,21,.72);border:1px solid rgba(148,163,184,.22);backdrop-filter:blur(10px)}
  .mml-nav-left{display:flex;align-items:center;gap:10px;min-width:260px}
  .mml-brand{font-weight:900;color:#F5F2E9}
  .mml-dot{opacity:.45}
  .mml-nav-user{font-size:12px;color:rgba(245,242,233,.78)}
  .mml-nav-right{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
  .mml-link{font-weight:800;font-size:12px;text-decoration:none;color:rgba(245,242,233,.86);
    padding:8px 10px;border-radius:12px;background:rgba(245,242,233,.06);border:1px solid rgba(245,242,233,.12)}
  .mml-link:hover{transform:translateY(-1px)}
  .mml-mini-btn{cursor:pointer;border-radius:12px;padding:8px 10px;font-weight:900;font-size:12px;
    background:rgba(34,197,94,.18);border:1px solid rgba(34,197,94,.35);color:#F5F2E9}
  .mml-card{position:relative;z-index:1;border-radius:22px;padding:18px;
    border:1px solid rgba(148,163,184,.25);box-shadow:0 18px 50px rgba(0,0,0,.35);
    color:#F5F2E9;backdrop-filter: blur(8px)}
  .mml-head{display:flex;justify-content:space-between;gap:14px;align-items:flex-start;margin-bottom:10px}
  .mml-title{margin:0;font-size:26px;letter-spacing:.2px}
  .mml-sub{margin:8px 0 0;color:rgba(245,242,233,.78);line-height:1.6}
  .mml-warn{color:rgba(245,242,233,.70)}
  .mml-badge{font-weight:900;font-size:12px;padding:8px 10px;border-radius:999px;
    background:rgba(245,242,233,.10);border:1px solid rgba(245,242,233,.18)}
  .mml-grid{display:grid;grid-template-columns:1.05fr .95fr;gap:12px}
  @media (max-width: 960px){.mml-grid{grid-template-columns:1fr}}
  .mml-panel{border-radius:18px;padding:16px 14px;background:rgba(245,242,233,.06);
    border:1px solid rgba(148,163,184,.20)}
  .mml-h2{margin:0 0 10px;font-size:16px}
  .mml-h3{margin:0;font-size:15px}
  .mml-tip{margin:0 0 12px;font-size:12px;color:rgba(245,242,233,.72);line-height:1.55}
  .mml-form{display:grid;gap:10px}
  .mml-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width: 720px){.mml-row{grid-template-columns:1fr}}
  .mml-label{display:grid;gap:6px;font-size:13px;color:rgba(245,242,233,.82)}
  .mml-input{width:100%;border-radius:12px;padding:10px 12px;
    border:1px solid rgba(148,163,184,.25);background:rgba(2,9,21,.55);color:#F5F2E9;outline:none}
  .mml-input:focus{border-color:rgba(245,242,233,.55);box-shadow:0 0 0 3px rgba(245,242,233,.08)}
  .mml-actions{display:flex;flex-wrap:wrap;gap:8px}
  .mml-btn{appearance:none;border:none;cursor:pointer;text-decoration:none;
    border-radius:12px;padding:10px 12px;font-weight:900;
    background:rgba(245,242,233,.10);color:#F5F2E9;border:1px solid rgba(245,242,233,.16)}
  .mml-btn:hover{transform:translateY(-1px)}
  .mml-btn.primary{background:rgba(34,197,94,.22);border-color:rgba(34,197,94,.35)}
  .mml-btn.danger{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.35)}
  .mml-status{font-size:12px;line-height:1.5;padding:10px 12px;border-radius:14px;
    background:rgba(2,9,21,.42);border:1px solid rgba(148,163,184,.18);color:rgba(245,242,233,.78)}
  .mml-details summary{cursor:pointer;font-weight:900}
  .mml-json{margin-top:10px;display:grid;gap:8px}
  .mml-textarea{min-height:110px;border-radius:14px;padding:10px 12px;
    border:1px solid rgba(148,163,184,.22);background:rgba(2,9,21,.45);color:#F5F2E9;outline:none}
  .mml-kpi-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
  .mml-mini{font-size:12px;color:rgba(245,242,233,.72);padding:6px 10px;border-radius:999px;
    background:rgba(245,242,233,.08);border:1px solid rgba(245,242,233,.14)}
  .mml-kpis{display:grid;gap:10px}
  .mml-kpi{border-radius:16px;padding:12px;background:rgba(2,9,21,.45);
    border:1px solid rgba(148,163,184,.18)}
  .mml-kpi-label{font-size:12px;color:rgba(245,242,233,.72)}
  .mml-kpi-value{font-size:22px;font-weight:950;margin-top:4px}
  .mml-progress{margin-top:12px;border-radius:16px;padding:12px;background:rgba(2,9,21,.38);
    border:1px solid rgba(148,163,184,.16)}
  .mml-progress-top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px}
  .mml-progress-label{font-size:12px;color:rgba(245,242,233,.72)}
  .mml-progress-pct{font-weight:950}
  .mml-bar{height:12px;border-radius:999px;overflow:hidden;background:rgba(245,242,233,.12)}
  .mml-bar-fill{height:100%;border-radius:999px;background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(59,130,246,.95))}
  .mml-progress-foot{margin-top:8px;font-size:12px;color:rgba(245,242,233,.72);line-height:1.5}
  .mml-history{margin-top:12px}
  .mml-history-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
  .mml-table{border-radius:16px;overflow:hidden;border:1px solid rgba(148,163,184,.16);background:rgba(2,9,21,.28)}
  .mml-tr{display:grid;grid-template-columns:1.1fr .9fr .9fr .7fr .6fr;gap:10px;padding:10px 12px;
    border-top:1px solid rgba(148,163,184,.12);font-size:12px;color:rgba(245,242,233,.78)}
  .mml-th{border-top:none;background:rgba(245,242,233,.06);font-weight:900;color:rgba(245,242,233,.86)}
  .mml-cta{margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:10px;
    border-radius:16px;padding:12px;background:rgba(245,242,233,.06);border:1px dashed rgba(245,242,233,.20)}
  .mml-cta-title{font-weight:950}
  .mml-cta-sub{margin-top:3px;font-size:12px;color:rgba(245,242,233,.72);line-height:1.45}
  .mml-noscript{margin-top:12px;padding:12px;border-radius:14px;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.22);color:#F5F2E9}
</style>

<script>
(() => {
  /** âœ… å·²æ›¿ä½ å¡«å¥½ Web App URL */
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxRmQJuLaKzmp76nIHS6upbokDZY-8eIDdtYvx_2SX2ivgx51sIVPP9zjf_YEPXQWbe/exec";

  /** âš ï¸ é€™å€‹ token å¿…é ˆè·Ÿä½  Apps Script è£¡çš„ä¸€æ¨£ */
  const API_TOKEN  = "MML_SECRET_123";

  const LS_CONFIG  = "mml_invest_base_config_v1";
  const LS_HISTORY = "mml_invest_base_history_v1";
  const LS_USERKEY = "mml_user_key";

  const $ = (id) => document.getElementById(id);
  const userKeyInput  = $("userKeyInput");
  const goalInput     = $("goalInput");
  const monthInput    = $("monthInput");
  const thisMonthInput= $("thisMonthInput");
  const ytdInput      = $("ytdInput");

  const saveConfigBtn = $("saveConfigBtn");
  const addRecordBtn  = $("addRecordBtn");
  const demoBtn       = $("demoBtn");
  const clearBtn      = $("clearBtn");
  const refreshBtn    = $("refreshBtn");
  const exportBtn     = $("exportBtn");
  const importBtn     = $("importBtn");
  const jsonBox       = $("jsonBox");
  const deleteLastBtn = $("deleteLastBtn");

  const statusBox = $("statusBox");
  const navUser   = $("navUser");
  const helloText = $("helloText");

  const kpiThisMonth = $("kpiThisMonth");
  const kpiYTD       = $("kpiYTD");
  const kpiGapPct    = $("kpiGapPct");
  const kpiPct       = $("kpiPct");
  const barFill      = $("barFill");
  const kpiHint      = $("kpiHint");
  const historyBody  = $("historyBody");

  const fmt = (n) => {
    const x = Number(n);
    if (!isFinite(x)) return "â€”";
    return Math.max(0, Math.round(x)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  };
  const toNum = (v) => {
    const n = Number(String(v ?? "").replace(/[,\s]/g, ""));
    return isFinite(n) ? n : 0;
  };
  const setStatus = (t) => statusBox.textContent = `ç‹€æ…‹ï¼š${t}`;

  const todayMonth = () => {
    const d = new Date();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    return `${d.getFullYear()}-${m}`;
  };

  function getQueryUser() {
    const q = new URLSearchParams(location.search);
    return (q.get("u") || q.get("user") || "").trim();
  }

  const loadConfig = () => {
    try { return JSON.parse(localStorage.getItem(LS_CONFIG) || "{}"); }
    catch { return {}; }
  };
  const saveConfig = (cfg) => localStorage.setItem(LS_CONFIG, JSON.stringify(cfg || {}));

  const loadHistory = () => {
    try { return JSON.parse(localStorage.getItem(LS_HISTORY) || "[]"); }
    catch { return []; }
  };
  const saveHistory = (arr) => localStorage.setItem(LS_HISTORY, JSON.stringify(arr || []));

  function renderHeader(cfg) {
    const userKey = (cfg.user_key || "").trim();
    const nick = (cfg.nickname || "").trim();

    localStorage.setItem(LS_USERKEY, userKey);

    navUser.textContent = userKey ? (nick ? `${nick}ï¼ˆ${userKey}ï¼‰` : userKey) : "æœªç™»å…¥ä½¿ç”¨è€…";
    helloText.textContent = nick ? `ğŸ‘‹ ${nick}ï¼Œä½ å¥½ï¼` : "ğŸ‘‹ ä½ å¥½ï¼";
  }

  function renderKPI(cfg, latest) {
    const goal = toNum(cfg.goal_annual_div);
    const m    = toNum(latest?.this_month_div);
    const y    = toNum(latest?.ytd_div);

    kpiThisMonth.textContent = isFinite(m) ? `${fmt(m)} å…ƒ` : "â€”";
    kpiYTD.textContent       = isFinite(y) ? `${fmt(y)} å…ƒ` : "â€”";

    if (goal > 0) {
      const pct = Math.min(100, Math.max(0, (y / goal) * 100));
      const gap = Math.max(0, 100 - pct);
      const remain = Math.max(0, goal - y);

      kpiPct.textContent = `${pct.toFixed(1)}%`;
      kpiGapPct.textContent = `${gap.toFixed(1)}%`;
      barFill.style.width = `${pct.toFixed(2)}%`;
      document.querySelector(".mml-bar").setAttribute("aria-valuenow", pct.toFixed(0));

      kpiHint.textContent = remain > 0
        ? `è·é›¢å¹´åº¦ç›®æ¨™é‚„å·® ${fmt(remain)} å…ƒã€‚`
        : `ä½ å·²é”æˆå¹´åº¦ç›®æ¨™ã€‚ä¸‹ä¸€é—œï¼šç©©ä½ç¯€å¥ã€ä¸è¦äº‚åŠ æ§“æ¡¿ã€‚`;
    } else {
      kpiPct.textContent = "â€”";
      kpiGapPct.textContent = "â€”";
      barFill.style.width = "0%";
      document.querySelector(".mml-bar").setAttribute("aria-valuenow", "0");
      kpiHint.textContent = "ä½ é‚„æ²’å¡«å¹´åº¦ç›®æ¨™ï¼ˆgoal_annual_divï¼‰ï¼Œæˆ‘æ²’è¾¦æ³•ç®—é”æˆç‡ ğŸ˜„";
    }
  }

  function renderHistory(cfg, arr) {
    const goal = toNum(cfg.goal_annual_div);
    const rows = (arr || []).slice(0, 10);

    historyBody.innerHTML = "";
    if (!rows.length) {
      historyBody.innerHTML = `<div class="mml-tr"><div>å°šç„¡ç´€éŒ„</div><div>â€”</div><div>â€”</div><div>â€”</div><div>â€”</div></div>`;
      return;
    }

    rows.forEach((r, idx) => {
      const m = toNum(r.this_month_div);
      const y = toNum(r.ytd_div);
      const prev = rows[idx + 1];
      const diff = prev ? (m - toNum(prev.this_month_div)) : 0;
      const pct  = goal > 0 ? Math.min(100, Math.max(0, (y / goal) * 100)) : null;

      const sign = diff === 0 ? "" : (diff > 0 ? "+" : "");
      historyBody.insertAdjacentHTML("beforeend", `
        <div class="mml-tr">
          <div>${r.month || "â€”"}</div>
          <div>${fmt(m)}</div>
          <div>${fmt(y)}</div>
          <div>${diff ? `${sign}${fmt(Math.abs(diff))}` : "â€”"}</div>
          <div>${pct == null ? "â€”" : `${pct.toFixed(0)}%`}</div>
        </div>
      `);
    });
  }

  function updateToolLinks() {
    const u = (localStorage.getItem(LS_USERKEY) || "").trim();
    document.querySelectorAll('[data-pass="u"]').forEach(a => {
      try {
        const url = new URL(a.getAttribute("href"), location.origin);
        if (u) url.searchParams.set("u", u);
        a.setAttribute("href", url.pathname + url.search);
      } catch {}
    });
  }

  async function pushToSheet(payload) {
    const res = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ token: API_TOKEN, ...payload })
    });
    const txt = await res.text();
    try { return JSON.parse(txt); } catch { return { ok: res.ok, raw: txt }; }
  }

  function applyConfigToForm(cfg) {
    userKeyInput.value = cfg.user_key || "";
    goalInput.value    = cfg.goal_annual_div || "";
    monthInput.value   = todayMonth();
    cfg.nickname = cfg.nickname || cfg.user_key || "";
    renderHeader(cfg);
    updateToolLinks();
  }

  function getFormConfig() {
    const user_key = (userKeyInput.value || "").trim();
    const goal_annual_div = toNum(goalInput.value);
    if (!user_key) throw new Error("è«‹å…ˆå¡« user_key");
    return { user_key, nickname: user_key, goal_annual_div };
  }

  function getFormRecord() {
    const month = (monthInput.value || "").trim() || todayMonth();
    return {
      month,
      this_month_div: toNum(thisMonthInput.value),
      ytd_div: toNum(ytdInput.value)
    };
  }

  function recomputeLatest(cfg, history) {
    const latest = history[0] || { this_month_div: 0, ytd_div: 0 };
    renderKPI(cfg, latest);
    renderHistory(cfg, history);
  }

  saveConfigBtn.addEventListener("click", async () => {
    try {
      const cfg = getFormConfig();
      saveConfig(cfg);
      renderHeader(cfg);
      updateToolLinks();

      // ä½ æƒ³è¦ã€Œå¡«å®Œå°±é€ Sheetã€ï¼šå­˜è¨­å®šæ™‚ä¹ŸåŒæ­¥ä¸€æ¬¡ï¼ˆä¸å¡«æœ¬æœˆ/YTD ä¹Ÿæ²’é—œä¿‚ï¼‰
      setStatus("æ­£åœ¨åŒæ­¥åˆ° Google Sheetâ€¦");
      const apiRes = await pushToSheet({
        user_key: cfg.user_key,
        nickname: cfg.nickname,
        goal_annual_div: cfg.goal_annual_div,
        this_month_div: toNum(thisMonthInput.value),
        ytd_div: toNum(ytdInput.value)
      });

      const history = loadHistory();
      recomputeLatest(cfg, history);

      if (apiRes && apiRes.ok) setStatus("âœ… å·²å„²å­˜è¨­å®šä¸¦åŒæ­¥åˆ° Google Sheet");
      else setStatus("âš ï¸ è¨­å®šå·²å­˜æœ¬æ©Ÿï¼Œä½†åŒæ­¥ Google Sheet å¤±æ•—ï¼ˆæª¢æŸ¥ token/éƒ¨ç½²æ¬Šé™ï¼‰");
    } catch (e) {
      setStatus(`âš ï¸ ${e.message}`);
    }
  });

  addRecordBtn.addEventListener("click", async () => {
    try {
      const cfg = loadConfig();
      if (!cfg.user_key) {
        const newCfg = getFormConfig();
        saveConfig(newCfg);
      }
      const cfg2 = loadConfig();
      const rec = getFormRecord();

      const history = loadHistory();
      const next = [rec, ...history].slice(0, 30);
      saveHistory(next);

      setStatus("æ­£åœ¨å¯«å…¥ Google Sheetâ€¦ï¼ˆæœ¬æ©Ÿå·²å­˜ï¼‰");
      const apiRes = await pushToSheet({
        user_key: cfg2.user_key,
        nickname: cfg2.nickname || cfg2.user_key,
        goal_annual_div: toNum(cfg2.goal_annual_div),
        this_month_div: rec.this_month_div,
        ytd_div: rec.ytd_div
      });

      renderHeader(cfg2);
      recomputeLatest(cfg2, next);

      if (apiRes && apiRes.ok) setStatus("âœ… å·²æ–°å¢ä¸¦å¯«å…¥ Google Sheet");
      else setStatus("âš ï¸ æœ¬æ©Ÿå·²å­˜ï¼Œä½†å¯«å…¥ Google Sheet å¤±æ•—ï¼ˆæª¢æŸ¥ token/éƒ¨ç½²æ¬Šé™ï¼‰");
    } catch (e) {
      setStatus(`âš ï¸ ${e.message}`);
    }
  });

  demoBtn.addEventListener("click", () => {
    userKeyInput.value = "mark_test";
    goalInput.value = 300000;
    monthInput.value = todayMonth();
    thisMonthInput.value = 18000;
    ytdInput.value = 120000;
    setStatus("å·²å¡«å…¥ç¤ºç¯„è³‡æ–™ï¼ˆç›´æ¥æŒ‰ï¼šå„²å­˜è¨­å®š / æ–°å¢æœ¬æœˆç´€éŒ„ï¼‰");
  });

  clearBtn.addEventListener("click", () => {
    localStorage.removeItem(LS_CONFIG);
    localStorage.removeItem(LS_HISTORY);
    localStorage.removeItem(LS_USERKEY);
    userKeyInput.value = "";
    goalInput.value = "";
    thisMonthInput.value = "";
    ytdInput.value = "";
    monthInput.value = todayMonth();
    navUser.textContent = "æœªç™»å…¥ä½¿ç”¨è€…";
    helloText.textContent = "ğŸ‘‹ ä½ å¥½ï¼";
    kpiThisMonth.textContent = "â€”";
    kpiYTD.textContent = "â€”";
    kpiGapPct.textContent = "â€”";
    kpiPct.textContent = "â€”";
    barFill.style.width = "0%";
    historyBody.innerHTML = `<div class="mml-tr"><div>å°šç„¡ç´€éŒ„</div><div>â€”</div><div>â€”</div><div>â€”</div><div>â€”</div></div>`;
    setStatus("å·²æ¸…é™¤æœ¬æ©Ÿè³‡æ–™");
    updateToolLinks();
  });

  refreshBtn.addEventListener("click", () => {
    const cfg = loadConfig();
    const hist = loadHistory();
    renderHeader(cfg);
    recomputeLatest(cfg, hist);
    setStatus("å·²é‡æ–°åŒæ­¥ï¼ˆæœ¬æ©Ÿï¼‰");
  });

  exportBtn.addEventListener("click", () => {
    const cfg = loadConfig();
    const hist = loadHistory();
    jsonBox.value = JSON.stringify({ cfg, hist }, null, 2);
    setStatus("å·²åŒ¯å‡º JSONï¼ˆå¯å‚™ä»½ï¼‰");
  });

  importBtn.addEventListener("click", () => {
    try {
      const obj = JSON.parse(jsonBox.value || "{}");
      if (obj.cfg) saveConfig(obj.cfg);
      if (obj.hist) saveHistory(obj.hist);
      const cfg = loadConfig();
      const hist = loadHistory();
      applyConfigToForm(cfg);
      recomputeLatest(cfg, hist);
      setStatus("âœ… å·²åŒ¯å…¥ JSON");
    } catch {
      setStatus("âš ï¸ JSON æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•åŒ¯å…¥");
    }
  });

  deleteLastBtn.addEventListener("click", () => {
    const hist = loadHistory();
    if (!hist.length) { setStatus("æ²’æœ‰å¯åˆªçš„ç´€éŒ„"); return; }
    hist.shift();
    saveHistory(hist);
    const cfg = loadConfig();
    recomputeLatest(cfg, hist);
    setStatus("å·²åˆªé™¤æœ€å¾Œä¸€ç­†");
  });

  (function init(){
    const u = getQueryUser();
    if (u) {
      const cfg = loadConfig();
      cfg.user_key = u;
      cfg.nickname = cfg.nickname || u;
      saveConfig(cfg);
      localStorage.setItem(LS_USERKEY, u);
    }

    const cfg = loadConfig();
    applyConfigToForm(cfg);
    if (!monthInput.value) monthInput.value = todayMonth();

    const hist = loadHistory();
    recomputeLatest(cfg, hist);

    setStatus(cfg.user_key ? "å·²è¼‰å…¥æœ¬æ©Ÿè¨­å®šï¼ˆåŸºåœ°å¾…å‘½ï¼‰" : "è«‹å…ˆå¡« user_key ä¸¦å„²å­˜è¨­å®š");
  })();
})();
</script>
