<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ETF æŠ•è³‡ç¸¾æ•ˆç‰†ï½œé¦¬æ¿•å…‹ 300 æœƒå“¡å°ˆå±¬</title>

<!-- PapaParseï¼šé¿å… CSV æ¬„ä½éŒ¯ä½ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root {
    --dark: #004d40;
    --light: #ffeb3b;
    --bg: #f7f8fa;
    --text: #333;
    --red: #C0392B;
    --green: #1D4A35;
    --yellow: #C59A00;
    --card: #ffffff;
  }

  body {
    margin: 0;
    background: var(--bg);
    font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
    color: var(--text);
    line-height: 1.55;
  }

  header {
    padding: 1.5rem 1rem;
    background: var(--dark);
    color: #fff;
    text-align: center;
  }

  header h1 {
    font-size: 1.8rem;
    margin: .2rem 0;
  }

  header p {
    font-size: .95rem;
    margin-top: .4rem;
    color: #f2f2f2;
  }

  .container {
    max-width: 1100px;
    margin: 1.5rem auto;
    padding: 0 1rem;
  }

  /* è¿”å›æŒ‰éˆ• */
  .back-btn {
    display: inline-block;
    margin-bottom: 1rem;
    background: var(--dark);
    color: #fff;
    padding: .55rem 1rem;
    border-radius: 6px;
    text-decoration: none;
    font-size: .9rem;
    font-weight: bold;
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
    gap: 1rem;
    margin-top: .8rem;
  }

  .summary-card {
    background: var(--card);
    padding: 1rem;
    border-radius: 14px;
    box-shadow: 0 3px 7px rgba(0,0,0,.08);
    border-left: 6px solid var(--dark);
  }

  .summary-card h3 {
    font-size: .9rem;
    color: #666;
    margin-bottom: .25rem;
  }

  .value {
    font-size: 1.4rem;
    font-weight: 700;
  }

  .positive { color: var(--red); }
  .negative { color: var(--green); }

  /* æ•™å­¸èªªæ˜å€å¡Š */
  .hint-section {
    margin-top: 1.2rem;
    font-size: .85rem;
    color: #555;
    line-height: 1.7;
    background: #fff;
    border-radius: 10px;
    padding: 0.9rem 1rem;
    box-shadow: 0 2px 5px rgba(0,0,0,.04);
    border-left: 4px solid var(--yellow);
  }

  /* å¡ç‰‡ */
  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px,1fr));
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .etf-card {
    background: #fff;
    padding: 1rem;
    border-radius: 14px;
    box-shadow: 0 3px 8px rgba(0,0,0,.08);
  }

  .etf-title {
    font-size: 1.15rem;
    font-weight: 700;
    margin-bottom: .4rem;
  }

  .metric-label {
    font-size: .8rem;
    color: #777;
    margin-top: .7rem;
  }

  .metric-value {
    font-size: .95rem;
    font-weight: 700;
  }

  /* ä¼°å€¼ç‡ˆè™Ÿ */
  .signal-cheap { color: var(--green); font-weight: bold; }
  .signal-fair { color: var(--yellow); font-weight: bold; }
  .signal-expensive { color: var(--red); font-weight: bold; }

  /* ä¼°å€¼è¦–è¦ºé€²åº¦æ¢ */
  .value-bar {
    margin-top: .35rem;
    width: 100%;
    height: 6px;
    background: #eee;
    border-radius: 999px;
    overflow: hidden;
  }

  .value-bar-inner {
    height: 100%;
    background: linear-gradient(to right, #1D4A35, #C59A00, #C0392B);
  }

  .etf-footer {
    margin-top: .7rem;
    padding-top: .6rem;
    border-top: 1px dashed #ccc;
    font-size: .8rem;
    color: #666;
    text-align: right;
  }

  footer {
    text-align: center;
    margin: 2rem 0 1rem;
    font-size: .85rem;
    color: #777;
  }

  /* loading / error */
  #loading, #error {
    font-size: .9rem;
    text-align: center;
    margin: 1.5rem 0 .5rem;
  }

  #error {
    color: #C0392B;
    display: none;
  }

  #loading {
    color: #666;
  }
</style>
</head>

<body>

<!-- ğŸ›¡ æœƒå“¡å®ˆé–€ï¼šä¸æ˜¯å¾ 300 ä¸»é ä¾†çš„ â†’ å…¨éƒ¨è¸¢å› -->
<script>
  if (document.referrer.indexOf("wumark-x-core300") === -1) {
    window.location.href = "wumark-x-core300.html";
  }
</script>

<header>
  <h1>ğŸ“Š ETF æŠ•è³‡ç¸¾æ•ˆç‰†</h1>
  <p>300 æœƒå“¡é™å®šï½œå…¬é–‹æˆ‘çš„çœŸå¯¦æˆæœ¬ã€å ±é…¬ã€é…æ¯èˆ‡ä¼°å€¼ç‡ˆè™Ÿ</p>
</header>

<div class="container">

  <a class="back-btn" href="wumark-x-core300.html">â† è¿”å› 300 æœƒå“¡ä¸»é </a>

  <div id="loading">è³‡æ–™è¼‰å…¥ä¸­ï¼Œå¹«ä½ æŠ“ ETF ç¸¾æ•ˆä¸­â€¦â€¦</div>
  <div id="error">ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ï¼Œæˆ–é€šçŸ¥é¦¬å…‹æª¢æŸ¥è¡¨å–®é€£ç·šã€‚</div>

  <div id="summaryArea" class="summary-grid"></div>

  <!-- æœƒå“¡æ•™è‚²è§’åº¦ï¼šæ€éº¼çœ‹é€™ä¸€é  -->
  <section class="hint-section">
    <strong>æ€éº¼è§£è®€é€™å€‹ç¸¾æ•ˆç‰†ï¼Ÿ</strong><br>
    ãƒ»<b>å«æ¯ç¸½æç›Š</b>ï¼å¸‚å€¼ ï¼‹ å·²é ˜è‚¡æ¯ âˆ’ ç¸½æŠ•å…¥æˆæœ¬ã€‚<br>
    ãƒ»<b>æœªå¯¦ç¾åƒ¹å·®æç›Š</b>ï¼šåªçœ‹åƒ¹æ ¼æ¼²è·Œï¼Œä¸å«è‚¡æ¯ã€‚<br>
    ãƒ»<b>ç´¯ç©å·²é ˜è‚¡æ¯</b>ï¼šé€™æª” ETF åˆ°ç›®å‰ç‚ºæ­¢å¯¦éš›åŒ¯é€²å¸³æˆ¶çš„ç¾é‡‘ã€‚<br>
    ãƒ»<b>ä¼°å€¼è‰²å¸¶</b>ï¼šå·¦é‚Šåã€Œä¾¿å®œåƒ¹ã€ï¼Œå³é‚Šé è¿‘ã€Œæ˜‚è²´åƒ¹ã€ï¼Œæ¢è¶Šå¾€å³ä»£è¡¨åƒ¹æ ¼è¶Šæ¥è¿‘æ˜‚è²´å€ã€‚<br>
    å»ºè­°ä½ ä¹Ÿå¯ä»¥åœ¨è‡ªå·±çš„è¡¨å–®ä¸­ï¼Œç‚ºæ¯ä¸€æª” ETF è¨˜éŒ„æˆæœ¬ã€è‚¡æ¯èˆ‡ä¼°å€¼å€é–“ï¼Œæ…¢æ…¢ç·´ç¿’ç”¨ã€Œå«æ¯ã€è§’åº¦çœ‹å ±é…¬ã€‚
  </section>

  <div id="cardsContainer" class="cards-grid"></div>

  <footer>
    âš ï¸ æœ¬é ç‚ºé¦¬å…‹å€‹äºº ETF æŠ•è³‡ç´€éŒ„ï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚æŠ•è³‡ä¸€å®šæœ‰é¢¨éšªï¼Œè«‹è‡ªä¸»åˆ¤æ–·ã€‚
  </footer>

</div>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSYJzDEa1_U_eq_Wh_Sr6VcSLENN2-Uit1wHBmx5qZS_-2EOg0WNAeSBg1lK4blObR3R88nH08j074W/pub?gid=2137337223&single=true&output=csv";

function fmt(n){ return Number(n||0).toLocaleString("zh-TW"); }
function pct(n){ return Number(n||0).toFixed(2)+"%"; }

async function init(){
  const loadingEl = document.getElementById("loading");
  const errorEl   = document.getElementById("error");

  try {
    const res = await fetch(CSV_URL);
    if (!res.ok) throw new Error("network error");
    const text = await res.text();

    const parsed = Papa.parse(text, {
      header: true,
      skipEmptyLines: true
    });

    const etfs = parsed.data
      .filter(r => r["è‚¡è™Ÿ"] && r["è‚¡è™Ÿ"].trim() !== "")
      .map(r => ({
        ticker: r["è‚¡è™Ÿ"],
        name: r["è‚¡ç¥¨åç¨±"],
        cost: Number(r["ç¸½æŠ•è³‡æˆæœ¬"]||0),
        market: Number(r["å¸‚å€¼"]||0),
        // åŸå§‹è¡¨å–®å ±é…¬ç‡ï¼ˆå¯èƒ½å·²å«æ¯ï¼‰
        returnPct: Number(String(r["å ±é…¬ç‡"]||"0").replace("%","")),
        price: Number(r["æ”¶ç›¤åƒ¹"]||0),         // ç¾åƒ¹
        cheap: r["ä¾¿å®œåƒ¹"],
        fair: r["åˆç†åƒ¹"],
        expensive: r["æ˜‚è²´åƒ¹"],
        signal: r["ä¼°å€¼ç‡ˆè™Ÿ"],
        totalDiv: Number(r["ç´¯ç©è‚¡æ¯ç¸½é¡"]||0),
        freq: r["é…æ¯é »ç‡"],
        update: r["æ›´æ–°æ—¥æœŸ"]
      }));

    enhanceEtfs(etfs);
    renderSummary(etfs);
    renderCards(etfs);

    if (loadingEl) loadingEl.style.display = "none";

  } catch (err) {
    console.error(err);
    if (loadingEl) loadingEl.style.display = "none";
    if (errorEl) errorEl.style.display = "block";
  }
}

/**
 * å¹«æ¯æª” ETF å¤šç®—å¹¾å€‹ã€Œå«æ¯ã€èˆ‡ã€Œåƒ¹å·®ã€ç›¸é—œæŒ‡æ¨™
 */
function enhanceEtfs(etfs){
  etfs.forEach(e=>{
    // åƒ¹å·® & å«æ¯æç›Š
    e.priceGain = e.market - e.cost;
    e.totalGain = e.market + e.totalDiv - e.cost;

    // å ±é…¬ç‡ï¼ˆ%ï¼‰
    e.priceRet = e.cost > 0 ? e.priceGain / e.cost * 100 : 0;
    const incomeRet = e.cost > 0 ? e.totalDiv / e.cost * 100 : 0;
    const totalRetCalc = e.cost > 0 ? e.totalGain / e.cost * 100 : 0;

    // è‹¥è¡¨å–®æœ‰çµ¦å ±é…¬ç‡å°±å„ªå…ˆç”¨è¡¨å–®ï¼›æ²’æœ‰å°±ç”¨è¨ˆç®—å€¼
    if (isNaN(e.returnPct)) e.returnPct = 0;
    if (e.returnPct === 0 && totalRetCalc !== 0) {
      e.returnPct = totalRetCalc;
    }

    // å­˜ä¸€ä»½ã€Œå«æ¯ç¸½å ±é…¬ç‡ã€æ¬„ä½ï¼Œå¾Œé¢ç›´æ¥ç”¨
    e.totalRet = e.returnPct || totalRetCalc;
    e.incomeRet = incomeRet;
  });
}

function renderSummary(etfs){
  const box = document.getElementById("summaryArea");
  box.innerHTML = "";

  const totalCost   = etfs.reduce((s,e)=>s+e.cost,0);
  const totalMarket = etfs.reduce((s,e)=>s+e.market,0);
  const totalDiv    = etfs.reduce((s,e)=>s+e.totalDiv,0);

  const totalPriceGain = totalMarket - totalCost;                 // åƒ¹å·®æç›Š
  const totalTotalGain = totalMarket + totalDiv - totalCost;      // å«æ¯ç¸½æç›Š

  const totalPriceRet = totalCost>0 ? totalPriceGain/totalCost*100 : 0;
  const totalTotalRet = totalCost>0 ? totalTotalGain/totalCost*100 : 0;
  const incomeRet     = totalCost>0 ? totalDiv/totalCost*100 : 0;

  const data = [
    ["ç¸½å¸‚å€¼", "NT$ " + fmt(totalMarket), ""],
    ["ç¸½æŠ•å…¥æˆæœ¬", "NT$ " + fmt(totalCost), ""],
    ["å«æ¯ç¸½æç›Š", "NT$ " + fmt(totalTotalGain), totalTotalGain>=0 ? "positive" : "negative"],
    ["æ•´é«”å«æ¯å ±é…¬ç‡", pct(totalTotalRet), totalTotalRet>=0 ? "positive" : "negative"],
    ["å·²é ˜è‚¡æ¯å ±é…¬ç‡", pct(incomeRet), incomeRet>=0 ? "positive" : "negative"],
    ["æœªå¯¦ç¾åƒ¹å·®æç›Šï¼ˆä¸å«è‚¡æ¯ï¼‰", "NT$ " + fmt(totalPriceGain), totalPriceGain>=0 ? "positive" : "negative"]
  ];

  data.forEach(d=>{
    const card = document.createElement("div");
    card.className = "summary-card";
    card.innerHTML = `
      <h3>${d[0]}</h3>
      <div class="value ${d[2]}">${d[1]}</div>
    `;
    box.appendChild(card);
  });
}

/**
 * è¨ˆç®—ç¾åƒ¹åœ¨ ä¾¿å®œåƒ¹ï½æ˜‚è²´åƒ¹ ä¹‹é–“çš„ç›¸å°ä½ç½®ï¼ˆ0~1ï¼‰
 */
function getValuationRatio(e){
  const cheap     = Number(e.cheap || 0);
  const expensive = Number(e.expensive || 0);
  const price     = Number(e.price || 0);

  if (!cheap || !expensive || !price) return null;
  if (expensive === cheap) return null;

  let ratio = (price - cheap) / (expensive - cheap);
  ratio = Math.max(0, Math.min(1, ratio));
  return ratio;
}

function renderCards(etfs){
  const box = document.getElementById("cardsContainer");
  box.innerHTML = "";

  const totalMarket = etfs.reduce((s,e)=>s+e.market,0);

  // å…ˆä¾ã€Œå¸‚å€¼ã€ç”±å¤§åˆ°å°æ’ï¼Œå…ˆçœ‹å¤§éƒ¨ä½
  const sorted = [...etfs].sort((a,b)=>b.market - a.market);

  sorted.forEach(e=>{
    let sigClass="";
    if(e.signal && e.signal.indexOf("ä¾¿å®œ")>-1) sigClass="signal-cheap";
    else if(e.signal && e.signal.indexOf("åˆç†")>-1) sigClass="signal-fair";
    else if(e.signal && e.signal.indexOf("æ˜‚è²´")>-1) sigClass="signal-expensive";

    const weight = totalMarket>0 ? e.market / totalMarket * 100 : 0;
    const ratio = getValuationRatio(e);

    const card = document.createElement("div");
    card.className="etf-card";
    card.innerHTML=`
      <div class="etf-title">${e.ticker}ï½œ${e.name}</div>

      <div class="metric-label">å«æ¯ç¸½æç›Šï¼ˆå«è‚¡æ¯ï¼‰</div>
      <div class="metric-value ${e.totalGain>=0?"positive":"negative"}">
        NT$ ${fmt(e.totalGain)}ï¼ˆ${pct(e.totalRet)}ï¼‰
      </div>

      <div class="metric-label">æœªå¯¦ç¾åƒ¹å·®æç›Šï¼ˆä¸å«è‚¡æ¯ï¼‰</div>
      <div class="metric-value ${e.priceGain>=0?"positive":"negative"}">
        NT$ ${fmt(e.priceGain)}ï¼ˆ${pct(e.priceRet)}ï¼‰
      </div>

      <div class="metric-label">ç´¯ç©å·²é ˜è‚¡æ¯</div>
      <div class="metric-value">NT$ ${fmt(e.totalDiv)}ï¼ˆ${pct(e.incomeRet)}ï¼‰</div>

      <div class="metric-label">ç¾åƒ¹ï¼ˆæ”¶ç›¤åƒ¹ï¼‰</div>
      <div class="metric-value">NT$ ${fmt(e.price)}</div>

      <div class="metric-label">å¸‚å€¼ / æˆæœ¬</div>
      <div class="metric-value">NT$ ${fmt(e.market)} ï¼ ${fmt(e.cost)}</div>

      <div class="metric-label">æŒè‚¡å¸‚å€¼å æ¯”ï¼ˆå°æ•´é«”éƒ¨ä½ï¼‰</div>
      <div class="metric-value">${pct(weight)}</div>

      <div class="metric-label">ä¼°å€¼ç‡ˆè™Ÿ</div>
      <div class="metric-value ${sigClass}">${e.signal || "-"}</div>
      ${ratio !== null ? `
      <div class="value-bar">
        <div class="value-bar-inner" style="width:${(ratio*100).toFixed(1)}%"></div>
      </div>
      ` : ""}

      <div class="metric-label">ä¾¿å®œåƒ¹ / åˆç†åƒ¹ / æ˜‚è²´åƒ¹</div>
      <div class="metric-value">${e.cheap||"-"} ï¼ ${e.fair||"-"} ï¼ ${e.expensive||"-"}</div>

      <div class="metric-label">${e.freq ? `é…æ¯é »ç‡ï¼š${e.freq}` : ""}</div>

      <div class="etf-footer">æ›´æ–°ï¼š${e.update || "-"}</div>
    `;
    box.appendChild(card);
  });
}

init();
</script>

</body>
</html>
