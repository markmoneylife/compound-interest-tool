<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¶²çƒå­¸é™¢ï½œé‹å‹•å“¡è¨“ç·´æˆæ•ˆå ±å‘Š</title>

  <!-- Chart.js & PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <!-- ç”¢ç”Ÿ PDF ç”¨ï¼šhtml2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg-main: #020617;
      --bg-card: #020617;
      --bg-card-soft: #020617;
      --accent: #22c55e;       /* çƒå ´ç¶  */
      --accent-soft: #bbf7d0;
      --accent-alt: #38bdf8;   /* çƒæ‹è— */
      --border-subtle: #1e293b;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --text-muted: #6b7280;
      --radius-lg: 20px;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      background:
        radial-gradient(circle at 10% 0, #0f172a 0, #020617 45%, #000 100%);
      color: var(--text-main);
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .page-frame {
      max-width: 1120px;
      width: 100%;
      margin: 40px auto;
      padding: 0 16px;
    }

    .container {
      position: relative;
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.16) 0, transparent 55%),
        radial-gradient(circle at 100% 0, rgba(34,197,94,0.18) 0, transparent 60%),
        radial-gradient(circle at 50% 120%, #020617 0, #000 55%);
      padding: 26px 26px 30px;
      border-radius: 30px;
      box-shadow:
        0 24px 80px rgba(15,23,42,0.95),
        0 0 0 1px rgba(148,163,184,0.25);
      overflow: hidden;
    }

    .container::before {
      content: "";
      position: absolute;
      width: 260px;
      height: 260px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.4);
      right: -120px;
      top: -80px;
      opacity: 0.4;
      box-shadow: 0 0 50px rgba(56,189,248,0.5);
    }

    .container::after {
      content: "";
      position: absolute;
      width: 160px;
      height: 160px;
      border-radius: 999px;
      border: 2px solid rgba(34,197,94,0.8);
      left: -70px;
      bottom: -60px;
      opacity: 0.35;
      box-shadow: 0 0 40px rgba(34,197,94,0.6);
    }

    header {
      position: relative;
      z-index: 1;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 10px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #f9fafb;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1 .logo-mark {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 2px solid rgba(34,197,94,0.9);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--accent-soft);
      box-shadow: 0 0 20px rgba(34,197,94,0.9);
      background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
    }

    .brand-sub {
      font-size: 12px;
      color: var(--text-sub);
    }

    .nav-chips {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 11px;
    }

    .nav-chip {
      padding: 4px 10px;
      border-radius: 999px;
      color: var(--text-sub);
      opacity: 0.8;
    }

    .nav-chip.active {
      background: linear-gradient(to right, #22c55e, #38bdf8);
      color: #020617;
      font-weight: 600;
      opacity: 1;
      box-shadow: 0 0 18px rgba(56,189,248,0.6);
    }

    .header-sub {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px;
      color: var(--text-sub);
      font-size: 12px;
    }

    .pill-live {
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.4);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-live span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px #22c55e;
    }

    .header-sub-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 11px;
    }

    .badge-small {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      color: var(--text-sub);
    }

    .controls {
      margin-top: 4px;
      margin-bottom: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      z-index: 1;
      position: relative;
    }

    .controls label {
      font-size: 13px;
      color: var(--text-sub);
    }

    select {
      padding: 9px 12px;
      font-size: 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.65);
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      min-width: 210px;
      appearance: none;
      outline: none;
      padding-right: 30px;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
                        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position: calc(100% - 15px) 50%, calc(100% - 11px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }

    .btn {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.95);
      cursor: pointer;
      font-size: 12px;
      color: var(--text-sub);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      border-color: rgba(248,250,252,0.8);
      color: #e5e7eb;
      background: rgba(15,23,42,1);
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: default;
    }

    .report-section {
      display: none;
      margin-top: 4px;
      position: relative;
      z-index: 1;
    }

    .info-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.3fr);
      gap: 14px;
      margin-bottom: 18px;
    }

    .info-card {
      background: radial-gradient(circle at top left, rgba(34,197,94,0.08) 0, transparent 55%),
                  radial-gradient(circle at bottom right, rgba(15,23,42,1) 0, #020617 70%);
      padding: 17px 17px 15px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148,163,184,0.35);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .info-card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .info-card-title {
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .info-pill {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--text-sub);
    }

    .info-items-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 6px;
    }

    .info-item {
      min-width: 110px;
      flex: 1 1 0;
    }

    .info-item h3 {
      margin: 0;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 500;
    }

    .info-item p {
      margin: 2px 0 0;
      font-weight: 600;
      font-size: 16px;
      color: #f9fafb;
    }

    .summary-note {
      margin: 0;
      font-size: 12px;
      color: var(--text-sub);
      line-height: 1.5;
    }

    h2.section {
      border-left: 4px solid var(--accent);
      padding-left: 10px;
      margin-top: 22px;
      margin-bottom: 8px;
      font-size: 16px;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h2.section span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
    }

    h2.section.green { border-color: var(--accent-alt); }

    .section-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .chart-wrapper {
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top, #020617 0, #000 100%);
      border: 1px solid rgba(148,163,184,0.35);
      padding: 12px 12px 14px;
    }

    .chart-legend-inline {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 6px;
      padding: 0 4px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .legend-swatch {
      width: 18px;
      height: 4px;
      border-radius: 999px;
    }

    .legend-swatch.player {
      background: linear-gradient(to right, #22c55e, #4ade80);
      box-shadow: 0 0 8px rgba(34,197,94,0.8);
    }

    .legend-swatch.group {
      background: linear-gradient(to right, #9ca3af, #6b7280);
      box-shadow: 0 0 6px rgba(148,163,184,0.7);
    }

    .chart-container {
      position: relative;
      height: 360px;
      width: 100%;
      margin-top: 4px;
    }

    .coach-box {
      background: rgba(15,23,42,0.95);
      padding: 16px 17px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148,163,184,0.35);
      font-size: 13px;
      line-height: 1.7;
      color: var(--text-sub);
    }

    .coach-box strong { color: var(--accent-soft); }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.96);
    }

    th, td {
      padding: 7px 9px;
      border-bottom: 1px solid rgba(30,41,59,0.9);
      text-align: right;
      white-space: nowrap;
    }

    th:first-child, td:first-child { text-align: left; }

    thead th {
      background: radial-gradient(circle at top, #020617 0, #020617 70%);
      color: var(--text-sub);
      font-weight: 500;
    }

    tbody tr:nth-child(odd) td {
      background: rgba(15,23,42,0.86);
    }

    tbody tr:nth-child(even) td {
      background: rgba(15,23,42,1);
    }

    tbody tr:last-child td { border-bottom: none; }

    .tag {
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 11px;
    }

    .tag.good {
      border-color: rgba(34,197,94,0.8);
      background: rgba(22,163,74,0.15);
      color: #bbf7d0;
    }

    .tag.mid {
      border-color: rgba(250,204,21,0.7);
      background: rgba(133,77,14,0.2);
      color: #facc15;
    }

    .tag.bad {
      border-color: rgba(248,113,113,0.85);
      background: rgba(127,29,29,0.3);
      color: #fecaca;
    }

    .actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 18px;
    }

    .btn-pdf {
      padding: 11px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: linear-gradient(to right, #22c55e, #38bdf8);
      color: #020617;
      box-shadow: 0 14px 40px rgba(34,197,94,0.65);
    }

    .btn-pdf:hover {
      filter: brightness(1.05);
      box-shadow: 0 18px 50px rgba(34,197,94,0.9);
    }

    .btn-pdf:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .note { font-size: 11px; color: var(--text-muted); }

    #statusMsg { margin-top: 2px; }

    @media (max-width: 900px) {
      body { padding: 0; }
      .page-frame { margin: 16px auto; padding: 0 8px; }
      .container {
        padding: 18px 15px 20px;
        border-radius: 24px;
      }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .info-grid { grid-template-columns: minmax(0,1fr); }
      .chart-container { height: 320px; }
      .actions-row { justify-content: center; }
    }
  </style>
</head>
<body>
<div class="page-frame" id="pdfArea">
  <div class="container">
    <header>
      <div class="top-bar">
        <div>
          <h1>
            <span class="logo-mark">ğŸ¾</span>
            <span>ACADEMY PERFORMANCE REPORT</span>
          </h1>
          <div class="brand-sub">Match Point Labï½œç¶²çƒå­¸é™¢é«”èƒ½æª¢æ¸¬ä¸­å¿ƒ</div>
        </div>
        <div class="nav-chips">
          <div class="nav-chip active">å ±å‘Šç¸½è¦½</div>
          <div class="nav-chip">è¨“ç·´é¡åˆ¥é›·é”</div>
          <div class="nav-chip">åŒç´šå°ç…§è¡¨</div>
        </div>
      </div>
      <div class="header-sub">
        <div class="pill-live">
          <span class="dot"></span>
          <span>é€£ç·šè©¦ç®—è¡¨ Â· è‡ªå‹•æ›´æ–°å­¸å“¡æª”æ¡ˆ</span>
        </div>
        <div class="header-sub-right">
          <span class="badge-small">æ•™ç·´å…§éƒ¨å·¥å…·</span>
          <span id="statusMsg" class="note"></span>
        </div>
      </div>
    </header>

    <!-- æ§åˆ¶åˆ— -->
    <div class="controls">
      <label for="studentSelect">é¸æ“‡å­¸å“¡ï¼š</label>
      <select id="studentSelect" disabled onchange="loadStudentData()">
        <option value="">è³‡æ–™è¼‰å…¥ä¸­...</option>
      </select>
      <button class="btn" id="reloadBtn" onclick="reloadSheets()">ğŸ”„ é‡æ–°å¾ Google Sheets è¼‰å…¥</button>
    </div>

    <!-- å ±å‘Šå…§å®¹ -->
    <section id="report" class="report-section">
      <div class="info-grid">
        <!-- å­¸å“¡åŸºæœ¬è³‡æ–™å¡ -->
        <div class="info-card">
          <div class="info-card-header">
            <div class="info-card-title">PLAYER PROFILE</div>
            <div class="info-pill">å­¸å“¡åŸºæœ¬è³‡æ–™</div>
          </div>
          <div class="info-items-row">
            <div class="info-item">
              <h3>å§“å</h3>
              <p id="dispName">â€”</p>
            </div>
            <div class="info-item">
              <h3>åˆ†ç´š</h3>
              <p id="dispGroup">â€”</p>
            </div>
            <div class="info-item">
              <h3>æœ€è¿‘æª¢æ¸¬æ—¥</h3>
              <p id="dispDate">â€”</p>
            </div>
          </div>
        </div>

        <!-- æª¢æ¸¬èªªæ˜å¡ -->
        <div class="info-card">
          <div class="info-card-header">
            <div class="info-card-title">SESSION SUMMARY</div>
            <div class="info-pill">æœ¬æ¬¡æª¢æ¸¬èªªæ˜</div>
          </div>
          <p class="summary-note">
            æœ¬å·¥å…·æœƒæ•´åˆã€Œå­¸å“¡ä¸»è³‡æ–™è¡¨ã€ã€ã€Œæª¢æ¸¬æˆç¸¾ã€èˆ‡ã€Œèª²ç¨‹è¡¨ã€ä¸‰å€‹åˆ†é ï¼Œ
            ä¾ç…§<strong>è¨“ç·´é¡åˆ¥</strong>æŠŠé«”èƒ½æŒ‡æ¨™æ•´ç†åœ¨ä¸€èµ·ï¼Œä¸¦ç”¨åŒä¸€åˆ†ç´šå­¸å“¡çš„å¹³å‡ç•¶åŸºæº–ï¼Œ
            å¹«åŠ©æ•™ç·´ä¸€çœ¼çœ‹å‡ºï¼šå“ªå¹¾å€‹é¡åˆ¥å·²ç¶“æ˜é¡¯é ˜å…ˆã€å“ªå¹¾å€‹éœ€è¦æ‹‰ä¸€æŠŠã€‚
          </p>
        </div>
      </div>

      <!-- é›·é”åœ– -->
      <h2 class="section">
        <span class="dot"></span>
        è¨“ç·´é¡åˆ¥é›·é”åˆ†æ
      </h2>
      <p id="radarNote" class="section-subtitle">
        é›·é”åœ–ä»¥ã€Œèª²ç¨‹è¡¨çš„è¨“ç·´é¡åˆ¥ã€ç‚ºä¸€æ ¼ï¼ŒåŒä¸€åˆ†ç´šçš„å¹³å‡å›ºå®šè¦–ç‚º 50 åˆ†ï¼›
        æ¯é«˜ä¸€å€‹æ¨™æº–å·®ç´„ +10 åˆ†ï¼ˆåä¹‹ -10 åˆ†ï¼‰ï¼Œå¯ä»¥å¿«é€Ÿçœ‹å‡ºé€™ä½å­¸å“¡åœ¨å“ªäº›é¡åˆ¥ç‰¹åˆ¥çªå‡ºã€‚
      </p>
      <div class="chart-wrapper">
        <div class="chart-legend-inline">
          <span class="legend-item">
            <span class="legend-swatch player"></span>
            <span>å­¸å“¡åœ¨å„è¨“ç·´é¡åˆ¥çš„åˆ†æ•¸ï¼ˆ0â€“100ï¼‰</span>
          </span>
          <span class="legend-item">
            <span class="legend-swatch group"></span>
            <span>åŒä¸€åˆ†ç´šå¹³å‡ï¼ˆåŸºæº– 50 åˆ†ï¼‰</span>
          </span>
        </div>
        <div class="chart-container">
          <canvas id="radarChart"></canvas>
        </div>
      </div>

      <!-- æ•™ç·´çŸ­è©• -->
      <h2 class="section green">
        <span class="dot"></span>
        æ•™ç·´å»ºè­°èˆ‡çŸ­è©•
      </h2>
      <div class="coach-box">
        <p id="coachComment">
          è«‹å…ˆé¸æ“‡å­¸å“¡ï¼Œç³»çµ±æœƒä¾ç…§ã€Œè¨“ç·´é¡åˆ¥ã€èˆ‡ã€ŒåŒåˆ†ç´šå¹³å‡ã€çš„å·®è·ï¼Œè‡ªå‹•æ•´ç†å¼·é …èˆ‡å»ºè­°è£œå¼·æ–¹å‘ã€‚
        </p>
      </div>

      <!-- å°ç…§è¡¨ -->
      <h2 class="section" style="margin-top:26px;">
        <span class="dot"></span>
        æœ¬æ¬¡æª¢æ¸¬æˆç¸¾èˆ‡åŒåˆ†ç´šå¹³å‡å°ç…§
      </h2>
      <p class="section-subtitle">
        ä¸‹è¡¨åˆ—å‡ºæ‰€æœ‰é«”èƒ½æŒ‡æ¨™åŸå§‹æˆç¸¾ï¼Œä¸¦èˆ‡<strong>åŒä¸€åˆ†ç´šå­¸å“¡çš„å¹³å‡</strong>æ¯”è¼ƒã€‚
        Z åˆ†æ•¸ç´„ä»‹æ–¼ -0.5 ï½ +0.5 è¦–ç‚ºæ¥è¿‘çµ„å…§å¹³å‡ï¼›â‰¥ +1 ç‚ºæ˜é¡¯å„ªå‹¢ï¼›â‰¤ -0.5 å‰‡å»ºè­°åˆ—ç‚ºå„ªå…ˆè£œå¼·ã€‚
      </p>
      <table>
        <thead>
        <tr>
          <th>æŒ‡æ¨™</th>
          <th>å­¸ç”Ÿ</th>
          <th>åŒç´šå¹³å‡</th>
          <th>SD</th>
          <th>Z åˆ†æ•¸</th>
          <th>è©•ä¼°</th>
        </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <!-- PDF æŒ‰éˆ• -->
      <div class="actions-row">
        <button class="btn-pdf" id="pdfBtn" onclick="exportPDF()">ğŸ“„ ä¸‹è¼‰ PDF å ±å‘Š</button>
      </div>
    </section>
  </div>
</div>

<script>
  // ========= è©¦ç®—è¡¨è¨­å®š =========
  const FILE_ID = "1N-8HQZaxHYj4vE824raG1fWyNxt5w7B9_m8oHn8f4As";
  const SHEETS = {
    players: "å­¸å“¡ä¸»è³‡æ–™è¡¨",
    tests:   "æª¢æ¸¬æˆç¸¾",
    courses: "èª²ç¨‹è¡¨"       // âœ… å¾èª²ç¨‹è¡¨æŠ“è¨“ç·´é¡åˆ¥
  };

  // è¦–ç‚ºã€Œèº«ä»½ï¼å‚™è¨»ã€æ¬„ä½ï¼Œä¸æ‹¿ä¾†ç®—æˆç¸¾
  const IDENTITY_KEYS = new Set([
    "å§“å","æ€§åˆ¥","å¹´é½¡","åˆ†ç´š","ç”Ÿæ—¥","æ—¥æœŸ","æ¸¬é©—æ—¥æœŸ",
    "å‚·ç—…ï¼é™åˆ¶","å‚·å‹¢ï¼é™åˆ¶","å‚·å‹¢/é™åˆ¶","ç›®æ¨™",
    "ä¸€é€±å¯ä¸Šèª²æ™‚æ®µ","è¯çµ¡æ–¹å¼","å‚™è¨»"
  ]);

  // é€™å¹¾ç¨®é—œéµå­—ï¼šæ•¸å€¼è¶Šå°è¶Šå¥½ï¼ˆä¾‹å¦‚ç§’æ•¸ã€åæ‡‰æ™‚é–“ï¼‰
  const LOWER_BETTER_KEYS = ["10","20","505","åæ‡‰","æ•æ·","è¡åˆº","s","S","ç§’"];

  function isLowerBetter(metricName) {
    return LOWER_BETTER_KEYS.some(k => metricName.includes(k));
  }

  function normalizeMetricName(name) {
    if (!name) return "";
    return String(name)
      .replace(/ï¼ˆ/g,"(").replace(/ï¼‰/g,")")
      .replace(/\s+/g,"")
      .trim();
  }

  function csvUrlForSheet(sheetName) {
    return `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  }

  function parseNumber(v) {
    if (v == null || v === "") return null;
    const n = Number(String(v).replace(/[^\d.\-]/g,""));
    return isNaN(n) ? null : n;
  }

  function zToScore(z) {
    const s = 50 + z * 10;
    return Math.max(0, Math.min(100, s));
  }

  let playersByName      = new Map();
  let testsArray         = [];
  let testsByName        = new Map();
  let metricCategoryMap  = new Map(); // æ¨™æº–åŒ–å¾ŒæŒ‡æ¨™å â†’ è¨“ç·´é¡åˆ¥
  let groupMetricStats   = new Map(); // åˆ†ç´š â†’ { normMetricName: {mean, sd, label, category} }
  let radarChart         = null;

  function loadSheet(sheetName) {
    const url = csvUrlForSheet(sheetName);
    return new Promise((resolve, reject) => {
      Papa.parse(url, {
        download: true,
        header: true,
        complete: results => resolve(results.data),
        error: err => reject(err)
      });
    });
  }

  // ä¾åˆ†ç´š + æŒ‡æ¨™ï¼Œè¨ˆç®—å¹³å‡èˆ‡ SDï¼ˆåŒä¸€åˆ†ç´šå…§ï¼‰
  function buildGroupMetricStats() {
    const groupMetricValues = new Map(); // group â†’ Map(normMetricName â†’ {values:[], label, category})

    testsArray.forEach(row => {
      const name = (row["å§“å"] || "").trim();
      if (!name) return;

      const playerRow = playersByName.get(name) || {};
      const group = (playerRow["åˆ†ç´š"] || row["åˆ†ç´š"] || "").trim() || "-";

      let metricMap = groupMetricValues.get(group);
      if (!metricMap) {
        metricMap = new Map();
        groupMetricValues.set(group, metricMap);
      }

      Object.keys(row).forEach(key => {
        if (!key || IDENTITY_KEYS.has(key)) return;

        const normKey = normalizeMetricName(key);
        if (!metricCategoryMap.has(normKey)) return; // åªåƒèª²ç¨‹è¡¨è£¡æœ‰è¨­å®šçš„æŒ‡æ¨™

        const val = parseNumber(row[key]);
        if (val == null) return;

        let metric = metricMap.get(normKey);
        if (!metric) {
          metric = {
            values: [],
            label: key,
            category: metricCategoryMap.get(normKey)
          };
          metricMap.set(normKey, metric);
        }
        metric.values.push(val);
      });
    });

    groupMetricStats = new Map();

    groupMetricValues.forEach((metricMap, group) => {
      const statMap = {};
      metricMap.forEach((m, normKey) => {
        const vals = m.values;
        if (!vals.length) return;
        const mean = vals.reduce((a,b)=>a+b,0) / vals.length;
        const variance = vals.reduce((a,b)=>a+Math.pow(b-mean,2),0) / vals.length;
        const sd = Math.sqrt(variance);

        statMap[normKey] = {
          mean,
          sd,
          label: m.label,
          category: m.category
        };
      });
      groupMetricStats.set(group, statMap);
    });
  }

  async function reloadSheets() {
    const status = document.getElementById("statusMsg");
    const select = document.getElementById("studentSelect");
    const report = document.getElementById("report");

    status.textContent = "å¾ Google è©¦ç®—è¡¨è¼‰å…¥ä¸­â€¦";
    select.disabled = true;
    select.innerHTML = '<option value="">è³‡æ–™è¼‰å…¥ä¸­...</option>';
    report.style.display = "none";

    try {
      const [players, tests, courses] = await Promise.all([
        loadSheet(SHEETS.players),
        loadSheet(SHEETS.tests),
        loadSheet(SHEETS.courses)
      ]);

      // 1) å­¸å“¡è¡¨
      playersByName = new Map();
      players.forEach(row => {
        const n = (row["å§“å"] || "").trim();
        if (!n) return;
        playersByName.set(n, row);
      });

      // 2) æª¢æ¸¬æˆç¸¾
      testsArray = tests;
      testsByName = new Map();
      testsArray.forEach(row => {
        const n = (row["å§“å"] || "").trim();
        if (!n) return;
        testsByName.set(n, row); // ç›®å‰ä¸€ä½å­¸å“¡ä¸€è¡Œ
      });

      // 3) èª²ç¨‹è¡¨ï¼šå»ºç«‹ã€Œæ¨™æº–åŒ–æŒ‡æ¨™å â†’ è¨“ç·´é¡åˆ¥ã€å°ç…§
      metricCategoryMap = new Map();
      courses.forEach(row => {
        const metricName = (row["è¨“ç·´åç¨±"] || "").trim();
        const category   = (row["è¨“ç·´é¡åˆ¥"] || "").trim();
        if (!metricName || !category) return;
        const normName = normalizeMetricName(metricName);
        metricCategoryMap.set(normName, category);
      });

      // 4) é å…ˆç®—å¥½å„åˆ†ç´š + æŒ‡æ¨™ çš„å¹³å‡èˆ‡ SD
      buildGroupMetricStats();

      // ä¸‹æ‹‰é¸å–®
      const names = Array.from(testsByName.keys()).sort((a,b) =>
        a.localeCompare(b, "zh-Hant")
      );
      select.innerHTML = '<option value="">â€” è«‹é¸æ“‡å­¸å“¡ â€”</option>';
      names.forEach(n => {
        const op = document.createElement("option");
        op.value = n;
        op.textContent = n;
        select.appendChild(op);
      });
      select.disabled = false;

      status.textContent = "è¼‰å…¥å®Œæˆï¼Œè«‹å¾ä¸Šæ–¹é¸æ“‡å­¸å“¡ã€‚";
    } catch (err) {
      console.error(err);
      status.textContent =
        "è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªï¼šè©¦ç®—è¡¨å·²å…¬é–‹ï¼Œä¸”åˆ†é åç¨±ç‚ºã€Œå­¸å“¡ä¸»è³‡æ–™è¡¨ / æª¢æ¸¬æˆç¸¾ / èª²ç¨‹è¡¨ã€ã€‚";
    }
  }

  reloadSheets();

  function loadStudentData() {
    const name   = document.getElementById("studentSelect").value;
    const report = document.getElementById("report");
    const status = document.getElementById("statusMsg");
    const radarNote = document.getElementById("radarNote");
    const canvas = document.getElementById("radarChart");

    if (!name) {
      report.style.display = "none";
      return;
    }

    const testRow   = testsByName.get(name);
    const playerRow = playersByName.get(name) || {};
    if (!testRow) {
      status.textContent = `ã€Œ${name}ã€æ‰¾ä¸åˆ°æª¢æ¸¬æˆç¸¾ã€‚`;
      report.style.display = "none";
      return;
    }

    const group = (playerRow["åˆ†ç´š"] || testRow["åˆ†ç´š"] || "").trim() || "-";
    const groupStats = groupMetricStats.get(group) || {};

    document.getElementById("dispName").textContent  = name;
    document.getElementById("dispGroup").textContent = group || "-";
    const date =
      playerRow["æœ€æ–°æª¢æ¸¬æ—¥"] ||
      testRow["æ—¥æœŸ"] ||
      testRow["æ¸¬é©—æ—¥æœŸ"] ||
      "";
    document.getElementById("dispDate").textContent = date || "-";

    // æ¯ä¸€å€‹ã€Œæª¢æ¸¬æŒ‡æ¨™ã€çš„è³‡æ–™ & Z åˆ†æ•¸
    const metricRows = [];
    Object.keys(testRow).forEach(key => {
      if (!key || IDENTITY_KEYS.has(key)) return;

      const normKey = normalizeMetricName(key);
      if (!metricCategoryMap.has(normKey)) return; // åªåƒèª²ç¨‹è¡¨è£¡æœ‰è¨­å®šçš„æŒ‡æ¨™
      if (key.includes("æ¨™æº–å·®") || key.toUpperCase().includes("SD") || key.includes("èª¤å·®")) return;

      const latest = parseNumber(testRow[key]);
      if (latest == null) return;

      const category = metricCategoryMap.get(normKey) || "å…¶ä»–è¨“ç·´";
      const stat     = groupStats[normKey] || {};

      const mean = stat.mean ?? null;
      const sd   = stat.sd   ?? null;

      let z = null;
      let score = null;

      if (mean != null && sd != null && sd !== 0) {
        const lowerBetter = isLowerBetter(key);
        // åŒä¸€åˆ†ç´šå…§ï¼šå¹³å‡ Z = 0ï¼›ç§’æ•¸é¡ç”¨ mean - val è®“ã€Œè¶Šå°è¶Šå¥½ã€è®Šæˆæ­£å‘
        z = lowerBetter ? (mean - latest) / sd : (latest - mean) / sd;
        score = zToScore(z);
      }

      metricRows.push({
        label: key,
        category,
        latest,
        mean,
        sd,
        z,
        score
      });
    });

    if (!metricRows.length) {
      status.textContent =
        `ã€Œ${name}ã€çš„æª¢æ¸¬æˆç¸¾ç›®å‰æ²’æœ‰å°æ‡‰åˆ°èª²ç¨‹è¡¨çš„æŒ‡æ¨™ï¼Œè«‹æª¢æŸ¥ã€Œèª²ç¨‹è¡¨ã€èˆ‡ã€Œæª¢æ¸¬æˆç¸¾ã€æ¬„ä½åç¨±æ˜¯å¦ä¸€è‡´ã€‚`;
      report.style.display = "none";
      return;
    }

    // ====== é›·é”åœ–è³‡æ–™ï¼šä»¥ã€Œè¨“ç·´é¡åˆ¥ã€ç‚ºç¶­åº¦ ======
    let radarLabels = [];
    let radarPlayer = [];
    let radarGroup  = [];

    const scoredRows = metricRows.filter(r => r.score != null);

    if (scoredRows.length) {
      // æœ‰åŒç´šå¹³å‡ & SDï¼Œå¯æ­£å¼ç”¨ Z â†’ 0â€“100 åˆ†
      const catMap = new Map(); // category â†’ {sumScore, count}
      scoredRows.forEach(r => {
        const cat = r.category;
        let agg = catMap.get(cat);
        if (!agg) {
          agg = {sumScore: 0, count: 0};
          catMap.set(cat, agg);
        }
        agg.sumScore += r.score;
        agg.count++;
      });

      radarLabels = Array.from(catMap.keys());
      radarPlayer = radarLabels.map(cat => {
        const agg = catMap.get(cat);
        return Math.round(agg.sumScore / agg.count);
      });
      // åŒç´šå¹³å‡ = 50 åˆ†åŸºæº–
      radarGroup = radarLabels.map(() => 50);

      radarNote.textContent =
        "é›·é”åœ–ä»¥ã€Œè¨“ç·´é¡åˆ¥ã€ç‚ºå–®ä½ï¼ŒåŒåˆ†ç´šå­¸å“¡çš„å¹³å‡è¦–ç‚º 50 åˆ†ï¼Œæ¯å¤šä¸€å€‹æ¨™æº–å·®ç´„ +10 åˆ†ã€‚åˆ†æ•¸é«˜çš„é¡åˆ¥ä»£è¡¨åœ¨åŒåˆ†ç´šè£¡ç›¸å°æ›´çªå‡ºã€‚";
    } else {
      // åŒåˆ†ç´šæ¨£æœ¬å¤ªå°‘ï¼Œç®—ä¸å‡º SDï¼šé€€å›ã€Œé€™æ‰¹æ•¸æ“šä¸­çš„ç›¸å°è¡¨ç¾ã€åš 0â€“100 åˆ†
      const processed = metricRows.map(r => {
        let v = r.latest;
        if (isLowerBetter(r.label)) v = -v;
        return { category: r.category, value: v };
      });
      const values = processed.map(p => p.value);
      const minVal = Math.min(...values);
      const maxVal = Math.max(...values);

      const catMap = new Map(); // category â†’ {sumScore, count}
      processed.forEach(p => {
        let normScore;
        if (maxVal === minVal) normScore = 50;
        else normScore = ((p.value - minVal) / (maxVal - minVal)) * 100;

        let agg = catMap.get(p.category);
        if (!agg) {
          agg = {sumScore: 0, count: 0};
          catMap.set(p.category, agg);
        }
        agg.sumScore += normScore;
        agg.count++;
      });

      radarLabels = Array.from(catMap.keys());
      radarPlayer = radarLabels.map(cat => {
        const agg = catMap.get(cat);
        return Math.round(agg.sumScore / agg.count);
      });
      radarGroup = radarLabels.map(() => 50);

      radarNote.textContent =
        "ç›®å‰åŒåˆ†ç´šæ¨£æœ¬æ•¸è¼ƒå°‘ï¼Œæš«æ™‚ç”¨é€™æ¬¡æ‰€æœ‰æŒ‡æ¨™çš„ç›¸å°è¡¨ç¾æ›ç®—æˆ 0â€“100 åˆ†ï¼›åŒç´šå¹³å‡ä¾ç„¶ä»¥ 50 åˆ†åšåŸºæº–åœˆã€‚";
    }

    const ctx = canvas.getContext("2d");
    if (radarChart) radarChart.destroy();

    if (radarLabels.length === 0) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    } else {
      radarChart = new Chart(ctx, {
        type: "radar",
        data: {
          labels: radarLabels,
          datasets: [
            {
              label: name,
              data: radarPlayer,
              backgroundColor: "rgba(34,197,94,0.22)",
              borderColor: "rgba(34,197,94,1)",
              pointBackgroundColor: "rgba(56,189,248,1)",
              borderWidth: 2,
              pointRadius: 3
            },
            {
              label: `${group} åŒç´šå¹³å‡`,
              data: radarGroup,
              backgroundColor: "rgba(148,163,184,0.10)",
              borderColor: "rgba(148,163,184,0.9)",
              pointBackgroundColor: "rgba(148,163,184,1)",
              borderWidth: 1.5,
              pointRadius: 2
            }
          ]
        },
        options: {
          scales: {
            r: {
              beginAtZero: true,
              suggestedMax: 100,
              ticks: { display: false },
              grid: { color: "#1f2937" },
              angleLines: { color: "#1f2937" },
              pointLabels: { font: { size: 11 }, color: "#e5e7eb" }
            }
          },
          plugins: {
            legend: { labels: { font: { size: 11 }, color: "#e5e7eb" } }
          }
        }
      });
    }

    // ====== ä¸‹æ–¹è¡¨æ ¼ï¼šæ¯ä¸€å€‹æŒ‡æ¨™ vs åŒç´šå¹³å‡ ======
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    metricRows
      .slice()
      .sort((a,b) => {
        if (a.z == null && b.z == null) return 0;
        if (a.z == null) return 1;
        if (b.z == null) return -1;
        return b.z - a.z;
      })
      .forEach(row => {
        const tr = document.createElement("tr");
        let tagHtml = "â€”";
        if (row.z != null) {
          if (row.z >= 1) tagHtml = '<span class="tag good">å„ªæ–¼åŒç´š</span>';
          else if (row.z <= -0.5)
            tagHtml = '<span class="tag bad">å»ºè­°è£œå¼·</span>';
          else tagHtml = '<span class="tag mid">æ¥è¿‘åŒç´š</span>';
        }
        tr.innerHTML = `
          <td>${row.label}</td>
          <td>${row.latest ?? "â€”"}</td>
          <td>${row.mean != null ? row.mean.toFixed(2) : "â€”"}</td>
          <td>${row.sd != null ? row.sd.toFixed(2) : "â€”"}</td>
          <td>${row.z != null ? row.z.toFixed(2) : "â€”"}</td>
          <td>${tagHtml}</td>
        `;
        tbody.appendChild(tr);
      });

    // ====== æ•™ç·´çŸ­è©• ======
    const strengths = metricRows
      .filter(r => r.z != null && r.z >= 1)
      .sort((a,b) => b.z - a.z)
      .slice(0,3);
    const weaknesses = metricRows
      .filter(r => r.z != null && r.z <= -0.5)
      .sort((a,b) => a.z - b.z)
      .slice(0,3);

    const listText = arr =>
      !arr.length
        ? "ç›®å‰å„æŒ‡æ¨™å¤§è‡´æ¥è¿‘åŒç´šå¹³å‡ï¼Œæ²’æœ‰ç‰¹åˆ¥çªå‡ºçš„å¼·é …æˆ–å¼±é …ã€‚"
        : arr.map(r => `${r.label}ï¼ˆZ = ${r.z.toFixed(2)}ï¼‰`).join("ã€");

    let comment = "";
    if (metricRows.some(r => r.z != null)) {
      comment = `
        æ ¹æ“šæœ¬æ¬¡æª¢æ¸¬æ•¸æ“šï¼Œ<strong>${name}</strong> èˆ‡ã€Œ${group || "ç›®å‰åˆ†ç´š"}ã€åŒç´šå­¸å“¡ç›¸æ¯”ï¼š
        <br><br>
        ãƒ»ä¸»è¦<strong>å„ªå‹¢æŒ‡æ¨™</strong>ï¼š${listText(strengths)}ã€‚<br>
        ãƒ»å»ºè­°å„ªå…ˆ<strong>è£œå¼·æŒ‡æ¨™</strong>ï¼š${listText(weaknesses)}ã€‚<br><br>
        è¨“ç·´è¦åŠƒä¸Šï¼Œå¯ä»¥æŠŠè£œå¼·æŒ‡æ¨™æ‰€åœ¨çš„è¨“ç·´é¡åˆ¥æ’å…¥æ¯é€±å›ºå®šèª²è¡¨ï¼Œ
        ä¾‹å¦‚åœ¨æš–èº«ä¹‹å¾Œå®‰æ’ 1ï½2 å€‹å°ˆé …é«”èƒ½çµ„åˆï¼ŒåŒæ™‚ç¶­æŒå„ªå‹¢æŒ‡æ¨™çš„ç©©å®šåº¦ï¼Œ
        è®“é¸æ‰‹åœ¨æ¯”è³½ä¸­æ›´å®¹æ˜“æŠŠå„ªå‹¢èƒ½åŠ›æ‰“å‡ºä¾†ã€‚
      `;
    } else {
      comment = `
        ç›®å‰åŒç´šæ¨£æœ¬æ•¸è¼ƒå°‘ï¼Œæš«æ™‚ç„¡æ³•è¨ˆç®— Z åˆ†æ•¸ã€‚<br><br>
        å°±æœ¬æ¬¡æª¢æ¸¬åŸå§‹æˆç¸¾ä¾†çœ‹ï¼Œ<strong>${name}</strong> åœ¨å¤šæ•¸é …ç›®ä¸Šçš„è¡¨ç¾ç©©å®šï¼Œ
        å»ºè­°æ•™ç·´å…ˆå¾ã€Œèª²ç¨‹è¡¨ã€ä¸­æŒ‘å‡º 2ï½3 å€‹æƒ³è¦æ˜é¡¯æ‹‰é–‹å·®è·çš„è¨“ç·´é¡åˆ¥ï¼Œ
        ä½œç‚ºä¸‹ä¸€éšæ®µè¨“ç·´ä¸»è»¸ï¼Œä¸¦æŒçºŒè¨˜éŒ„å¾ŒçºŒæª¢æ¸¬çµæœä»¥è¿½è¹¤è®ŠåŒ–ã€‚
      `;
    }
    document.getElementById("coachComment").innerHTML = comment;

    status.textContent = "";
    report.style.display = "block";
  }

  // ========= ç”¢ç”Ÿ PDF =========
  async function exportPDF() {
    const report = document.getElementById("report");
    if (report.style.display === "none" || !report.innerText.trim()) {
      alert("è«‹å…ˆé¸æ“‡ä¸€ä½å­¸å“¡ä¸¦ç”¢ç”Ÿå ±å‘Šï¼Œå†ä¸‹è¼‰ PDFã€‚");
      return;
    }

    const btn = document.getElementById("pdfBtn");
    const name = document.getElementById("dispName").textContent || "report";
    btn.disabled = true;
    btn.textContent = "ç”¢ç”Ÿ PDF ä¸­â€¦";

    try {
      const pdfArea = document.getElementById("pdfArea");

      const canvas = await html2canvas(pdfArea, {
        scale: 2,
        backgroundColor: "#020617",
        useCORS: true
      });

      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");

      const pageWidth  = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgWidth  = pageWidth;
      const imgHeight = canvas.height * imgWidth / canvas.width;

      let position   = 0;
      let heightLeft = imgHeight;

      pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight, "", "FAST");
      heightLeft -= pageHeight;

      while (heightLeft > 0) {
        position -= pageHeight;
        pdf.addPage();
        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight, "", "FAST");
        heightLeft -= pageHeight;
      }

      pdf.save(`AthleteReport-${name}.pdf`);
    } catch (err) {
      console.error(err);
      alert("ç”¢ç”Ÿ PDF æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    } finally {
      btn.disabled = false;
      btn.textContent = "ğŸ“„ ä¸‹è¼‰ PDF å ±å‘Š";
    }
  }
</script>
</body>
</html>
