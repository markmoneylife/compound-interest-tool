<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é«”èƒ½æª¢æ¸¬å ±å‘Šç”¢ç”Ÿå™¨ï½œæ•™ç·´ç”¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js ç”¨ä¾†ç•«é›·é”åœ– -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- html2pdf.js ç”¨ä¾†æŠŠå ±å‘Šè½‰æˆ PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --bg-main: #0b1120;
      --bg-card: #111827;
      --accent: #1d4ed8;
      --accent-soft: rgba(37, 99, 235, 0.12);
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --danger: #f97373;
      --warning: #facc15;
      --success: #4ade80;
      --border-soft: #1f2937;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI",
        sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text-main);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 1.5rem;
      gap: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    @media (min-width: 960px) {
      .app-shell {
        padding: 2.5rem 1.5rem;
      }
    }

    .app-header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .app-title {
      font-size: clamp(1.5rem, 2.2vw, 1.9rem);
      font-weight: 700;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .app-title span.badge {
      font-size: 0.8rem;
      padding: 0.18rem 0.55rem;
      border-radius: 999px;
      background: rgba(59,130,246,0.12);
      border: 1px solid rgba(59,130,246,0.35);
      color: #93c5fd;
    }

    .app-subtitle {
      font-size: 0.9rem;
      color: var(--text-sub);
      max-width: 640px;
    }

    .control-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end;
      padding: 1rem 1.25rem;
      border-radius: 0.9rem;
      background: linear-gradient(
          135deg,
          rgba(37, 99, 235, 0.16),
          rgba(15, 23, 42, 0.96)
      );
      border: 1px solid rgba(59, 130, 246, 0.4);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      min-width: 200px;
    }

    .field-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--text-sub);
    }

    select,
    button {
      font-family: inherit;
    }

    select {
      padding: 0.55rem 0.75rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 0.9rem;
      min-width: 220px;
      outline: none;
    }

    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.65);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .btn {
      padding: 0.55rem 1.15rem;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.88rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
      background: var(--accent);
      color: #e5e7eb;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.55);
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 35px rgba(37, 99, 235, 0.65);
      background: #2563eb;
    }

    .btn.secondary {
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      border-color: rgba(148, 163, 184, 0.6);
      box-shadow: none;
    }

    .btn.secondary:hover {
      background: rgba(30, 64, 175, 0.45);
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 8px 25px rgba(15, 23, 42, 0.8);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    /* å ±å‘Šæœ¬é«”å®¹å™¨ï¼ˆPDF æœƒæŠ“é€™ä¸€å¡Šï¼‰ */
    .report-shell {
      margin-top: 0.5rem;
      padding: 1.25rem;
      border-radius: 1rem;
      background: radial-gradient(circle at top left, #111827 0, #020617 50%, #000 100%);
      border: 1px solid var(--border-soft);
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.85);
    }

    /* ç‚ºäº†è®“ PDF çœ‹èµ·ä¾†åƒ A4ï¼Œé™åˆ¶å¯¬åº¦ */
    .report-page {
      max-width: 900px;
      margin: 0 auto;
      background: #020617;
      padding: 1.5rem 1.75rem;
      border-radius: 0.75rem;
      border: 1px solid #111827;
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #1f2937;
      padding-bottom: 0.75rem;
    }

    .report-header-main {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .report-title {
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .report-subtitle {
      font-size: 0.8rem;
      color: var(--text-sub);
    }

    .report-header-meta {
      text-align: right;
      font-size: 0.8rem;
      color: var(--text-sub);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      background: rgba(30,64,175,0.35);
      color: #bfdbfe;
      border: 1px solid rgba(59,130,246,0.7);
      font-size: 0.75rem;
    }

    .grid-two {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .grid-two {
        grid-template-columns: minmax(0, 1fr);
      }
      .report-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .report-header-meta {
        text-align: left;
      }
    }

    .card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 0.75rem;
      border: 1px solid var(--border-soft);
      padding: 0.85rem 1rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.45rem;
    }

    .card-title {
      font-size: 0.92rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .card-tag {
      font-size: 0.78rem;
      color: var(--text-sub);
    }

    .info-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.86rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.25rem 0.75rem;
    }

    .info-list li span.label {
      color: var(--text-sub);
      margin-right: 0.2rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      background: rgba(15, 23, 42, 0.9);
    }

    th, td {
      padding: 0.28rem 0.3rem;
      border-bottom: 1px solid #111827;
      text-align: right;
      white-space: nowrap;
    }

    th:first-child, td:first-child {
      text-align: left;
    }

    th {
      font-weight: 600;
      color: #9ca3af;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.72rem;
      border: 1px solid transparent;
    }

    .chip.good {
      color: #bbf7d0;
      border-color: rgba(74, 222, 128, 0.8);
      background: rgba(22, 163, 74, 0.15);
    }

    .chip.ok {
      color: #fee2e2;
      border-color: rgba(250, 204, 21, 0.85);
      background: rgba(250, 204, 21, 0.12);
    }

    .chip.bad {
      color: #fecaca;
      border-color: rgba(248, 113, 113, 0.9);
      background: rgba(248, 113, 113, 0.14);
    }

    .trend-up {
      color: var(--success);
      font-weight: 600;
    }
    .trend-down {
      color: var(--danger);
      font-weight: 600;
    }

    .note {
      font-size: 0.77rem;
      color: var(--text-sub);
      margin-top: 0.3rem;
    }

    .radar-wrapper {
      position: relative;
      height: 260px;
    }

    .section-title {
      margin: 0.9rem 0 0.35rem;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    .coach-notes {
      font-size: 0.86rem;
      line-height: 1.5;
      color: #e5e7eb;
    }

    .coach-notes ul {
      margin: 0.15rem 0 0;
      padding-left: 1.1rem;
    }

    .coach-notes li {
      margin-bottom: 0.15rem;
    }

    .muted {
      color: var(--text-sub);
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="app-title">
      é«”èƒ½æª¢æ¸¬å ±å‘Šç”¢ç”Ÿå™¨
      <span class="badge">æ•™ç·´ä¸­å¿ƒ Â· Internal</span>
    </div>
    <p class="app-subtitle">
      å¾ Google Sheets è‡ªå‹•æŠ“å­¸å“¡è³‡æ–™èˆ‡æ¸¬é©—æˆç¸¾ï¼Œå°æ¯”åœ‹éš›æ¨™æº–ä¸¦ç”Ÿæˆ PDF å ±å‘Šã€‚å»ºè­°å…ˆåœ¨é›»è…¦ç‰ˆä½¿ç”¨ã€‚
    </p>
  </header>

  <section class="control-panel">
    <div class="field-group">
      <label class="field-label" for="playerSelect">é¸æ“‡å­¸å“¡</label>
      <select id="playerSelect">
        <option value="">è«‹å…ˆè¼‰å…¥è³‡æ–™...</option>
      </select>
    </div>
    <div class="btn-row">
      <button class="btn secondary" id="reloadBtn">é‡æ–°è¼‰å…¥ Google Sheets</button>
      <button class="btn" id="loadReportBtn" disabled>ç”¢ç”Ÿå ±å‘Š</button>
      <button class="btn secondary" id="pdfBtn" disabled>ä¸‹è¼‰ PDF</button>
    </div>
  </section>

  <section class="report-shell">
    <div id="reportPage" class="report-page">
      <!-- å ±å‘Šå…§å®¹ç”± JS å‹•æ…‹å¡å…¥ -->
      <p class="muted" id="placeholder">
        ğŸ‘‹ è«‹å…ˆæŒ‰ã€Œé‡æ–°è¼‰å…¥ Google Sheetsã€ï¼Œé¸æ“‡å­¸å“¡å¾Œå†é»ã€Œç”¢ç”Ÿå ±å‘Šã€ã€‚
      </p>
    </div>
  </section>
</div>

<script>
  /********************************************************
   * 1. æŠŠé€™ä¸‰å€‹ CSV ç¶²å€æ”¹æˆä½ è‡ªå·± Google Sheets ã€Œç™¼ä½ˆç‚ºç¶²é ã€çš„é€£çµ
   ********************************************************/

  const CSV_URLS = {
    // âœ… æª¢æ¸¬æˆç¸¾ï¼šä½ å‰›å‰›è²¼çš„é€™ä¸€å€‹ï¼ˆæˆ–æ›´æ–°å¾Œçš„ï¼‰
    tests: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRf7j8dcLkA4mObkmT5fF1S7lrgm5f0PPtzda0Hzhwbzo1jOCgxe2oTmF53NK04kshuJJapUIy6SJEe/pub?output=csv",

    // âœ… å­¸å“¡ä¸»è³‡æ–™è¡¨ï¼šè«‹åˆ°ã€Œå­¸å“¡ä¸»è³‡æ–™è¡¨ã€åˆ†é ï¼Œç™¼ä½ˆç‚º CSVï¼Œè²¼ä¸Šç¶²å€
    players: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRf7j8dcLkA4mObkmT5fF1S7lrgm5f0PPtzda0Hzhwbzo1jOCgxe2oTmF53NK04kshuJJapUIy6SJEe/pub?output=csv",

    // âœ… åœ‹éš›æ¨™æº–åˆ†é ï¼šåˆ°ã€Œåœ‹éš›æ¨™æº–ã€åˆ†é ç™¼ä½ˆï¼Œè²¼ä¸Šç¶²å€
    intl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRf7j8dcLkA4mObkmT5fF1S7lrgm5f0PPtzda0Hzhwbzo1jOCgxe2oTmF53NK04kshuJJapUIy6SJEe/pub?output=csv"
  };

  /********************************************************
   * 2. å…±ç”¨å°å·¥å…·ï¼šæŠ“ CSVã€æ•¸å­—è™•ç†
   ********************************************************/

  async function fetchCsv(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error("ç„¡æ³•è®€å– CSVï¼š" + url);
    return await res.text();
  }

  function parseCsv(text) {
    // ç°¡æ˜“ç‰ˆ parserï¼šå‡è¨­æ²’æœ‰é€—è™Ÿåœ¨æ¬„ä½å…§
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    if (lines.length === 0) return [];
    const headers = lines[0].split(",").map(h => h.trim());
    return lines.slice(1).map(line => {
      const cols = line.split(",");
      const obj = {};
      headers.forEach((h, idx) => {
        obj[h] = (cols[idx] ?? "").trim();
      });
      return obj;
    });
  }

  function toNumber(v) {
    if (v === null || v === undefined) return null;
    const n = Number(String(v).replace(/[^\d.\-]/g, ""));
    return isNaN(n) ? null : n;
  }

  // å“ªäº›æŒ‡æ¨™æ˜¯ã€Œæ•¸è¶Šå°è¶Šå¥½ã€ï¼ˆæ™‚é–“é¡ï¼‰
  const LOWER_IS_BETTER = ["10ç±³è¡åˆº", "10Mè¡åˆº", "20ç±³è¡åˆº", "20Mè¡åˆº", "505æ•æ·è·‘", "èœ˜è››è·‘", "åæ‡‰æ¸¬è©¦"];

  function isLowerBetter(metricName) {
    return LOWER_IS_BETTER.some(k => metricName.includes(k));
  }

  // æ¨™æº–åŒ–æˆ 0â€“100 çš„è¡¨ç¾åˆ†æ•¸ï¼ˆ50 = æ­£å¸¸ï¼Œ>60 å¥½ï¼Œ<40 å¼±ï¼‰
  function zToScore(z) {
    const score = 50 + z * 10;
    return Math.max(0, Math.min(100, score));
  }

  /********************************************************
   * 3. è®€å–è³‡æ–™ä¸¦æ•´ç†æˆå¥½ç”¨çš„çµæ§‹
   ********************************************************/

  let playersByName = new Map();
  let testsByName = new Map();
  let intlByGroup = new Map();
  let lastLoadedAt = null;

  async function reloadAll() {
    document.getElementById("loadReportBtn").disabled = true;
    document.getElementById("pdfBtn").disabled = true;
    document.getElementById("placeholder").textContent = "è³‡æ–™è®€å–ä¸­â€¦";

    try {
      const [playersCsv, testsCsv, intlCsv] = await Promise.all([
        fetchCsv(CSV_URLS.players),
        fetchCsv(CSV_URLS.tests),
        fetchCsv(CSV_URLS.intl)
      ]);

      const players = parseCsv(playersCsv);
      const tests = parseCsv(testsCsv);
      const intl = parseCsv(intlCsv);

      playersByName = new Map();
      testsByName = new Map();
      intlByGroup = new Map();

      // å­¸å“¡ä¸»è³‡æ–™ï¼šå‡è¨­æœ‰æ¬„ä½ã€Œå§“åã€ã€Œæ€§åˆ¥ã€ã€Œç”Ÿæ—¥ã€ã€Œåˆ†ç´šã€ã€Œå‚·ç—…ï¼é™åˆ¶ã€ã€Œç›®æ¨™ã€ã€Œä¸€é€±å¯ä¸Šèª²æ™‚æ®µã€ã€Œè¯çµ¡æ–¹å¼ã€
      players.forEach(row => {
        const name = row["å§“å"]?.trim();
        if (!name) return;
        playersByName.set(name, row);
      });

      // æ¸¬é©—æˆç¸¾ï¼šç”¨å§“å group èµ·ä¾†ï¼Œä¹‹å¾Œå¯æ“´å……æ—¥æœŸæ¬„ä½
      tests.forEach(row => {
        const name = row["å§“å"]?.trim();
        if (!name) return;
        if (!testsByName.has(name)) testsByName.set(name, []);
        testsByName.get(name).push(row);
      });

      // åœ‹éš›æ¨™æº–ï¼šæ¯ä¸€åˆ—æ˜¯ä¸€å€‹ã€Œåˆ†ç´šã€ï¼ŒHæ¬„æ˜¯å¹³å‡ï¼ŒIæ¬„æ˜¯æ¨™æº–å·®ï¼ˆæœªä¾†å¦‚æœä½ å¤šåŠ æ¬„ä½ä¹Ÿèƒ½æŠ“ï¼‰
      intl.forEach(row => {
        const group = row["åˆ†ç´š"]?.trim();
        if (!group) return;

        const metrics = {};
        Object.keys(row).forEach(h => {
          if (!h || h === "åˆ†ç´š") return;
          if (h.includes("æ¨™æº–å·®")) return; // å…ˆç•¥é SD æ¬„ï¼Œä¸‹é¢ä¸€èµ·è™•ç†
        });

        // å°‹æ‰¾æˆå°æ¬„ä½ï¼šXXX èˆ‡ XXX(æ¨™æº–å·®)
        Object.keys(row).forEach(header => {
          if (!header) return;
          if (header.includes("æ¨™æº–å·®")) {
            const base = header.replace("(æ¨™æº–å·®)", "").trim();
            const mean = toNumber(row[base]);
            const sd = toNumber(row[header]);
            if (mean !== null && sd !== null) {
              metrics[base] = { mean, sd };
            }
          }
        });

        intlByGroup.set(group, metrics);
      });

      // æ›´æ–°ä¸‹æ‹‰é¸å–®
      const selectEl = document.getElementById("playerSelect");
      selectEl.innerHTML = "";
      const optEmpty = document.createElement("option");
      optEmpty.value = "";
      optEmpty.textContent = "è«‹é¸æ“‡å­¸å“¡";
      selectEl.appendChild(optEmpty);

      const allNames = Array.from(new Set([...playersByName.keys(), ...testsByName.keys()]));
      allNames.sort((a, b) => a.localeCompare(b, "zh-Hant"));

      allNames.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        selectEl.appendChild(opt);
      });

      lastLoadedAt = new Date();
      document.getElementById("placeholder").textContent = "è³‡æ–™è¼‰å…¥å®Œæˆï¼Œè«‹å¾ä¸Šæ–¹é¸æ“‡å­¸å“¡ä¸¦æŒ‰ã€Œç”¢ç”Ÿå ±å‘Šã€ã€‚";
      document.getElementById("loadReportBtn").disabled = false;

    } catch (err) {
      console.error(err);
      document.getElementById("placeholder").textContent =
        "è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª CSV ç¶²å€æ˜¯å¦æ­£ç¢ºï¼Œæˆ–ç¨å¾Œå†è©¦ã€‚";
    }
  }

  /********************************************************
   * 4. ç”¢ç”Ÿå–®ä¸€å­¸å“¡çš„å ±å‘Šå…§å®¹
   ********************************************************/

  let radarChartInstance = null;

  function buildReportFor(name) {
    const container = document.getElementById("reportPage");
    container.innerHTML = ""; // æ¸…ç©º

    const playerInfo = playersByName.get(name) || { "å§“å": name };
    const testRows = testsByName.get(name) || [];

    if (testRows.length === 0) {
      container.innerHTML = `<p class="muted">æ‰¾ä¸åˆ°ã€Œ${name}ã€çš„æ¸¬é©—æˆç¸¾ã€‚</p>`;
      document.getElementById("pdfBtn").disabled = true;
      return;
    }

    // ç›®å‰ç­–ç•¥ï¼šç¬¬ä¸€ç­†ç•¶ã€Œå‰æ¸¬ã€ã€æœ€å¾Œä¸€ç­†ç•¶ã€Œå¾Œæ¸¬ã€
    const firstTest = testRows[0];
    const lastTest = testRows[testRows.length - 1];

    const group = lastTest["åˆ†ç´š"] || playerInfo["åˆ†ç´š"] || "";
    const intlMetrics = intlByGroup.get(group) || {};

    /* ====== å ±å‘Š Header ====== */

    const headerEl = document.createElement("div");
    headerEl.className = "report-header";
    headerEl.innerHTML = `
      <div class="report-header-main">
        <div class="report-title">ATHLETIC PERFORMANCE REPORT</div>
        <div class="report-subtitle">çƒå“¡é«”èƒ½æª¢æ¸¬ï½œèˆ‡åœ‹éš›æ¨™æº–å°ç…§</div>
        <span class="pill">åˆ†ç´šï¼š${group || "æœªå¡«"} Â· å°æ¯”åœ‹éš›æ¨£æœ¬</span>
      </div>
      <div class="report-header-meta">
        <div>${new Date().toLocaleDateString("zh-TW")}</div>
        <div>${lastLoadedAt ? "è³‡æ–™æ›´æ–°ï¼š" + lastLoadedAt.toLocaleTimeString("zh-TW") : ""}</div>
      </div>
    `;
    container.appendChild(headerEl);

    /* ====== åŸºæœ¬è³‡æ–™å¡ï¼‹æ‘˜è¦å¡ ====== */

    const gridTop = document.createElement("div");
    gridTop.className = "grid-two";

    const cardProfile = document.createElement("div");
    cardProfile.className = "card";
    cardProfile.innerHTML = `
      <div class="card-header">
        <div class="card-title">PLAYER PROFILE</div>
        <div class="card-tag">å­¸å“¡åŸºæœ¬è³‡æ–™</div>
      </div>
      <ul class="info-list">
        <li><span class="label">å§“åï¼š</span>${playerInfo["å§“å"] || name}</li>
        <li><span class="label">æ€§åˆ¥ï¼š</span>${playerInfo["æ€§åˆ¥"] || lastTest["æ€§åˆ¥"] || "â€”"}</li>
        <li><span class="label">å¹´é½¡ï¼š</span>${playerInfo["å¹´é½¡"] || lastTest["å¹´é½¡"] || "â€”"}</li>
        <li><span class="label">åˆ†ç´šï¼š</span>${group || "â€”"}</li>
        <li><span class="label">ç”Ÿæ—¥ï¼š</span>${playerInfo["ç”Ÿæ—¥"] || "â€”"}</li>
        <li><span class="label">å‚·ç—…ï¼é™åˆ¶ï¼š</span>${playerInfo["å‚·ç—…ï¼é™åˆ¶"] || "â€”"}</li>
        <li><span class="label">è¨“ç·´ç›®æ¨™ï¼š</span>${playerInfo["ç›®æ¨™"] || "â€”"}</li>
        <li><span class="label">è¯çµ¡æ–¹å¼ï¼š</span>${playerInfo["è¯çµ¡æ–¹å¼"] || "â€”"}</li>
      </ul>
    `;

    const cardSummary = document.createElement("div");
    cardSummary.className = "card";
    const totalCount = Object.keys(intlMetrics).length;
    cardSummary.innerHTML = `
      <div class="card-header">
        <div class="card-title">SUMMARY</div>
        <div class="card-tag">æ•™ç·´å¿«é€Ÿç¸½çµ</div>
      </div>
      <div class="coach-notes" id="coachSummary">
        <p class="muted">ç³»çµ±æœƒæ ¹æ“šèˆ‡åœ‹éš›æ¨™æº–çš„å·®ç•°ï¼Œè‡ªå‹•ç”¢ç”Ÿé‡é»æ‘˜è¦èˆ‡å»ºè­°ã€‚</p>
      </div>
    `;

    gridTop.appendChild(cardProfile);
    gridTop.appendChild(cardSummary);
    container.appendChild(gridTop);

    /* ====== æŠŠæ¸¬é©—æŒ‡æ¨™æŠ“å‡ºä¾†ï¼ˆåªç•™æ•¸å­—æ¬„ä½ï¼‰ ====== */

    const identityKeys = new Set(["å§“å", "æ€§åˆ¥", "å¹´é½¡", "åˆ†ç´š", "å‚™è¨»", "æ—¥æœŸ", "æ¸¬é©—æ—¥æœŸ"]);
    const metricNames = [];

    Object.keys(lastTest).forEach(key => {
      if (!key || identityKeys.has(key)) return;
      const val = toNumber(lastTest[key]);
      if (val === null) return;
      metricNames.push(key);
    });

    // ä¾åºå»ºç«‹æ¯”è¼ƒç”¨è³‡æ–™
    const compareRows = [];
    const trendRows = [];
    const intlCompare = [];

    const radarLabels = [];
    const radarPlayerScores = [];
    const radarIntlScores = [];

    const strengths = [];
    const weaknesses = [];

    metricNames.forEach(metric => {
      const latest = toNumber(lastTest[metric]);
      const earliest = toNumber(firstTest[metric]);
      if (latest === null) return;

      const intl = intlMetrics[metric] || null;
      let mean = intl ? intl.mean : null;
      let sd = intl ? intl.sd : null;

      // å‰å¾Œæ¸¬å·®ç•°
      let deltaAbs = null;
      let deltaPct = null;
      if (earliest !== null) {
        const diff = latest - earliest;
        const betterSign = isLowerBetter(metric) ? -1 : 1; // å°ç‚ºä½³ -> ä¸‹é™æ˜¯å¥½
        const trendGood = diff * betterSign < 0;
        const trendText = earliest === 0 ? "â€”" : ((latest - earliest) / earliest * 100).toFixed(1) + "%";
        deltaAbs = diff;
        deltaPct = trendText;

        trendRows.push({
          metric,
          earliest,
          latest,
          diff,
          trendText,
          trendGood
        });
      }

      // åœ‹éš›æ¯”è¼ƒ
      if (mean !== null && sd !== null && sd !== 0) {
        const lowerBetter = isLowerBetter(metric);
        const z = lowerBetter ? (mean - latest) / sd : (latest - mean) / sd;
        const scorePlayer = zToScore(z);
        const scoreIntl = 50; // by definition

        radarLabels.push(metric);
        radarPlayerScores.push(scorePlayer);
        radarIntlScores.push(scoreIntl);

        let level, chipClass;
        if (z >= 1) {
          level = "å„ªæ–¼åœ‹éš›æ¨£æœ¬";
          chipClass = "good";
          strengths.push({ metric, z });
        } else if (z <= -0.5) {
          level = "ä½æ–¼åœ‹éš›æ¨£æœ¬";
          chipClass = "bad";
          weaknesses.push({ metric, z });
        } else {
          level = "æ¥è¿‘åœ‹éš›å¹³å‡";
          chipClass = "ok";
        }

        intlCompare.push({
          metric,
          latest,
          mean,
          sd,
          z,
          level,
          chipClass
        });
      }

      compareRows.push({
        metric,
        latest,
        earliest
      });
    });

    /* ====== é›·é”åœ–å¡ ====== */

    const radarCard = document.createElement("div");
    radarCard.className = "card";
    radarCard.style.marginTop = "0.75rem";
    radarCard.innerHTML = `
      <div class="card-header">
        <div class="card-title">PERFORMANCE PROFILE</div>
        <div class="card-tag">å­¸ç”Ÿ vs åœ‹éš›æ¨™æº– Â· æ¨™æº–åŒ–åˆ†æ•¸</div>
      </div>
      <div class="radar-wrapper">
        <canvas id="radarChart"></canvas>
      </div>
      <p class="note">åˆ†æ•¸ç¶“æ¨™æº–åŒ–è™•ç†ï¼ˆç´„ 0â€“100ï¼‰ã€‚50 ç´„ç•¥ä»£è¡¨åœ‹éš›å¹³å‡ï¼Œ>60 ç‚ºå¼·é …ï¼Œ<40 å»ºè­°åŠ å¼·ã€‚</p>
    `;
    container.appendChild(radarCard);

    // å»ºç«‹é›·é”åœ–
    if (radarChartInstance) radarChartInstance.destroy();
    const radarCtx = document.getElementById("radarChart").getContext("2d");
    radarChartInstance = new Chart(radarCtx, {
      type: "radar",
      data: {
        labels: radarLabels,
        datasets: [
          {
            label: "å­¸ç”Ÿ",
            data: radarPlayerScores,
            borderColor: "rgba(59,130,246,0.9)",
            backgroundColor: "rgba(59,130,246,0.32)",
            borderWidth: 2,
            pointRadius: 3
          },
          {
            label: "åœ‹éš›æ¨™æº–",
            data: radarIntlScores,
            borderColor: "rgba(148,163,184,0.9)",
            backgroundColor: "rgba(148,163,184,0.16)",
            borderWidth: 1.5,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          r: {
            beginAtZero: true,
            suggestedMax: 90,
            grid: {
              color: "rgba(55,65,81,0.8)"
            },
            angleLines: {
              color: "rgba(55,65,81,0.8)"
            },
            ticks: {
              display: false
            },
            pointLabels: {
              color: "#9ca3af",
              font: {
                size: 10
              }
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: "#e5e7eb",
              font: { size: 10 }
            }
          }
        }
      }
    });

    /* ====== è¡¨æ ¼ï¼šå‰å¾Œæ¸¬ ====== */

    const section1Title = document.createElement("h3");
    section1Title.className = "section-title";
    section1Title.textContent = "å‰å¾Œæ¸¬æ¯”è¼ƒ";
    container.appendChild(section1Title);

    const table1Card = document.createElement("div");
    table1Card.className = "card";
    table1Card.innerHTML = `
      <div class="card-header">
        <div class="card-title">BASELINE VS LATEST</div>
        <div class="card-tag">å‰å¾Œæ¸¬æˆç¸¾ä¸€è¦½</div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>æŒ‡æ¨™</th>
              <th>å‰æ¸¬</th>
              <th>æœ€æ–°æ¸¬é©—</th>
              <th>å·®ç•°</th>
              <th>è®ŠåŒ–%</th>
            </tr>
          </thead>
          <tbody id="tbodyTrend"></tbody>
        </table>
      </div>
    `;
    container.appendChild(table1Card);

    const tbodyTrend = table1Card.querySelector("#tbodyTrend");
    trendRows.forEach(row => {
      const tr = document.createElement("tr");
      const diffText = row.diff === null ? "â€”" : row.diff.toFixed(2);
      const diffClass = row.trendGood ? "trend-up" : "trend-down";
      const diffLabel = row.diff === null ? "â€”" : (row.trendGood ? "â†‘ " : "â†“ ") + Math.abs(row.diff).toFixed(2);

      tr.innerHTML = `
        <td>${row.metric}</td>
        <td>${row.earliest ?? "â€”"}</td>
        <td>${row.latest ?? "â€”"}</td>
        <td class="${row.diff === null ? "" : diffClass}">${row.diff === null ? "â€”" : diffLabel}</td>
        <td>${row.trendText}</td>
      `;
      tbodyTrend.appendChild(tr);
    });

    /* ====== è¡¨æ ¼ï¼šèˆ‡åœ‹éš›æ¨™æº–æ¯”è¼ƒ ====== */

    const section2Title = document.createElement("h3");
    section2Title.className = "section-title";
    section2Title.textContent = "èˆ‡åœ‹éš›æ¨™æº–å°ç…§";
    container.appendChild(section2Title);

    const table2Card = document.createElement("div");
    table2Card.className = "card";
    table2Card.innerHTML = `
      <div class="card-header">
        <div class="card-title">INTERNATIONAL BENCHMARK</div>
        <div class="card-tag">åŒåˆ†ç´šæ¨£æœ¬ Â· Z åˆ†æ•¸è©•ä¼°</div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>æŒ‡æ¨™</th>
              <th>å­¸ç”Ÿ</th>
              <th>åœ‹éš›å¹³å‡</th>
              <th>SD</th>
              <th>Z åˆ†æ•¸</th>
              <th>è©•ä¼°</th>
            </tr>
          </thead>
          <tbody id="tbodyIntl"></tbody>
        </table>
      </div>
      <p class="note">Z åˆ†æ•¸ç´„åœ¨ -0.5 ~ +0.5 ç‚ºæ¥è¿‘åœ‹éš›å¹³å‡ï¼›â‰¥ +1 ç‚ºæ˜é¡¯å„ªæ–¼åœ‹éš›æ¨£æœ¬ï¼›â‰¤ -0.5 å»ºè­°åˆ—å…¥è¨“ç·´é‡é»ã€‚</p>
    `;
    container.appendChild(table2Card);

    const tbodyIntl = table2Card.querySelector("#tbodyIntl");
    intlCompare.sort((a, b) => b.z - a.z);
    intlCompare.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.metric}</td>
        <td>${row.latest ?? "â€”"}</td>
        <td>${row.mean ?? "â€”"}</td>
        <td>${row.sd ?? "â€”"}</td>
        <td>${row.z.toFixed(2)}</td>
        <td><span class="chip ${row.chipClass}">${row.level}</span></td>
      `;
      tbodyIntl.appendChild(tr);
    });

    /* ====== æ•™ç·´å»ºè­°æ–‡æ¡ˆ ====== */

    const summaryEl = document.getElementById("coachSummary");
    const topStrengths = strengths.sort((a, b) => b.z - a.z).slice(0, 3);
    const topWeaknesses = weaknesses.sort((a, b) => a.z - b.z).slice(0, 3);

    const buildMetricList = arr =>
      arr.map(item => `${item.metric}ï¼ˆZ = ${item.z.toFixed(2)}ï¼‰`).join("ã€") || "ç›®å‰æ²’æœ‰ç‰¹åˆ¥çªå‡ºï¼æ˜é¡¯è½å¾Œçš„å–®ä¸€é …ç›®ã€‚";

    summaryEl.innerHTML = `
      <div class="coach-notes">
        <p>æ•´é«”ä¾†èªªï¼Œ${name} åœ¨æœ¬æ¬¡æ¸¬é©—ä¸­ï¼š</p>
        <ul>
          <li>ç›¸å°<strong>åœ‹éš›æ¨£æœ¬</strong>ï¼Œä¸»è¦å¼·é …åŒ…æ‹¬ï¼š${buildMetricList(topStrengths)}</li>
          <li>å»ºè­°å„ªå…ˆåŠ å¼·çš„é …ç›®ç‚ºï¼š${buildMetricList(topWeaknesses)}</li>
        </ul>
        <p>æ•™ç·´å¯ä¾æ“šå¼±é …å®‰æ’ã€Œæ¯é€± 2ï½3 æ¬¡ã€é‡å°æ€§è¨“ç·´ï¼Œä¾‹å¦‚ï¼š</p>
        <ul>
          <li><strong>çˆ†ç™¼åŠ›é¡ï¼ˆè·³èºã€å¯¦å¿ƒçƒï¼‰åå¼±ï¼š</strong>å¯åŠ å…¥ç®±è·³ã€å–®è…³è·³ã€è² é‡æ·±è¹²ç­‰ã€‚</li>
          <li><strong>é€Ÿåº¦èˆ‡åŠ é€Ÿåº¦ï¼ˆ10mã€20mã€505ï¼‰åå¼±ï¼š</strong>å®‰æ’çŸ­è·é›¢è¡åˆºã€åŠ é€Ÿèµ·è·‘ã€å¡è·‘ç­‰ã€‚</li>
          <li><strong>æ•æ·æ€§èˆ‡è®Šå‘ï¼ˆ505ã€èœ˜è››è·‘ï¼‰åå¼±ï¼š</strong>å¢åŠ å¤šæ–¹å‘è®Šå‘ã€åæ‡‰è…³æ­¥èˆ‡æ¨™è¨˜éŒè¨“ç·´ã€‚</li>
        </ul>
        <p class="muted">â€» ä»¥ä¸Šå»ºè­°ç‚ºè‡ªå‹•ç”Ÿæˆï¼Œå¯¦éš›è¨“ç·´ä»éœ€ç”±æ•™ç·´ä¾çƒå“¡ç‹€æ³èˆ‡å‚·ç—…å²èª¿æ•´ã€‚</p>
      </div>
    `;

    document.getElementById("pdfBtn").disabled = false;
  }

  /********************************************************
   * 5. ä¸‹è¼‰ PDF
   ********************************************************/

  function downloadPdf() {
    const selectEl = document.getElementById("playerSelect");
    const name = selectEl.value || "report";
    const element = document.getElementById("reportPage");

    const opt = {
      margin: [10, 10, 10, 10],
      filename: `${name}-é«”èƒ½æª¢æ¸¬å ±å‘Š.pdf`,
      image: { type: "jpeg", quality: 0.96 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
    };

    html2pdf().from(element).set(opt).save();
  }

  /********************************************************
   * 6. ç¶å®šäº‹ä»¶
   ********************************************************/

  document.getElementById("reloadBtn").addEventListener("click", reloadAll);

  document.getElementById("loadReportBtn").addEventListener("click", () => {
    const selectEl = document.getElementById("playerSelect");
    const name = selectEl.value;
    if (!name) return;
    buildReportFor(name);
  });

  document.getElementById("pdfBtn").addEventListener("click", downloadPdf);

  // é¦–æ¬¡é€²ä¾†å°±å˜—è©¦è¼‰å…¥ä¸€æ¬¡ï¼ˆå¦‚æœä½ ä¸æƒ³è‡ªå‹•è¼‰å…¥ï¼Œå¯ä»¥è¨»è§£æ‰ï¼‰
  // reloadAll();
</script>
</body>
</html>
