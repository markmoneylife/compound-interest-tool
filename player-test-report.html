<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é‹å‹•å“¡æª¢æ¸¬å ±å‘Šæ›¸ v8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js for Radar Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #eff6ff;
      --primary-border: #bfdbfe;
      --accent: #16a34a;
      --danger: #dc2626;
      --bg-page: #f4f4f5;
      --card-bg: #ffffff;
      --text-main: #111827;
      --text-sub: #6b7280;
      --border: #e5e7eb;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--font-main);
      background: var(--bg-page);
      color: var(--text-main);
    }

    .app-root {
      max-width: 960px;
      margin: 0 auto;
      padding: 1.5rem 1rem 3rem;
    }

    @media (min-width: 768px) {
      .app-root {
        padding-top: 2.5rem;
      }
    }

    /* Header */
    .header {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-bottom: 1rem;
    }
    .header-title {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }
    .header-title span.icon {
      font-size: 1.7rem;
    }
    .header-title h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
    }
    .header-sub {
      font-size: 0.9rem;
      color: var(--text-sub);
    }

    /* æ§åˆ¶åˆ— */
    .control-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 1.2rem;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      min-width: 220px;
    }
    .control-label {
      font-size: 0.78rem;
      color: var(--text-sub);
    }
    select, button {
      font-family: var(--font-main);
      font-size: 0.9rem;
    }
    select {
      padding: 0.45rem 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      background: #ffffff;
      min-width: 220px;
    }
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .btn {
      padding: 0.5rem 0.95rem;
      border-radius: 999px;
      border: 1px solid transparent;
      background: var(--primary);
      color: #ffffff;
      display: inline-flex;
      gap: 0.35rem;
      align-items: center;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
    }
    .btn.secondary {
      background: #ffffff;
      color: var(--text-main);
      border-color: var(--border);
    }
    .btn:disabled {
      opacity: 0.55;
      cursor: default;
    }

    /* å ±å‘Šå¡ç‰‡ */
    .card {
      background: var(--card-bg);
      border-radius: 0.8rem;
      border: 1px solid var(--border);
      padding: 1rem 1.1rem;
      margin-bottom: 0.9rem;
    }

    /* åŸºæœ¬è³‡è¨Šåˆ— */
    .info-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.8rem;
      font-size: 0.9rem;
    }
    @media (max-width: 640px) {
      .info-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    .info-block-label {
      font-size: 0.78rem;
      color: var(--text-sub);
    }
    .info-block-value {
      font-weight: 600;
      margin-top: 0.15rem;
    }

    /* å°æ¨™é¡Œ */
    .section-title {
      margin: 0;
      margin-bottom: 0.4rem;
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .section-sub {
      font-size: 0.85rem;
      color: var(--text-sub);
      margin-bottom: 0.5rem;
    }

    .badge-group {
      display: inline-flex;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: var(--primary-soft);
      border: 1px solid var(--primary-border);
      color: #1d4ed8;
      gap: 0.3rem;
      align-items: center;
    }

    /* é›·é”åœ– */
    .radar-wrapper {
      position: relative;
      height: 320px;
    }

    /* æ•™ç·´å»ºè­° */
    .coach-box {
      background: #fffbeb;
      border-radius: 0.8rem;
      border: 1px solid #facc15;
      padding: 0.75rem 0.9rem;
      font-size: 0.9rem;
      color: #854d0e;
    }
    .coach-title {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      color: #166534;
      margin-bottom: 0.4rem;
      font-weight: 600;
    }

    /* è¡¨æ ¼ */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 0.4rem;
    }
    th, td {
      padding: 0.3rem 0.4rem;
      border-bottom: 1px solid var(--border);
      text-align: right;
      white-space: nowrap;
    }
    th:first-child, td:first-child {
      text-align: left;
    }
    th {
      background: #f9fafb;
      color: var(--text-sub);
      font-weight: 500;
    }
    tr:last-child td {
      border-bottom: none;
    }

    .tag {
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.75rem;
    }
    .tag.good {
      border-color: rgba(22, 163, 74, 0.8);
      background: rgba(220, 252, 231, 0.9);
      color: #166534;
    }
    .tag.mid {
      border-color: rgba(245, 158, 11, 0.8);
      background: #fef9c3;
      color: #92400e;
    }
    .tag.bad {
      border-color: rgba(220, 38, 38, 0.8);
      background: #fee2e2;
      color: #b91c1c;
    }

    /* åˆ—å°æç¤º */
    .print-hint {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-top: 0.4rem;
    }
  </style>
</head>
<body>
<div class="app-root">

  <!-- æ¨™é¡Œ -->
  <header class="header">
    <div class="header-title">
      <span class="icon">ğŸ†</span>
      <h1>é‹å‹•å“¡æª¢æ¸¬å ±å‘Šæ›¸</h1>
    </div>
    <p class="header-sub">
      ç”± Google è©¦ç®—è¡¨è‡ªå‹•åŒ¯å…¥ã€Œæª¢æ¸¬æˆç¸¾ã€èˆ‡ã€Œåœ‹éš›æ¨™æº–ã€æ•¸æ“šï¼Œç”¢ç”Ÿçµ¦å®¶é•·çœ‹çš„ç°¡æ˜“å ±å‘Šã€‚
    </p>
  </header>

  <!-- æ§åˆ¶åˆ— -->
  <section class="control-bar">
    <div class="control-group">
      <span class="control-label">è«‹é¸æ“‡é‹å‹•å“¡å§“åï¼š</span>
      <select id="playerSelect" disabled>
        <option value="">è³‡æ–™è¼‰å…¥ä¸­...</option>
      </select>
    </div>
    <div class="btn-row">
      <button class="btn secondary" id="reloadBtn">ğŸ”„ é‡æ–°è¼‰å…¥ Google è©¦ç®—è¡¨</button>
      <button class="btn" id="genBtn" disabled>ğŸ“Š ç”¢ç”Ÿå ±å‘Š</button>
      <button class="btn secondary" id="printBtn" disabled>ğŸ–¨ åˆ—å° / å¦å­˜ç‚º PDF</button>
    </div>
  </section>

  <!-- å ±å‘Šä¸»é«” -->
  <section id="report" class="card">
    <p id="placeholder" style="font-size:0.9rem; color:#6b7280;">
      è«‹å…ˆæŒ‰ã€Œé‡æ–°è¼‰å…¥ Google è©¦ç®—è¡¨ã€ï¼Œå†é¸æ“‡é‹å‹•å“¡ä¸¦é»ã€Œç”¢ç”Ÿå ±å‘Šã€ã€‚
    </p>
  </section>

</div>

<script>
  /*********** åŸºæœ¬è¨­å®šï¼šä½ çš„è©¦ç®—è¡¨ ***********/
  const FILE_ID = "1N-8HQZaxHYj4vE824raG1fWyNxt5w7B9_m8oHn8f4As";
  const SHEETS = {
    players: "å­¸å“¡ä¸»è³‡æ–™è¡¨",
    tests: "æª¢æ¸¬æˆç¸¾",
    intl: "åœ‹éš›æ¨™æº–"
  };

  /*********** å·¥å…·å‡½å¼ï¼šæŠ“ CSV & è§£æ ***********/
  async function fetchSheetCsv(sheetName) {
    const url =
      `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(
        sheetName
      )}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("è®€å–å·¥ä½œè¡¨å¤±æ•—ï¼š" + sheetName);
    return await res.text();
  }

  function parseCsv(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    if (!lines.length) return [];
    const headers = lines[0].split(",").map(h => h.trim());
    return lines.slice(1).map(line => {
      const cols = line.split(",");
      const obj = {};
      headers.forEach((h, i) => {
        obj[h] = (cols[i] ?? "").trim();
      });
      return obj;
    });
  }

  function toNumber(v) {
    if (v == null || v === "") return null;
    const n = Number(String(v).replace(/[^\d.\-]/g, ""));
    return isNaN(n) ? null : n;
  }

  function zToScore(z) {
    // Z=0 => 50åˆ†ï¼ŒZ=Â±1 => 60 / 40
    const s = 50 + z * 10;
    return Math.max(0, Math.min(100, s));
  }

  const LOWER_BETTER_KEYS = ["10", "20", "505", "åæ‡‰", "æ•æ·", "è¡åˆº", "s"]; // å¤§æ¦‚æŠ“ä¸€ä¸‹æ™‚é–“é¡
  function isLowerBetter(metric) {
    return LOWER_BETTER_KEYS.some(k => metric.includes(k));
  }

  /*********** å…¨åŸŸè³‡æ–™ ***********/
  let playersByName = new Map();
  let testsByName = new Map();
  let intlByGroup = new Map();
  let lastLoadedAt = null;
  let radarChart = null;

  /*********** è®€å–å…¨éƒ¨å·¥ä½œè¡¨ ***********/
  async function reloadSheets() {
    const placeholder = document.getElementById("placeholder");
    const select = document.getElementById("playerSelect");
    const genBtn = document.getElementById("genBtn");
    const printBtn = document.getElementById("printBtn");

    select.disabled = true;
    genBtn.disabled = true;
    printBtn.disabled = true;
    placeholder.textContent = "å¾ Google è©¦ç®—è¡¨è¼‰å…¥è³‡æ–™ä¸­â€¦";

    try {
      const [pCsv, tCsv, iCsv] = await Promise.all([
        fetchSheetCsv(SHEETS.players),
        fetchSheetCsv(SHEETS.tests),
        fetchSheetCsv(SHEETS.intl)
      ]);

      const players = parseCsv(pCsv);
      const tests = parseCsv(tCsv);
      const intl = parseCsv(iCsv);

      playersByName = new Map();
      testsByName = new Map();
      intlByGroup = new Map();

      // å­¸å“¡ä¸»è³‡æ–™è¡¨
      players.forEach(row => {
        const n = (row["å§“å"] || "").trim();
        if (!n) return;
        playersByName.set(n, row);
      });

      // æª¢æ¸¬æˆç¸¾ï¼ˆç›®å‰ä¸€äººä¸€è¡Œï¼‰
      tests.forEach(row => {
        const n = (row["å§“å"] || "").trim();
        if (!n) return;
        testsByName.set(n, row);
      });

      // åœ‹éš›æ¨™æº–ï¼šåˆ†ç´š + æŒ‡æ¨™å¹³å‡ & æ¨™æº–å·®
      intl.forEach(row => {
        const group = (row["åˆ†ç´š"] || "").trim();
        if (!group) return;
        const metrics = intlByGroup.get(group) || {};

        Object.keys(row).forEach(h => {
          if (!h || h === "åˆ†ç´š") return;
          const val = toNumber(row[h]);
          if (val == null) return;

          if (h.includes("æ¨™æº–å·®") || h.toUpperCase().includes("SD")) {
            const base = h.replace(/[\(\ï¼ˆ]æ¨™æº–å·®[\)\ï¼‰]/g, "")
              .replace("æ¨™æº–å·®", "")
              .replace("SD", "")
              .trim();
            metrics[base] = metrics[base] || {};
            metrics[base].sd = val;
          } else {
            metrics[h] = metrics[h] || {};
            metrics[h].mean = val;
          }
        });

        intlByGroup.set(group, metrics);
      });

      // ä¸‹æ‹‰é¸å–®
      const names = Array.from(
        new Set([...playersByName.keys(), ...testsByName.keys()])
      ).sort((a, b) => a.localeCompare(b, "zh-Hant"));

      select.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "è«‹é¸æ“‡é‹å‹•å“¡";
      select.appendChild(opt0);

      names.forEach(n => {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        select.appendChild(opt);
      });

      select.disabled = false;
      genBtn.disabled = false;
      placeholder.textContent =
        "è³‡æ–™è¼‰å…¥å®Œæˆï¼Œè«‹ä¸Šæ–¹é¸æ“‡é‹å‹•å“¡å¾ŒæŒ‰ã€Œç”¢ç”Ÿå ±å‘Šã€ã€‚";
      lastLoadedAt = new Date();
    } catch (err) {
      console.error(err);
      placeholder.textContent =
        "è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ï¼š\n1ï¼‰è©¦ç®—è¡¨å·²è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äºº â†’ æª¢è¦–è€…ã€ã€‚\n2ï¼‰åˆ†é åç¨±ï¼šå­¸å“¡ä¸»è³‡æ–™è¡¨ / æª¢æ¸¬æˆç¸¾ / åœ‹éš›æ¨™æº–ã€‚";
    }
  }

  /*********** ç”¢ç”ŸæŸä½é‹å‹•å“¡çš„å ±å‘Š ***********/
  function generateReport() {
    const name = document.getElementById("playerSelect").value;
    const report = document.getElementById("report");
    const printBtn = document.getElementById("printBtn");

    if (!name) return;

    const player = playersByName.get(name) || { å§“å: name };
    const test = testsByName.get(name);

    if (!test) {
      report.innerHTML =
        `<p style="font-size:0.9rem;color:#6b7280;">æ‰¾ä¸åˆ°ã€Œ${name}ã€çš„æª¢æ¸¬æˆç¸¾ï¼Œè«‹å…ˆåœ¨ã€Œæª¢æ¸¬æˆç¸¾ã€åˆ†é å»ºç«‹è³‡æ–™åˆ—ã€‚</p>`;
      printBtn.disabled = true;
      return;
    }

    const group = player["åˆ†ç´š"] || test["åˆ†ç´š"] || "â€”";
    const intlMetrics = intlByGroup.get(group) || {};

    // æ•´ç†ã€Œæœ‰åœ‹éš›æ¨™æº–ã€ä¸”ã€Œæˆç¸¾æ˜¯æ•¸å€¼ã€çš„æŒ‡æ¨™
    const identityKeys = new Set([
      "å§“å","æ€§åˆ¥","å¹´é½¡","åˆ†ç´š","ç”Ÿæ—¥","æ—¥æœŸ","æ¸¬é©—æ—¥æœŸ",
      "å‚·ç—…ï¼é™åˆ¶","å‚·å‹¢ï¼é™åˆ¶","å‚·å‹¢/é™åˆ¶","ç›®æ¨™","ä¸€é€±å¯ä¸Šèª²æ™‚æ®µ","è¯çµ¡æ–¹å¼","å‚™è¨»"
    ]);

    const metricRows = [];

    Object.keys(test).forEach(key => {
      if (!key || identityKeys.has(key)) return;
      if (key.includes("æ¨™æº–å·®") || key.toUpperCase().includes("SD")) return;

      const latest = toNumber(test[key]);
      if (latest == null) return;

      const intlInfo = intlMetrics[key] || {};
      const mean = intlInfo.mean ?? null;
      const sd = intlInfo.sd ?? null;

      let z = null;
      let score = null;

      if (mean != null && sd != null && sd !== 0) {
        const lowerBetter = isLowerBetter(key);
        z = lowerBetter ? (mean - latest) / sd : (latest - mean) / sd;
        score = zToScore(z);
      }

      metricRows.push({ name: key, latest, mean, sd, z, score });
    });

    if (!metricRows.length) {
      report.innerHTML =
        `<p style="font-size:0.9rem;color:#6b7280;">ã€Œ${name}ã€æœ‰æª¢æ¸¬æˆç¸¾ï¼Œä½†æ²’æœ‰ä»»ä½•æŒ‡æ¨™åŒæ™‚å­˜åœ¨æ–¼ã€Œåœ‹éš›æ¨™æº–ã€åˆ†é ä¸­ã€‚è«‹ç¢ºèªæ¬„ä½åç¨±ä¸€è‡´ã€‚</p>`;
      printBtn.disabled = true;
      return;
    }

    // é›·é”åœ–è³‡æ–™ï¼ˆåªç”¨æœ‰ score çš„ï¼‰
    const radarData = metricRows.filter(r => r.score != null);
    const labels = radarData.map(r => r.name);
    const playerScores = radarData.map(r => r.score);
    const intlScores = radarData.map(() => 50); // åœ‹éš›æ¨£æœ¬å›ºå®šè¦–ç‚º 50 åˆ†

    // æ•™ç·´å»ºè­°ï¼šæ‰¾å‡ºå¼·é … & éœ€åŠ å¼·
    const strengths = radarData.filter(r => r.z >= 1).sort((a, b) => b.z - a.z).slice(0, 3);
    const weak = radarData.filter(r => r.z <= -0.5).sort((a, b) => a.z - b.z).slice(0, 3);

    const buildList = arr =>
      !arr.length
        ? "ç›®å‰å„é …æ•¸æ“šå¤§è‡´æ¥è¿‘åŒé½¡åœ‹éš›æ¨£æœ¬ï¼Œæ²’æœ‰ç‰¹åˆ¥çªå‡ºçš„å¼·é …æˆ–å¼±é …ã€‚"
        : arr.map(r => `${r.name}ï¼ˆZ = ${r.z.toFixed(2)}ï¼‰`).join("ã€");

    const date =
      player["æœ€æ–°æª¢æ¸¬æ—¥"] ||
      test["æ—¥æœŸ"] ||
      test["æ¸¬é©—æ—¥æœŸ"] ||
      new Date().toISOString().slice(0, 10);

    // çµ„ HTML
    let html = "";

    // åŸºæœ¬å€
    html += `
      <div class="card" style="margin:-0.5rem -0.5rem 0.8rem -0.5rem; border:none; padding:0;">
        <div style="padding:0 0 0.4rem 0; border-bottom:1px solid #e5e7eb; margin-bottom:0.6rem;">
          <div class="info-row">
            <div>
              <div class="info-block-label">å§“å</div>
              <div class="info-block-value">${player["å§“å"] || name}</div>
            </div>
            <div>
              <div class="info-block-label">çµ„åˆ¥</div>
              <div class="info-block-value">${group}</div>
            </div>
            <div>
              <div class="info-block-label">æœ€æ–°æª¢æ¸¬æ—¥</div>
              <div class="info-block-value">${date}</div>
            </div>
          </div>
        </div>
      </div>
    `;

    // é›·é”åœ–
    html += `
      <div class="card" style="border:none; padding-left:0; padding-right:0;">
        <h2 class="section-title">èƒ½åŠ›é›·é”åˆ†æ</h2>
        <p class="section-sub">æ­¤åœ–è¡¨é¡¯ç¤ºè©²é¸æ‰‹åœ¨å„é …é«”èƒ½ç´ è³ªä¸Šçš„è¡¨ç¾å‡è¡¡åº¦ï¼ˆæ•¸å€¼è¶Šé«˜ä»£è¡¨è¡¨ç¾è¶Šå¥½ï¼‰ã€‚</p>
        <div class="badge-group">
          <span style="width:10px;height:10px;border-radius:999px;background:#2563eb;"></span> ${name}
          <span style="width:10px;height:10px;border-radius:999px;background:#9ca3af;margin-left:0.6rem;"></span> ${group} æ¨£æœ¬åƒè€ƒ
        </div>
        <div class="radar-wrapper">
          <canvas id="radarCanvas"></canvas>
        </div>
      </div>
    `;

    // æ•™ç·´å»ºè­°
    html += `
      <div class="card" style="border:none; padding-left:0; padding-right:0;">
        <h2 class="section-title" style="margin-bottom:0.5rem; color:#16a34a;">æ•™ç·´å»ºè­°èˆ‡çŸ­è©•</h2>
        <div class="coach-box">
          <div class="coach-title">
            <span>ğŸ“</span><span>ä¾æœ¬æ¬¡æª¢æ¸¬æ•¸æ“šä¹‹é‡é»è§€å¯Ÿ</span>
          </div>
          <div style="font-size:0.9rem; line-height:1.6;">
            <p>æ ¹æ“šæ•¸æ“šé¡¯ç¤ºï¼Œ<strong>${name}</strong> ç›¸è¼ƒåŒçµ„åˆ¥åœ‹éš›æ¨£æœ¬ï¼š</p>
            <ul style="margin:0 0 0.3rem 1.1rem; padding:0;">
              <li><strong>ä¸»è¦å¼·é …ï¼š</strong>${buildList(strengths)}</li>
              <li><strong>å„ªå…ˆè£œå¼·ï¼š</strong>${buildList(weak)}</li>
            </ul>
            <p style="margin:0.2rem 0 0;">
              å»ºè­°åœ¨è¨“ç·´å®‰æ’ä¸Šï¼Œå°‡ä¸Šè¿°éœ€åŠ å¼·é …ç›®ç´å…¥æœ¬æœŸé‡é»ï¼ŒåŒæ™‚ç¶­æŒæ—¢æœ‰å¼·é …çš„ç©©å®šè¡¨ç¾ã€‚
            </p>
          </div>
        </div>
      </div>
    `;

    // æˆç¸¾è¡¨
    html += `
      <div class="card" style="border:none; padding-left:0; padding-right:0;">
        <h2 class="section-title" style="margin-bottom:0.3rem;">æœ¬æ¬¡æª¢æ¸¬æˆç¸¾èˆ‡åœ‹éš›æ¨™æº–å°ç…§</h2>
        <p class="section-sub">
          Z åˆ†æ•¸ç´„ä»‹æ–¼ -0.5 ï½ +0.5 è¦–ç‚ºæ¥è¿‘åœ‹éš›å¹³å‡ï¼›â‰¥ +1 ç‚ºæ˜é¡¯å„ªæ–¼æ¨£æœ¬ï¼›â‰¤ -0.5 å»ºè­°åˆ—å…¥è£œå¼·é‡é»ã€‚
        </p>
        <table>
          <thead>
            <tr>
              <th>æŒ‡æ¨™</th>
              <th>å­¸ç”Ÿ</th>
              <th>åœ‹éš›å¹³å‡</th>
              <th>SD</th>
              <th>Z åˆ†æ•¸</th>
              <th>è©•ä¼°</th>
            </tr>
          </thead>
          <tbody>
    `;

    metricRows
      .slice()
      .sort((a, b) => {
        if (a.z == null && b.z == null) return 0;
        if (a.z == null) return 1;
        if (b.z == null) return -1;
        return b.z - a.z;
      })
      .forEach(row => {
        let tagHtml = "â€”";
        if (row.z != null) {
          if (row.z >= 1) {
            tagHtml = `<span class="tag good">å„ªæ–¼æ¨£æœ¬</span>`;
          } else if (row.z <= -0.5) {
            tagHtml = `<span class="tag bad">å»ºè­°è£œå¼·</span>`;
          } else {
            tagHtml = `<span class="tag mid">æ¥è¿‘å¹³å‡</span>`;
          }
        }

        html += `
          <tr>
            <td>${row.name}</td>
            <td>${row.latest ?? "â€”"}</td>
            <td>${row.mean ?? "â€”"}</td>
            <td>${row.sd ?? "â€”"}</td>
            <td>${row.z != null ? row.z.toFixed(2) : "â€”"}</td>
            <td>${tagHtml}</td>
          </tr>
        `;
      });

    html += `
          </tbody>
        </table>
        <p class="print-hint">æç¤ºï¼šå¯æŒ‰ä¸Šæ–¹ã€Œåˆ—å° / å¦å­˜ç‚º PDFã€ï¼Œå°‡æœ¬é ç›´æ¥åŒ¯å‡ºçµ¦å®¶é•·ã€‚</p>
      </div>
    `;

    report.innerHTML = html;
    printBtn.disabled = false;

    // å»ºç«‹é›·é”åœ–
    if (radarChart) radarChart.destroy();
    const ctx = document.getElementById("radarCanvas").getContext("2d");
    radarChart = new Chart(ctx, {
      type: "radar",
      data: {
        labels,
        datasets: [
          {
            label: name,
            data: playerScores,
            borderColor: "#2563eb",
            backgroundColor: "rgba(37,99,235,0.2)",
            pointRadius: 3,
            borderWidth: 2
          },
          {
            label: group + " æ¨£æœ¬",
            data: intlScores,
            borderColor: "#9ca3af",
            backgroundColor: "rgba(156,163,175,0.15)",
            pointRadius: 0,
            borderWidth: 1.2
          }
        ]
      },
      options: {
        scales: {
          r: {
            beginAtZero: true,
            suggestedMax: 80,
            ticks: { display: false },
            grid: { color: "#e5e7eb" },
            angleLines: { color: "#e5e7eb" },
            pointLabels: { font: { size: 10 }, color: "#4b5563" }
          }
        },
        plugins: {
          legend: { labels: { font: { size: 10 } } }
        }
      }
    });
  }

  /*********** åˆ—å° ***********/
  function printReport() {
    window.print();
  }

  /*********** ç¶å®šäº‹ä»¶ ***********/
  document.getElementById("reloadBtn").addEventListener("click", reloadSheets);
  document.getElementById("genBtn").addEventListener("click", generateReport);
  document.getElementById("printBtn").addEventListener("click", printReport);

  // ä¸€è¼‰å…¥å°±å…ˆè©¦è‘—æŠ“ä¸€æ¬¡
  reloadSheets();
</script>
</body>
</html>
