<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ•™ç·´ä¸­å¿ƒï½œé«”èƒ½æª¢æ¸¬å ±å‘Š v4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js for radar chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- html2pdf.js for export PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --bg-main: #020617;
      --bg-panel: #020617;
      --bg-card: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --accent-border: rgba(34, 197, 94, 0.55);
      --accent-strong: #4ade80;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --border-soft: #1f2937;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      --danger: #f97373;
      --warn: #facc15;
      --good: #4ade80;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-main);
      background:
        radial-gradient(circle at top, #0b1120 0, #020617 45%, #000 100%);
      color: var(--text-main);
    }

    .app-root {
      min-height: 100vh;
      max-width: 1120px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem 3rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    @media (min-width: 960px) {
      .app-root {
        padding: 2.25rem 1.25rem 3rem;
      }
    }

    .app-header {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .app-title-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .app-title {
      font-size: clamp(1.5rem, 2.4vw, 1.9rem);
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.18rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.8);
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.85);
    }

    .badge.accent {
      border-color: var(--accent-border);
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .app-subtitle {
      font-size: 0.9rem;
      color: var(--text-sub);
      max-width: 640px;
    }

    /* æ§åˆ¶é¢æ¿ */

    .control-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end;
      padding: 1rem 1.2rem;
      border-radius: 0.9rem;
      background:
        radial-gradient(circle at top left, rgba(34, 197, 94, 0.35) 0, rgba(15, 23, 42, 0.98) 55%, #020617 100%);
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow:
        0 0 40px rgba(34, 197, 94, 0.15),
        0 20px 60px rgba(15, 23, 42, 0.95);
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      min-width: 220px;
    }

    .field-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-sub);
    }

    select, button {
      font-family: var(--font-main);
      font-size: 0.9rem;
    }

    select {
      padding: 0.5rem 0.7rem;
      border-radius: 0.55rem;
      border: 1px solid rgba(148, 163, 184, 0.75);
      background: rgba(15, 23, 42, 0.93);
      color: var(--text-main);
      min-width: 220px;
      outline: none;
    }

    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.7);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }

    .btn {
      padding: 0.5rem 1.1rem;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.86rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
      background: var(--accent);
      color: #022c22;
      box-shadow: 0 12px 30px rgba(34, 197, 94, 0.45);
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, background 0.12s ease-out;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(34, 197, 94, 0.6);
      background: #22c55e;
    }

    .btn.secondary {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      border-color: rgba(148, 163, 184, 0.6);
      box-shadow: none;
    }

    .btn.secondary:hover:not(:disabled) {
      background: rgba(31, 41, 55, 0.95);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.9);
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-icon {
      font-size: 1rem;
      line-height: 1;
    }

    /* å ±å‘Šå®¹å™¨ */

    .report-shell {
      margin-top: 0.25rem;
      border-radius: 1rem;
      border: 1px solid var(--border-soft);
      background:
        radial-gradient(circle at top left, #111827 0, #020617 52%, #000 100%);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.95);
      padding: 1.2rem;
    }

    .report-page {
      max-width: 900px;
      margin: 0 auto;
      background: #020617;
      border-radius: 0.8rem;
      border: 1px solid #111827;
      padding: 1.4rem 1.6rem 1.8rem;
    }

    /* å ±å‘Š header */

    .report-header {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      border-bottom: 1px solid #1f2937;
      padding-bottom: 0.8rem;
      margin-bottom: 0.85rem;
    }

    .report-header-main {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .report-title {
      font-size: 1.2rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .report-subtitle {
      font-size: 0.82rem;
      color: var(--text-sub);
    }

    .report-header-meta {
      text-align: right;
      font-size: 0.78rem;
      color: var(--text-sub);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #e5e7eb;
    }

    .pill.green {
      border-color: var(--accent-border);
      color: var(--accent-strong);
      background: var(--accent-soft);
    }

    @media (max-width: 768px) {
      .report-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .report-header-meta {
        text-align: left;
      }
    }

    /* å¡ç‰‡ & layout */

    .grid-two {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.05fr);
      gap: 0.9rem;
    }

    @media (max-width: 768px) {
      .grid-two {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 0.75rem;
      border: 1px solid var(--border-soft);
      padding: 0.85rem 1rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.4rem;
    }

    .card-title {
      font-size: 0.88rem;
      font-weight: 600;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .card-tag {
      font-size: 0.78rem;
      color: var(--text-sub);
    }

    .info-list {
      list-style: none;
      margin: 0;
      padding: 0;
      font-size: 0.85rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.3rem 0.9rem;
    }

    .info-list li span.label {
      color: var(--text-sub);
      margin-right: 0.2rem;
    }

    .section-title {
      margin: 0.85rem 0 0.35rem;
      font-size: 0.86rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .note {
      font-size: 0.76rem;
      color: var(--text-sub);
      margin-top: 0.3rem;
    }

    /* è¡¨æ ¼ */

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      margin-top: 0.2rem;
    }

    thead {
      background: rgba(15, 23, 42, 0.96);
    }

    th, td {
      padding: 0.28rem 0.3rem;
      border-bottom: 1px solid #111827;
      text-align: right;
      white-space: nowrap;
    }

    th:first-child, td:first-child {
      text-align: left;
    }

    th {
      font-weight: 600;
      color: #9ca3af;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .trend-up {
      color: var(--good);
      font-weight: 600;
    }

    .trend-down {
      color: var(--danger);
      font-weight: 600;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.72rem;
    }

    .chip.good {
      border-color: rgba(34, 197, 94, 0.85);
      background: rgba(22, 163, 74, 0.18);
      color: #bbf7d0;
    }

    .chip.ok {
      border-color: rgba(250, 204, 21, 0.9);
      background: rgba(250, 204, 21, 0.12);
      color: #fef3c7;
    }

    .chip.bad {
      border-color: rgba(239, 68, 68, 0.9);
      background: rgba(248, 113, 113, 0.16);
      color: #fee2e2;
    }

    /* é›·é”åœ– */

    .radar-wrapper {
      position: relative;
      height: 260px;
    }

    /* å»ºè­°æ–‡å­— */

    .coach-notes {
      font-size: 0.84rem;
      line-height: 1.6;
      color: var(--text-main);
    }

    .coach-notes ul {
      margin: 0.25rem 0 0.15rem;
      padding-left: 1.1rem;
    }

    .coach-notes li {
      margin-bottom: 0.18rem;
    }

    .muted {
      color: var(--text-sub);
    }

    .highlight {
      color: var(--accent-strong);
      font-weight: 600;
    }
  </style>
</head>
<body>
<div class="app-root">

  <header class="app-header">
    <div class="app-title-row">
      <div class="app-title">ATHLETE REPORT</div>
      <span class="badge accent">æ•™ç·´ä¸­å¿ƒ Â· å…§éƒ¨å·¥å…·</span>
    </div>
    <p class="app-subtitle">
      å¾ Google Sheets è‡ªå‹•è®€å–å­¸å“¡è³‡æ–™èˆ‡æª¢æ¸¬æˆç¸¾ï¼Œå°æ¯”åœ‹éš›æ¨™æº–ï¼Œç”¢ç”Ÿå¯ä¸‹è¼‰çš„ PDF å ±å‘Šï¼Œè®“å®¶é•·ä¸€çœ¼çœ‹æ‡‚å­©å­è¨“ç·´å‰å¾Œçš„è®ŠåŒ–ã€‚
    </p>
  </header>

  <!-- æ§åˆ¶å€ -->
  <section class="control-panel">
    <div class="field-group">
      <label class="field-label" for="playerSelect">é¸æ“‡å­¸å“¡</label>
      <select id="playerSelect" disabled>
        <option value="">è«‹å…ˆè¼‰å…¥è³‡æ–™...</option>
      </select>
    </div>
    <div class="btn-row">
      <button class="btn secondary" id="reloadBtn">
        <span class="btn-icon">ğŸ”„</span>
        é‡æ–°è¼‰å…¥ Google Sheets
      </button>
      <button class="btn" id="loadReportBtn" disabled>
        <span class="btn-icon">ğŸ“Š</span>
        ç”¢ç”Ÿå ±å‘Š
      </button>
      <button class="btn secondary" id="pdfBtn" disabled>
        <span class="btn-icon">ğŸ“„</span>
        åŒ¯å‡º PDF çµ¦å®¶é•·
      </button>
    </div>
  </section>

  <!-- å ±å‘Šå€ -->
  <section class="report-shell">
    <div id="reportPage" class="report-page">
      <p class="muted" id="placeholder">
        ğŸ‘‹ è«‹å…ˆæŒ‰ã€Œé‡æ–°è¼‰å…¥ Google Sheetsã€ï¼Œå†å¾ä¸Šæ–¹é¸æ“‡å­¸å“¡ä¸¦é»ã€Œç”¢ç”Ÿå ±å‘Šã€ã€‚
      </p>
    </div>
  </section>
</div>

<script>
  /******************************************************
   * 1. è¨­å®šï¼šä¸‰å€‹ CSV ä¾†æº
   * ç›®å‰å…ˆå…¨éƒ¨ç”¨ä½ çµ¦çš„åŒä¸€æ¢ URLï¼Œ
   * ä¹‹å¾Œè‹¥æœ‰åˆ†é–‹åˆ†é çš„ CSVï¼Œå†æ”¹é€™ä¸‰æ¢å³å¯ã€‚
   ******************************************************/

  const CSV_URLS = {
    players: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRf7j8dcLkA4mObkmT5fF1S7lrgm5f0PPtzda0Hzhwbzo1jOCgxe2oTmF53NK04kshuJJapUIy6SJEe/pub?output=csv",
    tests:   "https://docs.google.com/spreadsheets/d/e/2PACX-1vRf7j8dcLkA4mObkmT5fF1S7lrgm5f0PPtzda0Hzhwbzo1jOCgxe2oTmF53NK04kshuJJapUIy6SJEe/pub?output=csv",
    intl:    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRf7j8dcLkA4mObkmT5fF1S7lrgm5f0PPtzda0Hzhwbzo1jOCgxe2oTmF53NK04kshuJJapUIy6SJEe/pub?output=csv"
  };

  /******************************************************
   * 2. å…±ç”¨å·¥å…·å‡½å¼
   ******************************************************/

  async function fetchCsv(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error("ç„¡æ³•è®€å– CSVï¼š" + url);
    return await res.text();
  }

  function parseCsv(text) {
    // å¾ˆç°¡å–®çš„ parserï¼Œå‡è¨­æ¬„ä½ä¸å«é€—é»
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    if (lines.length === 0) return [];
    const headers = lines[0].split(",").map(h => h.trim());
    return lines.slice(1).map(line => {
      const cols = line.split(",");
      const obj = {};
      headers.forEach((h, idx) => {
        obj[h] = (cols[idx] ?? "").trim();
      });
      return obj;
    });
  }

  function toNumber(v) {
    if (v === null || v === undefined) return null;
    const n = Number(String(v).replace(/[^\d.\-]/g, ""));
    return isNaN(n) ? null : n;
  }

  // å“ªäº›æŒ‡æ¨™æ˜¯ã€Œæ•¸å­—è¶Šå°è¶Šå¥½ã€
  const LOWER_IS_BETTER_KEYS = [
    "10ç±³è¡åˆº", "10Mè¡åˆº", "20ç±³è¡åˆº", "20Mè¡åˆº",
    "505", "æ•æ·è·‘", "èœ˜è››è·‘", "åæ‡‰"
  ];

  function isLowerBetter(metricName) {
    return LOWER_IS_BETTER_KEYS.some(k => metricName.includes(k));
  }

  function zToScore(z) {
    // 50 ç‚ºå¹³å‡ï¼Œä¸€å€‹ SD = 10 åˆ†
    const score = 50 + z * 10;
    return Math.max(0, Math.min(100, score));
  }

  /******************************************************
   * 3. å…¨åŸŸè³‡æ–™æš«å­˜
   ******************************************************/

  let playersByName = new Map();  // å§“å -> profile row
  let testsByName   = new Map();  // å§“å -> [test rows]
  let intlByGroup   = new Map();  // åˆ†ç´š -> { metricName: {mean, sd} }
  let lastLoadedAt  = null;
  let radarInstance = null;

  /******************************************************
   * 4. è¼‰å…¥è³‡æ–™ï¼šå­¸å“¡ / æª¢æ¸¬æˆç¸¾ / åœ‹éš›æ¨™æº–
   ******************************************************/

  async function reloadAll() {
    const placeholder = document.getElementById("placeholder");
    const playerSelect = document.getElementById("playerSelect");
    const loadBtn = document.getElementById("loadReportBtn");
    const pdfBtn = document.getElementById("pdfBtn");

    loadBtn.disabled = true;
    pdfBtn.disabled = true;
    placeholder.textContent = "è³‡æ–™è®€å–ä¸­â€¦";

    try {
      const [playersCsv, testsCsv, intlCsv] = await Promise.all([
        fetchCsv(CSV_URLS.players),
        fetchCsv(CSV_URLS.tests),
        fetchCsv(CSV_URLS.intl)
      ]);

      const players = parseCsv(playersCsv);
      const tests   = parseCsv(testsCsv);
      const intl    = parseCsv(intlCsv);

      playersByName = new Map();
      testsByName   = new Map();
      intlByGroup   = new Map();

      // å­¸å“¡ä¸»è³‡æ–™ï¼šç”¨ã€Œå§“åã€ç•¶ key
      players.forEach(row => {
        const name = (row["å§“å"] || "").trim();
        if (!name) return;
        playersByName.set(name, row);
      });

      // æª¢æ¸¬æˆç¸¾ï¼šåŒä¸€å­¸ç”Ÿå¯èƒ½æœ‰å¤šç­†ï¼ˆå‰å¾Œæ¸¬ï¼‰
      tests.forEach(row => {
        const name = (row["å§“å"] || "").trim();
        if (!name) return;
        if (!testsByName.has(name)) testsByName.set(name, []);
        testsByName.get(name).push(row);
      });

      // åœ‹éš›æ¨™æº–ï¼šå‡è¨­æ¯åˆ—æ˜¯ä¸€å€‹ã€Œåˆ†ç´šã€
      // æ¬„ä½åç¨±æ˜¯æŒ‡æ¨™ï¼Œå«ã€Œæ¨™æº–å·®ã€å­—æ¨£çš„æ¬„ä½ç•¶ SD
      intl.forEach(row => {
        const group = (row["åˆ†ç´š"] || "").trim();
        if (!group) return;
        const metrics = intlByGroup.get(group) || {};

        Object.keys(row).forEach(header => {
          if (!header || header === "åˆ†ç´š") return;
          const val = toNumber(row[header]);
          if (val === null) return;

          if (header.includes("æ¨™æº–å·®")) {
            // ä¾‹å¦‚ã€Œå¯¦å¿ƒçƒéé ‚æ‹‹(æ¨™æº–å·®)ã€
            let base = header;
            base = base.replace(/[\(\ï¼ˆ]æ¨™æº–å·®[\)\ï¼‰]/g, "");
            base = base.replace("æ¨™æº–å·®", "");
            base = base.trim();
            if (!metrics[base]) metrics[base] = {};
            metrics[base].sd = val;
          } else {
            if (!metrics[header]) metrics[header] = {};
            metrics[header].mean = val;
          }
        });

        intlByGroup.set(group, metrics);
      });

      // å»ºç«‹å­¸å“¡ä¸‹æ‹‰é¸å–®
      const allNames = Array.from(new Set([
        ...playersByName.keys(),
        ...testsByName.keys()
      ])).sort((a, b) => a.localeCompare(b, "zh-Hant"));

      playerSelect.innerHTML = "";
      const optEmpty = document.createElement("option");
      optEmpty.value = "";
      optEmpty.textContent = "è«‹é¸æ“‡å­¸å“¡";
      playerSelect.appendChild(optEmpty);

      allNames.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        playerSelect.appendChild(opt);
      });

      playerSelect.disabled = false;
      loadBtn.disabled = false;
      placeholder.textContent = "è³‡æ–™è¼‰å…¥å®Œæˆï¼Œè«‹å¾ä¸Šæ–¹é¸æ“‡å­¸å“¡ä¸¦æŒ‰ã€Œç”¢ç”Ÿå ±å‘Šã€ã€‚";

      lastLoadedAt = new Date();

    } catch (err) {
      console.error(err);
      placeholder.textContent = "è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª Google Sheets çš„ç™¼ä½ˆèˆ‡æ¬Šé™è¨­å®šã€‚";
    }
  }

  /******************************************************
   * 5. å»ºç«‹å–®ä¸€å­¸å“¡å ±å‘Š
   ******************************************************/

  function buildReportFor(name) {
    const container = document.getElementById("reportPage");
    container.innerHTML = "";

    const playerInfo = playersByName.get(name) || { "å§“å": name };
    const tests = testsByName.get(name) || [];

    if (tests.length === 0) {
      container.innerHTML = `<p class="muted">æ‰¾ä¸åˆ°ã€Œ${name}ã€çš„æª¢æ¸¬æˆç¸¾è³‡æ–™ã€‚</p>`;
      document.getElementById("pdfBtn").disabled = true;
      return;
    }

    // å…ˆç”¨è¼¸å…¥é †åºç•¶ä½œæ™‚é–“é †åºï¼ˆç¬¬ä¸€ç­† = å‰æ¸¬ï¼Œæœ€å¾Œä¸€ç­† = æœ€æ–°ï¼‰
    const firstTest = tests[0];
    const lastTest  = tests[tests.length - 1];

    const group = lastTest["åˆ†ç´š"] || playerInfo["åˆ†ç´š"] || "";
    const intlMetrics = intlByGroup.get(group) || {};

    // Header
    const headerEl = document.createElement("div");
    headerEl.className = "report-header";
    headerEl.innerHTML = `
      <div class="report-header-main">
        <div class="report-title">ATHLETIC PERFORMANCE REPORT</div>
        <div class="report-subtitle">çƒå“¡é«”èƒ½æª¢æ¸¬ï½œå‰å¾Œæ¸¬æ¯”è¼ƒ Ã— åœ‹éš›æ¨™æº–å°ç…§</div>
        <span class="pill green">åˆ†ç´šï¼š${group || "æœªå¡«"} Â· INTERNATIONAL BENCHMARK</span>
      </div>
      <div class="report-header-meta">
        <div>${new Date().toLocaleDateString("zh-TW")}</div>
        <div>${lastLoadedAt ? "è³‡æ–™æ›´æ–°æ™‚é–“ï¼š" + lastLoadedAt.toLocaleTimeString("zh-TW") : ""}</div>
      </div>
    `;
    container.appendChild(headerEl);

    // ä¸ŠåŠéƒ¨ï¼šåŸºæœ¬è³‡æ–™ + AI ç¸½çµ
    const gridTop = document.createElement("div");
    gridTop.className = "grid-two";

    const cardProfile = document.createElement("div");
    cardProfile.className = "card";
    cardProfile.innerHTML = `
      <div class="card-header">
        <div class="card-title">PLAYER PROFILE</div>
        <div class="card-tag">å­¸å“¡åŸºæœ¬è³‡æ–™</div>
      </div>
      <ul class="info-list">
        <li><span class="label">å§“åï¼š</span>${playerInfo["å§“å"] || name}</li>
        <li><span class="label">æ€§åˆ¥ï¼š</span>${playerInfo["æ€§åˆ¥"] || lastTest["æ€§åˆ¥"] || "â€”"}</li>
        <li><span class="label">å¹´é½¡ï¼š</span>${playerInfo["å¹´é½¡"] || lastTest["å¹´é½¡"] || "â€”"}</li>
        <li><span class="label">åˆ†ç´šï¼š</span>${group || "â€”"}</li>
        <li><span class="label">ç”Ÿæ—¥ï¼š</span>${playerInfo["ç”Ÿæ—¥"] || "â€”"}</li>
        <li><span class="label">å‚·ç—…ï¼é™åˆ¶ï¼š</span>${playerInfo["å‚·ç—…ï¼é™åˆ¶"] || playerInfo["å‚·å‹¢ï¼é™åˆ¶"] || "â€”"}</li>
        <li><span class="label">è¨“ç·´ç›®æ¨™ï¼š</span>${playerInfo["ç›®æ¨™"] || "â€”"}</li>
        <li><span class="label">è¯çµ¡æ–¹å¼ï¼š</span>${playerInfo["è¯çµ¡æ–¹å¼"] || "â€”"}</li>
      </ul>
    `;

    const cardSummary = document.createElement("div");
    cardSummary.className = "card";
    cardSummary.innerHTML = `
      <div class="card-header">
        <div class="card-title">SUMMARY</div>
        <div class="card-tag">æ•™ç·´é‡é»æ‘˜è¦ï¼ˆçµ¦å®¶é•·çœ‹ï¼‰</div>
      </div>
      <div class="coach-notes" id="coachSummary">
        <p class="muted">ç³»çµ±æœƒä¾ç…§èˆ‡åœ‹éš›æ¨™æº–çš„å·®è·ã€è‡ªèº«å‰å¾Œæ¸¬é€²æ­¥é‡ï¼Œè‡ªå‹•ç”¢ç”Ÿé‡é»èªªæ˜ã€‚</p>
      </div>
    `;

    gridTop.appendChild(cardProfile);
    gridTop.appendChild(cardSummary);
    container.appendChild(gridTop);

    /***** æŒ‡æ¨™åˆ†æï¼šå¾æœ€å¾Œä¸€ç­†æª¢æ¸¬æˆç¸¾æŠ“å‡ºæ‰€æœ‰æ•¸å€¼æ¬„ä½ *****/

    const identityKeys = new Set([
      "å§“å","æ€§åˆ¥","å¹´é½¡","åˆ†ç´š","ç”Ÿæ—¥",
      "å‚·å‹¢/é™åˆ¶","å‚·ç—…ï¼é™åˆ¶","å‚·å‹¢ï¼é™åˆ¶",
      "ç›®æ¨™","ä¸€é€±å¯ä¸Šèª²æ™‚æ®µ","è¯çµ¡æ–¹å¼",
      "æ—¥æœŸ","æ¸¬é©—æ—¥æœŸ","å‚™è¨»"
    ]);

    const metricNames = [];
    Object.keys(lastTest).forEach(key => {
      if (!key || identityKeys.has(key)) return;
      const val = toNumber(lastTest[key]);
      if (val === null) return;
      metricNames.push(key);
    });

    const trendRows = [];
    const intlCompare = [];

    const radarLabels = [];
    const radarPlayerScores = [];
    const radarIntlScores = [];

    const strengths = [];
    const weaknesses = [];

    metricNames.forEach(metric => {
      const latest = toNumber(lastTest[metric]);
      const earliest = toNumber(firstTest[metric]);
      if (latest === null) return;

      // å‰å¾Œæ¸¬
      if (earliest !== null) {
        const diff = latest - earliest;
        const lowerBetter = isLowerBetter(metric);
        const trendGood = lowerBetter ? diff < 0 : diff > 0;
        const diffText = diff === 0 ? "â€”" : (trendGood ? "â†‘ " : "â†“ ") + Math.abs(diff).toFixed(2);
        const pctText = (earliest && earliest !== 0)
          ? (((latest - earliest) / earliest) * 100).toFixed(1) + "%"
          : "â€”";

        trendRows.push({
          metric,
          earliest,
          latest,
          diff,
          diffText,
          pctText,
          trendGood
        });
      }

      // åœ‹éš›æ¨™æº–æ¯”è¼ƒ
      const intl = intlMetrics[metric] || {};
      const mean = intl.mean ?? null;
      const sd   = intl.sd   ?? null;

      if (mean !== null) {
        let z = null;
        let level = "";
        let chipClass = "";

        if (sd !== null && sd !== 0) {
          const lowerBetter = isLowerBetter(metric);
          z = lowerBetter ? (mean - latest) / sd : (latest - mean) / sd;

          const scorePlayer = zToScore(z);
          const scoreIntl   = 50;

          radarLabels.push(metric);
          radarPlayerScores.push(scorePlayer);
          radarIntlScores.push(scoreIntl);

          if (z >= 1) {
            level = "å„ªæ–¼åœ‹éš›æ¨£æœ¬";
            chipClass = "good";
            strengths.push({ metric, z });
          } else if (z <= -0.5) {
            level = "ä½æ–¼åœ‹éš›æ¨£æœ¬";
            chipClass = "bad";
            weaknesses.push({ metric, z });
          } else {
            level = "æ¥è¿‘åœ‹éš›å¹³å‡";
            chipClass = "ok";
          }
        }

        intlCompare.push({
          metric,
          latest,
          mean,
          sd,
          z,
          level,
          chipClass
        });
      }
    });

    /***** é›·é”åœ– *****/

    const radarCard = document.createElement("div");
    radarCard.className = "card";
    radarCard.style.marginTop = "0.75rem";
    radarCard.innerHTML = `
      <div class="card-header">
        <div class="card-title">PERFORMANCE PROFILE</div>
        <div class="card-tag">å­¸ç”Ÿèˆ‡åœ‹éš›æ¨£æœ¬çš„æ•´é«”è¼ªå»“</div>
      </div>
      <div class="radar-wrapper">
        <canvas id="radarChart"></canvas>
      </div>
      <p class="note">
        åœ–ä¸­æ•¸å€¼ç¶“æ¨™æº–åŒ–è™•ç†ï¼ˆç´„ 0â€“100åˆ†ï¼‰ã€‚<span class="highlight">50 åˆ†</span>ç´„ç•¥ä»£è¡¨åœ‹éš›å¹³å‡ï¼Œ
        å¤§æ–¼ 60 åˆ†ç‚ºæ˜é¡¯å¼·é …ï¼Œå°æ–¼ 40 åˆ†ç‚ºå»ºè­°å„ªå…ˆè£œå¼·å€ã€‚
      </p>
    `;
    container.appendChild(radarCard);

    if (radarInstance) radarInstance.destroy();
    const radarCtx = document.getElementById("radarChart").getContext("2d");

    radarInstance = new Chart(radarCtx, {
      type: "radar",
      data: {
        labels: radarLabels,
        datasets: [
          {
            label: "å­¸ç”Ÿ",
            data: radarPlayerScores,
            borderColor: "rgba(34,197,94,0.9)",
            backgroundColor: "rgba(34,197,94,0.25)",
            borderWidth: 2,
            pointRadius: 3
          },
          {
            label: "åœ‹éš›æ¨£æœ¬",
            data: radarIntlScores,
            borderColor: "rgba(148,163,184,0.9)",
            backgroundColor: "rgba(148,163,184,0.15)",
            borderWidth: 1.5,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          r: {
            beginAtZero: true,
            suggestedMax: 90,
            grid: { color: "rgba(55,65,81,0.85)" },
            angleLines: { color: "rgba(55,65,81,0.85)" },
            ticks: { display: false },
            pointLabels: {
              color: "#9ca3af",
              font: { size: 10 }
            }
          }
        },
        plugins: {
          legend: {
            labels: { color: "#e5e7eb", font: { size: 10 } }
          }
        }
      }
    });

    /***** å‰å¾Œæ¸¬è¡¨æ ¼ *****/

    const section1Title = document.createElement("h3");
    section1Title.className = "section-title";
    section1Title.textContent = "å‰å¾Œæ¸¬æˆç¸¾æ¯”è¼ƒ";
    container.appendChild(section1Title);

    const table1Card = document.createElement("div");
    table1Card.className = "card";
    table1Card.innerHTML = `
      <div class="card-header">
        <div class="card-title">BASELINE VS LATEST</div>
        <div class="card-tag">å¾ç¬¬ä¸€æ¬¡åˆ°æœ€è¿‘ä¸€æ¬¡æ¸¬é©—çš„è®ŠåŒ–</div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>æŒ‡æ¨™</th>
              <th>å‰æ¸¬</th>
              <th>æœ€æ–°æ¸¬é©—</th>
              <th>å·®ç•°å€¼</th>
              <th>è®ŠåŒ–ç™¾åˆ†æ¯”</th>
            </tr>
          </thead>
          <tbody id="tbodyTrend"></tbody>
        </table>
      </div>
    `;
    container.appendChild(table1Card);

    const tbodyTrend = table1Card.querySelector("#tbodyTrend");
    trendRows.forEach(row => {
      const tr = document.createElement("tr");
      const diffClass = row.diff == null ? "" : (row.trendGood ? "trend-up" : "trend-down");

      tr.innerHTML = `
        <td>${row.metric}</td>
        <td>${row.earliest ?? "â€”"}</td>
        <td>${row.latest ?? "â€”"}</td>
        <td class="${diffClass}">${row.diffText}</td>
        <td>${row.pctText}</td>
      `;
      tbodyTrend.appendChild(tr);
    });

    /***** åœ‹éš›æ¨™æº–è¡¨æ ¼ *****/

    const section2Title = document.createElement("h3");
    section2Title.className = "section-title";
    section2Title.textContent = "èˆ‡åœ‹éš›æ¨™æº–å°ç…§";
    container.appendChild(section2Title);

    const table2Card = document.createElement("div");
    table2Card.className = "card";
    table2Card.innerHTML = `
      <div class="card-header">
        <div class="card-title">INTERNATIONAL BENCHMARK</div>
        <div class="card-tag">åŒåˆ†ç´šæ¨£æœ¬ Â· å¹³å‡å€¼èˆ‡ Z åˆ†æ•¸</div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>æŒ‡æ¨™</th>
              <th>å­¸ç”Ÿ</th>
              <th>åœ‹éš›å¹³å‡</th>
              <th>SD</th>
              <th>Z åˆ†æ•¸</th>
              <th>è©•ä¼°</th>
            </tr>
          </thead>
          <tbody id="tbodyIntl"></tbody>
        </table>
      </div>
      <p class="note">
        åªæœ‰åŒæ™‚å…·å‚™ã€Œåœ‹éš›å¹³å‡ã€èˆ‡ã€Œæ¨™æº–å·®ã€çš„æŒ‡æ¨™æ‰æœƒè¨ˆç®— Z åˆ†æ•¸ã€‚
        Z ç´„ä»‹æ–¼ -0.5 ï½ +0.5 è¦–ç‚ºæ¥è¿‘åœ‹éš›å¹³å‡ï¼Œâ‰¥ +1 ç‚ºæ˜é¡¯å¼·é …ï¼Œâ‰¤ -0.5 å»ºè­°åˆ—å…¥è£œå¼·é‡é»ã€‚
      </p>
    `;
    container.appendChild(table2Card);

    const tbodyIntl = table2Card.querySelector("#tbodyIntl");
    intlCompare.sort((a, b) => {
      if (a.z == null && b.z == null) return 0;
      if (a.z == null) return 1;
      if (b.z == null) return -1;
      return b.z - a.z;
    });
    intlCompare.forEach(row => {
      const zText = row.z == null ? "â€”" : row.z.toFixed(2);
      const evalTd = row.level
        ? `<span class="chip ${row.chipClass}">${row.level}</span>`
        : "â€”";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.metric}</td>
        <td>${row.latest ?? "â€”"}</td>
        <td>${row.mean ?? "â€”"}</td>
        <td>${row.sd ?? "â€”"}</td>
        <td>${zText}</td>
        <td>${evalTd}</td>
      `;
      tbodyIntl.appendChild(tr);
    });

    /***** å»ºè­°æ–‡å­— *****/

    const summaryEl = document.getElementById("coachSummary");
    const topStrengths = strengths.sort((a, b) => b.z - a.z).slice(0, 3);
    const topWeaknesses = weaknesses.sort((a, b) => a.z - b.z).slice(0, 3);

    const buildList = arr =>
      arr.length === 0
        ? "ç›®å‰å„é …ç›®å¤§è‡´æ¥è¿‘åœ‹éš›å¹³å‡ï¼Œä¸¦ç„¡ç‰¹åˆ¥çªå‡ºæˆ–æ˜é¡¯è½å¾Œçš„æŒ‡æ¨™ã€‚"
        : arr.map(item => `${item.metric}ï¼ˆZ = ${item.z.toFixed(2)}ï¼‰`).join("ã€");

    summaryEl.innerHTML = `
      <div class="coach-notes">
        <p>å¾æœ¬æ¬¡æª¢æ¸¬ä¾†çœ‹ï¼Œ<span class="highlight">${name}</span>ï¼š</p>
        <ul>
          <li>ç›¸è¼ƒæ–¼åŒåˆ†ç´šçš„åœ‹éš›æ¨£æœ¬ï¼Œä¸»è¦<strong>å„ªå‹¢</strong>æŒ‡æ¨™ç‚ºï¼š${buildList(topStrengths)}</li>
          <li>å»ºè­°å„ªå…ˆ<strong>è£œå¼·</strong>çš„é …ç›®ç‚ºï¼š${buildList(topWeaknesses)}</li>
        </ul>
        <p>ä¾ç…§æŒ‡æ¨™é¡å‹ï¼Œå¯ä»¥å°‡è¨“ç·´é‡é»å¤§è‡´åˆ†æˆä¸‰å¡Šï¼š</p>
        <ul>
          <li><strong>çˆ†ç™¼åŠ›ï¼ˆè·³èºã€å¯¦å¿ƒçƒï¼‰ï¼š</strong>å®‰æ’ç®±è·³ã€å–®è…³è·³ã€è² é‡æ·±è¹²èˆ‡è‡€æ©‹ï¼Œæ­é…æ¯é€± 2 æ¬¡æ ¸å¿ƒç©©å®šè¨“ç·´ã€‚</li>
          <li><strong>åŠ é€Ÿèˆ‡é€Ÿåº¦ï¼ˆ10mã€20mã€505 ç­‰ï¼‰ï¼š</strong>ä»¥çŸ­è·é›¢è¡åˆºã€èµ·è·‘åè¦†ç·´ç¿’èˆ‡å¡è·‘ï¼Œæå‡å•Ÿå‹•èˆ‡åŠ é€Ÿèƒ½åŠ›ã€‚</li>
          <li><strong>æ•æ·èˆ‡è®Šå‘ï¼ˆ505ã€èœ˜è››è·‘ç­‰ï¼‰ï¼š</strong>åŠ å…¥æ¨™è¨˜éŒè®Šå‘ã€åæ‡‰è…³æ­¥è¨“ç·´èˆ‡æ¨¡æ“¬å¯¦æˆ°çš„å¤šæ–¹å‘ç§»å‹•ã€‚</li>
        </ul>
        <p class="muted">
          â€» ä¸Šè¿°å»ºè­°ç‚ºä¾æ•¸æ“šè‡ªå‹•ç”Ÿæˆï¼Œå¯¦éš›è¨“ç·´è¦åŠƒä»éœ€æ•™ç·´ä¾ç…§å­©å­çš„å‚·ç—…å²ã€é«”èƒ½ç‹€æ…‹èˆ‡æ¯”è³½è¡Œç¨‹åšå€‹åˆ¥èª¿æ•´ã€‚
        </p>
      </div>
    `;

    document.getElementById("pdfBtn").disabled = false;
  }

  /******************************************************
   * 6. åŒ¯å‡º PDF
   ******************************************************/

  function downloadPdf() {
    const select = document.getElementById("playerSelect");
    const name = select.value || "report";
    const element = document.getElementById("reportPage");

    const opt = {
      margin: [10, 10, 10, 10],
      filename: `${name}-é«”èƒ½æª¢æ¸¬å ±å‘Š.pdf`,
      image: { type: "jpeg", quality: 0.96 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
    };

    html2pdf().from(element).set(opt).save();
  }

  /******************************************************
   * 7. ç¶å®šæŒ‰éˆ•
   ******************************************************/

  document.getElementById("reloadBtn").addEventListener("click", reloadAll);
  document.getElementById("loadReportBtn").addEventListener("click", () => {
    const name = document.getElementById("playerSelect").value;
    if (!name) return;
    buildReportFor(name);
  });
  document.getElementById("pdfBtn").addEventListener("click", downloadPdf);

  // å¦‚æœä½ æƒ³ä¸€é€²é é¢å°±è‡ªå‹•è¼‰å…¥è³‡æ–™ï¼Œå¯ä»¥è§£é™¤ä¸‹åˆ—è¨»è§£ï¼š
  // reloadAll();
</script>
</body>
</html>
